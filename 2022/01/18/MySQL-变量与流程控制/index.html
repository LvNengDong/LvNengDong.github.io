<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta name="description" content="1 变量在 MySQL 数据库的存储过程和存储函数中，可以使用变量来存储查询或计算的中间结果数据，或者输出最终的结果数据到变量中。 在 MySQL 数据库中，变量分为系统变量以及用户自定义变量。 1.1 系统变量1.1.1 系统变量分类变量由系统而不是用户定义，属于服务器层面。启动 MySQL 服务，生成 MySQL 服务实例期间，MySQL 服务器内存中的系统变量将被赋值。 这些系统变量定义了当">
<meta property="og:type" content="article">
<meta property="og:title" content="MySQL-变量与流程控制">
<meta property="og:url" content="http://example.com/2022/01/18/MySQL-%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="1 变量在 MySQL 数据库的存储过程和存储函数中，可以使用变量来存储查询或计算的中间结果数据，或者输出最终的结果数据到变量中。 在 MySQL 数据库中，变量分为系统变量以及用户自定义变量。 1.1 系统变量1.1.1 系统变量分类变量由系统而不是用户定义，属于服务器层面。启动 MySQL 服务，生成 MySQL 服务实例期间，MySQL 服务器内存中的系统变量将被赋值。 这些系统变量定义了当">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/2022/01/18/MySQL-%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/MySQL-%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/image-20220118134321274.png">
<meta property="article:published_time" content="2022-01-18T05:36:19.000Z">
<meta property="article:modified_time" content="2022-04-06T03:22:57.480Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/2022/01/18/MySQL-%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/MySQL-%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/image-20220118134321274.png">


<link rel="canonical" href="http://example.com/2022/01/18/MySQL-%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":false,"isPost":true,"lang":"en","comments":true,"permalink":"http://example.com/2022/01/18/MySQL-%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/","path":"2022/01/18/MySQL-变量与流程控制/","title":"MySQL-变量与流程控制"}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>MySQL-变量与流程控制 | Hexo</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <p class="site-title">Hexo</p>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-%E5%8F%98%E9%87%8F"><span class="nav-number">1.</span> <span class="nav-text">1 变量</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-1-%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F"><span class="nav-number">1.1.</span> <span class="nav-text">1.1 系统变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-1-%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F%E5%88%86%E7%B1%BB"><span class="nav-number">1.1.1.</span> <span class="nav-text">1.1.1 系统变量分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-1-2-%E6%9F%A5%E7%9C%8B%E7%B3%BB%E7%BB%9F%E5%8F%98%E9%87%8F"><span class="nav-number">1.1.2.</span> <span class="nav-text">1.1.2 查看系统变量</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#1-2-%E7%94%A8%E6%88%B7%E8%87%AA%E5%AE%9A%E4%B9%89%E5%8F%98%E9%87%8F"><span class="nav-number">1.2.</span> <span class="nav-text">1.2 用户自定义变量</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-1-%E7%94%A8%E6%88%B7%E5%8F%98%E9%87%8F%E5%88%86%E7%B1%BB"><span class="nav-number">1.2.1.</span> <span class="nav-text">1.2.1 用户变量分类</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-2-%E4%BC%9A%E8%AF%9D%E7%94%A8%E6%88%B7%E5%8F%98%E9%87%8F"><span class="nav-number">1.2.2.</span> <span class="nav-text">1.2.2 会话用户变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-3-%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F"><span class="nav-number">1.2.3.</span> <span class="nav-text">1.2.3 局部变量</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#1-2-4-%E5%AF%B9%E6%AF%94%E4%BC%9A%E8%AF%9D%E7%94%A8%E6%88%B7%E5%8F%98%E9%87%8F%E4%B8%8E%E5%B1%80%E9%83%A8%E5%8F%98%E9%87%8F"><span class="nav-number">1.2.4.</span> <span class="nav-text">1.2.4    对比会话用户变量与局部变量</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-%E5%AE%9A%E4%B9%89%E6%9D%A1%E4%BB%B6%E4%B8%8E%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F"><span class="nav-number">2.</span> <span class="nav-text">2 定义条件与处理程序</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#2-1-%E6%A1%88%E4%BE%8B%E5%88%86%E6%9E%90"><span class="nav-number">2.1.</span> <span class="nav-text">2.1 案例分析</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-2-%E5%AE%9A%E4%B9%89%E6%9D%A1%E4%BB%B6"><span class="nav-number">2.2.</span> <span class="nav-text">2.2 定义条件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-3-%E5%AE%9A%E4%B9%89%E5%A4%84%E7%90%86%E7%A8%8B%E5%BA%8F"><span class="nav-number">2.3.</span> <span class="nav-text">2.3 定义处理程序</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-4-%E6%A1%88%E4%BE%8B%E8%A7%A3%E5%86%B3"><span class="nav-number">2.4.</span> <span class="nav-text">2.4    案例解决</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6"><span class="nav-number">3.</span> <span class="nav-text">3 流程控制</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#3-1-%E5%88%86%E6%94%AF%E7%BB%93%E6%9E%84%E4%B9%8BIF"><span class="nav-number">3.1.</span> <span class="nav-text">3.1 分支结构之IF</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-2-%E5%88%86%E6%94%AF%E7%BB%93%E6%9E%84%E4%B9%8BCASE"><span class="nav-number">3.2.</span> <span class="nav-text">3.2 分支结构之CASE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-3-%E5%BE%AA%E7%8E%AF%E7%BB%93%E6%9E%84%E4%B9%8BLOOP"><span class="nav-number">3.3.</span> <span class="nav-text">3.3 循环结构之LOOP</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-4-%E5%BE%AA%E7%8E%AF%E7%BB%93%E6%9E%84%E4%B9%8BWHILE"><span class="nav-number">3.4.</span> <span class="nav-text">3.4 循环结构之WHILE</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-5-%E5%BE%AA%E7%8E%AF%E7%BB%93%E6%9E%84%E4%B9%8BREPEAT"><span class="nav-number">3.5.</span> <span class="nav-text">3.5 循环结构之REPEAT</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-6-%E8%B7%B3%E8%BD%AC%E8%AF%AD%E5%8F%A5%E4%B9%8BLEAVE%E8%AF%AD%E5%8F%A5"><span class="nav-number">3.6.</span> <span class="nav-text">3.6 跳转语句之LEAVE语句</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-7-%E8%B7%B3%E8%BD%AC%E8%AF%AD%E5%8F%A5%E4%B9%8BITERATE%E8%AF%AD%E5%8F%A5"><span class="nav-number">3.7.</span> <span class="nav-text">3.7 跳转语句之ITERATE语句</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%B8%B8%E8%A7%81%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0%E4%B8%8E%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">4.</span> <span class="nav-text">常见存储函数与存储过程</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0"><span class="nav-number">4.1.</span> <span class="nav-text">存储函数</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B"><span class="nav-number">4.2.</span> <span class="nav-text">存储过程</span></a></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">224</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">61</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">1</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/18/MySQL-%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="MySQL-变量与流程控制 | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          MySQL-变量与流程控制
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-18 13:36:19" itemprop="dateCreated datePublished" datetime="2022-01-18T13:36:19+08:00">2022-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-04-06 11:22:57" itemprop="dateModified" datetime="2022-04-06T11:22:57+08:00">2022-04-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySql/" itemprop="url" rel="index"><span itemprop="name">MySql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h1 id="1-变量"><a href="#1-变量" class="headerlink" title="1 变量"></a>1 变量</h1><p>在 MySQL 数据库的存储过程和存储函数中，可以使用变量来存储查询或计算的中间结果数据，或者输出最终的结果数据到变量中。</p>
<p>在 MySQL 数据库中，变量分为<code>系统变量</code>以及<code>用户自定义变量</code>。</p>
<h2 id="1-1-系统变量"><a href="#1-1-系统变量" class="headerlink" title="1.1 系统变量"></a>1.1 系统变量</h2><h3 id="1-1-1-系统变量分类"><a href="#1-1-1-系统变量分类" class="headerlink" title="1.1.1 系统变量分类"></a>1.1.1 系统变量分类</h3><p>变量由系统而不是用户定义，属于服务器层面。启动 MySQL 服务，生成 MySQL 服务实例期间，MySQL 服务器内存中的系统变量将被赋值。</p>
<p>这些系统变量定义了当前 MySQL 服务实例的属性、特征。这些系统变量的值要么是<code>编译 MySQL 时参数</code>的默认值，要么是<code>配置文件</code>（例如 my.ini 等）中的参数值。大家可以通过网址 <code>https://dev.mysql.com/doc/refman/8.0/en/server-systemvariables.html</code> 查看 MySQL 文档的系统变量。</p>
<p>系统变量又可细分为<strong>全局系统变量</strong>（需要添加 <code>global</code> 关键字）和<strong>会话系统变量</strong>（需要添加 <code>session</code> 关键字）。有时也把全局系统变量简称为全局变量，有时也把会话系统变量称为 local 变量。<strong>如果不写，默认会话级别</strong>。静态变量（在 MySQL 服务实例运行期间它们的值不能使用 set 动态修改）属于特殊的全局系统变量。</p>
<p>每一个 MySQL 客户端成功连接 MySQL 服务器后，都会产生与之对应的会话。会话期间，MySQL 服务实例会在 MySQL 服务器内存中生成与该会话对应的会话系统变量，这些会话系统变量的初始值是全局系统变量值的复制。如下图：</p>
<img src="MySQL-%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/image-20220118134321274.png" alt="image-20220118134321274" style="zoom:67%;" />

<ul>
<li>  全局系统变量针对于所有会话（连接）有效，但<strong>不能跨重启</strong>。</li>
<li>  会话系统变量仅针对于当前会话（连接）有效。会话期间，当前会话对某个会话系统变量值的修改，不会影响其它会话同名会话系统变量的值。</li>
<li>  但是会话1对某个全局系统变量值的修改会导致会话2中同一个全局系统变量值的修改。</li>
</ul>
<p>在 MySQL 中有些系统变量只能是全局的，例如 max_connections 用于限制服务器的最大连接数；有些系统变量作用域既可以是全局又可以是会话，例如 character_set_client 用于设置客户端的字符集；有些系统变量的作用域只能是当前会话，例如 pseudo_thread_id 用于标记当前会话的 MySQL 连接 ID。</p>
<hr>
<h3 id="1-1-2-查看系统变量"><a href="#1-1-2-查看系统变量" class="headerlink" title="1.1.2 查看系统变量"></a>1.1.2 查看系统变量</h3><p><strong>查看所有或部分系统变量</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 查看所有全局变量</span><br><span class="line">SHOW GLOBAL VARIABLES;</span><br><span class="line"></span><br><span class="line"># 查看所有会话变量</span><br><span class="line">SHOW SESSION VARIABLES;</span><br><span class="line"># 或（默认会话级别）</span><br><span class="line">SHOW VARIABLES;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查看满足条件的部分系统变量。</span><br><span class="line">SHOW GLOBAL VARIABLES LIKE &#x27;%标识符%&#x27;;</span><br><span class="line"></span><br><span class="line"># 查看满足条件的部分会话变量</span><br><span class="line">SHOW SESSION VARIABLES LIKE &#x27;%标识符%&#x27;;</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW GLOBAL VARIABLES LIKE &#x27;admin_%&#x27;;</span><br></pre></td></tr></table></figure>





<p><strong>查看指定系统变量</strong></p>
<p>作为 MySQL 编码规范，MySQL 中的系统变量以<code>两个“@”</code> 开头，其中 <code>“@@global”</code> 仅用于标记全局系统变量， <code>“@@session”</code> 仅用于标记会话系统变量。如果不加英文关键字， <code>“@@”</code> 首先会被标记会话系统变量，如果会话系统变量不存在，则标记全局系统变量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#查看指定的系统变量的值</span><br><span class="line">SELECT @@global.变量名;</span><br><span class="line"></span><br><span class="line">#查看指定的会话变量的值</span><br><span class="line">SELECT @@session.变量名;</span><br><span class="line"></span><br><span class="line">#或者（首先去会话系统变量中查找，如果不存在，再去全局系统变量中查找）</span><br><span class="line">SELECT @@变量名;</span><br></pre></td></tr></table></figure>





<p><strong>修改系统变量的值</strong></p>
<p>有些时候，数据库管理员需要修改系统变量的默认值，以便修改当前会话或者 MySQL 服务实例的属性、特征。具体方法如下：</p>
<ul>
<li>  方式1：修改 MySQL <code>配置文件</code>，继而修改 MySQL 系统变量的值（该方法需要重启 MySQL 服务）</li>
<li>  方式2：在 MySQL 服务运行期间，使用 <code>“set” 命令</code>重新设置系统变量的值</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 为某个系统变量赋值</span><br><span class="line">#方式1：</span><br><span class="line">SET @@global.变量名=变量值;</span><br><span class="line">#方式2：</span><br><span class="line">SET GLOBAL 变量名=变量值;</span><br><span class="line"></span><br><span class="line">#为某个会话变量赋值</span><br><span class="line">#方式1：</span><br><span class="line">SET @@session.变量名=变量值;</span><br><span class="line">#方式2：</span><br><span class="line">SET SESSION 变量名=变量值;</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT @@global.autocommit;</span><br><span class="line">SET GLOBAL autocommit=0;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT @@session.tx_isolation;</span><br><span class="line">SET @@session.tx_isolation=&#x27;read-uncommitted&#x27;;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL max_connections = 1000;</span><br><span class="line">SELECT @@global.max_connections;</span><br></pre></td></tr></table></figure>





<hr>
<h2 id="1-2-用户自定义变量"><a href="#1-2-用户自定义变量" class="headerlink" title="1.2 用户自定义变量"></a>1.2 用户自定义变量</h2><h3 id="1-2-1-用户变量分类"><a href="#1-2-1-用户变量分类" class="headerlink" title="1.2.1 用户变量分类"></a>1.2.1 用户变量分类</h3><p>用户变量是用户自己定义的，根据作用范围不同，又分为<strong>会话用户变量</strong>和<strong>局部变量</strong>。MySQL 中的会话用户变量以<code>一个“@”</code> 开头，局部变量不使用 @ 符号修饰。</p>
<ul>
<li>  会话用户变量：作用域和会话变量一样，只对当前连接会话有效。</li>
<li>  局部变量：只在 BEGIN…END 语句块中有效。局部变量只能在存储过程和存储函数中使用。</li>
</ul>
<h3 id="1-2-2-会话用户变量"><a href="#1-2-2-会话用户变量" class="headerlink" title="1.2.2 会话用户变量"></a>1.2.2 会话用户变量</h3><ul>
<li>  <strong>变量的定义</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 方式1：“=” 或 “:=”</span><br><span class="line">SET @用户变量 = 值;</span><br><span class="line">SET @用户变量 := 值;</span><br><span class="line"></span><br><span class="line"># 方式2：“:=” 或 INTO 关键字</span><br><span class="line">SELECT @用户变量 := 表达式 [FROM 等子句];</span><br><span class="line">SELECT 表达式 INTO @用户变量 [FROM 等子句];</span><br></pre></td></tr></table></figure>

<ul>
<li>  查看用户变量的值 （查看、比较、运算等）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT @用户变量</span><br></pre></td></tr></table></figure>

<ul>
<li>  举例</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET @a = 1;</span><br><span class="line">SELECT @a;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT @num := COUNT(*) FROM employees;</span><br><span class="line">SELECT @num;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT AVG(salary) INTO @avgsalary FROM employees;</span><br><span class="line"></span><br><span class="line">SELECT @avgsalary;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT @big; # 查看某个未声明的变量时，将得到NULL值</span><br></pre></td></tr></table></figure>



<hr>
<h3 id="1-2-3-局部变量"><a href="#1-2-3-局部变量" class="headerlink" title="1.2.3 局部变量"></a>1.2.3 局部变量</h3><p><strong>定义：</strong>可以使用 <code>DECLARE</code> 关键字定义一个局部变量</p>
<p><strong>作用域：</strong>仅仅在定义它的 BEGIN … END 中有效</p>
<p><strong>位置：</strong>只能放在 BEGIN … END 中，而且必须放在第一句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">BEGIN</span><br><span class="line">    # 声明局部变量</span><br><span class="line">    DECLARE 变量名1 变量数据类型 [DEFAULT 变量默认值];</span><br><span class="line">    DECLARE 变量名2,变量名3,... 变量数据类型 [DEFAULT 变量默认值];</span><br><span class="line">    </span><br><span class="line">    # 为局部变量赋值</span><br><span class="line">    SET 变量名1 = 值; # 方式一：赋固定值</span><br><span class="line">    SELECT 值 INTO 变量名2 [FROM 子句]; # 方式二：查询赋值</span><br><span class="line">    </span><br><span class="line">    # 查看局部变量的值</span><br><span class="line">    SELECT 变量1,变量2,变量3;</span><br><span class="line">END</span><br></pre></td></tr></table></figure>



<ol>
<li><p><strong>定义变量</strong></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE 变量名 类型 [default 值]; # 如果没有DEFAULT子句，初始值为NULL</span><br></pre></td></tr></table></figure>

<p> 举例：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE　myparam　INT　DEFAULT 100;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>变量赋值</strong></p>
<p> 方式1：一般用于赋简单的值</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET 变量名=值;</span><br><span class="line">SET 变量名:=值;</span><br></pre></td></tr></table></figure>

<p> 方式2：一般用于赋表中的字段值（先查再给）</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT 字段名或表达式 INTO 变量名 FROM 表;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>使用变量</strong>（查看、比较、运算等）</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT 局部变量名;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><strong>举例1：</strong>声明局部变量，并分别赋值为 employees 表中 employee_id 为 102 的 last_name 和 salary</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE set_value()</span><br><span class="line">BEGIN</span><br><span class="line">	# 声明局部变量</span><br><span class="line">	DECLARE emp_name VARCHAR(25);</span><br><span class="line">	DECLARE sal DOUBLE(10,2);</span><br><span class="line"></span><br><span class="line">	# 为局部变量赋值</span><br><span class="line">	SELECT last_name, salary INTO emp_name, sal</span><br><span class="line">	FROM employees</span><br><span class="line">	WHERE employee_id = 102;</span><br><span class="line">	</span><br><span class="line">	# 查看赋值的结果（局部变量只在当前存储过程的上下文中有效）</span><br><span class="line">	SELECT emp_name, sal;</span><br><span class="line">END $</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>


<p><strong>举例2：</strong>声明两个变量，求和并打印 （分别使用会话用户变量、局部变量的方式实现）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 方式1：使用用户变量</span><br><span class="line">SET @a := 1;</span><br><span class="line">SET @b := 2;</span><br><span class="line">SET @sum = @a + @b;</span><br><span class="line">SELECT @sum;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 方式2：使用局部变量</span><br><span class="line">DELIMITER //</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE add_value()</span><br><span class="line">BEGIN</span><br><span class="line">    # 局部变量</span><br><span class="line">    DECLARE m INT DEFAULT 1;</span><br><span class="line">    DECLARE n INT DEFAULT 3;</span><br><span class="line">    DECLARE SUM INT;</span><br><span class="line">    </span><br><span class="line">SET SUM = m+n;</span><br><span class="line">    </span><br><span class="line">SELECT SUM;</span><br><span class="line">END //</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>


<p><strong>举例3：</strong>创建存储过程 “different_salary” 查询某员工和他领导的薪资差距，并用 IN 参数 emp_id 接收员工 id ，用 OUT 参数 dif_salary 输出薪资差距结果。</p>
<ul>
<li>  不使用局部变量的写法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE different_salary(IN emp_id INT, OUT dif_salary DOUBLE)</span><br><span class="line">BEGIN</span><br><span class="line">	SELECT (employees.salary - tmp.salary) INTO dif_salary </span><br><span class="line">	FROM employees, ( SELECT manager_id, salary FROM employees WHERE employee_id = emp_id ) AS tmp</span><br><span class="line">	WHERE employee_id = tmp.manager_id;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>  调用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 调用</span><br><span class="line">SET @emp_id = 102;</span><br><span class="line">CALL different_salary(@emp_id,@diff_sal);</span><br><span class="line"># 查看</span><br><span class="line">SELECT @diff_sal;</span><br></pre></td></tr></table></figure>

<ul>
<li>  使用局部变量的写法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE different_salary(IN emp_id INT, OUT dif_salary DOUBLE)</span><br><span class="line">BEGIN</span><br><span class="line">	# 声明局部变量</span><br><span class="line">	DECLARE emp_sal, mgr_sal DOUBLE DEFAULT 0.0;</span><br><span class="line">	DECLARE mgr_id INT;</span><br><span class="line">	</span><br><span class="line">	# 员工工资</span><br><span class="line">	SELECT salary INTO emp_sal FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	# 领导id</span><br><span class="line">	SELECT manager_id INTO mgr_id FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	# 领导工资</span><br><span class="line">	SELECT salary INTO mgr_sal FROM employees WHERE employee_id = mgr_id;</span><br><span class="line">	# 工资差</span><br><span class="line">	SET dif_salary = mgr_sal - emp_sal;</span><br><span class="line">END //</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>





<hr>
<h3 id="1-2-4-对比会话用户变量与局部变量"><a href="#1-2-4-对比会话用户变量与局部变量" class="headerlink" title="1.2.4    对比会话用户变量与局部变量"></a>1.2.4    对比会话用户变量与局部变量</h3><table>
<thead>
<tr>
<th></th>
<th>作用域</th>
<th>定义位置</th>
<th>语法</th>
</tr>
</thead>
<tbody><tr>
<td>会话用户变量</td>
<td>当前会话</td>
<td>会话的任何地方</td>
<td>加@符号，不用指定类型</td>
</tr>
<tr>
<td>局部变量</td>
<td>定义它的 BEGIN END 中</td>
<td>BEGIN END的第一句话</td>
<td>一般不用加@,需要指定类型</td>
</tr>
</tbody></table>
<hr>
<h1 id="2-定义条件与处理程序"><a href="#2-定义条件与处理程序" class="headerlink" title="2 定义条件与处理程序"></a>2 定义条件与处理程序</h1><p>定义条件与处理机制就是针对程序中可能出现的可预见的错误采取的解决措施。</p>
<p><code>定义条件</code>指事先定义程序执行过程中可能遇到的问题，<code>处理程序</code>则定义了在遇到问题时应当采取的处理方式，并且保证存储过程或函数在遇到警告或错误时能继续执行。类似于 Java 语言中的 try…catch 代码块。这样可以增强存储程序处理问题的能力，避免程序异常停止运行。</p>
<p><strong>说明：</strong>定义条件和处理程序在存储过程、存储函数中都是支持的。</p>
<hr>
<h2 id="2-1-案例分析"><a href="#2-1-案例分析" class="headerlink" title="2.1 案例分析"></a>2.1 案例分析</h2><p><strong>案例分析：</strong>创建一个名为 “UpdateDataNoCondition” 的存储过程。代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE UpdateDataNoCondition()</span><br><span class="line">BEGIN</span><br><span class="line">    SET @x = 1;</span><br><span class="line">    # “email” cannot be null</span><br><span class="line">    UPDATE employees SET email = NULL WHERE last_name = &#x27;Abel&#x27;;</span><br><span class="line">    SET @x = 2;</span><br><span class="line">    UPDATE employees SET email = &#x27;aabbel&#x27; WHERE last_name = &#x27;Abel&#x27;;</span><br><span class="line">    SET @x = 3;</span><br><span class="line">END $</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>



<p>调用存储过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CALL UpdateDataNoCondition();</span><br><span class="line">ERROR 1048 (23000): Column &#x27;email&#x27; cannot be null</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT @x;</span><br><span class="line">+------+</span><br><span class="line">| @x |</span><br><span class="line">+------+</span><br><span class="line">| 1 |</span><br><span class="line">+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>可以看到，此时 @x 变量的值为1。结合创建存储过程的 SQL 语句代码可以得出：在存储过程中未定义条件和处理程序，且当存储过程中执行的 SQL 语句报错时，MySQL 数据库会抛出错误，并退出当前 SQL 逻辑，不再向下继续执行。</p>
<hr>
<h2 id="2-2-定义条件"><a href="#2-2-定义条件" class="headerlink" title="2.2 定义条件"></a>2.2 定义条件</h2><p>定义条件就是给 MySQL 中的错误码命名，这有助于存储的程序代码更清晰。它将一个<code>错误名字</code>和<code>指定的错误条件</code>关联起来。这个名字可以随后被用在定义处理程序的 <code>DECLARE HANDLER</code> 语句中。</p>
<p>定义条件使用 DECLARE 语句，语法格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE 错误名称 CONDITION FOR 错误码（或错误条件）</span><br></pre></td></tr></table></figure>

<p>错误码的说明：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1048 (23000): ......</span><br></pre></td></tr></table></figure>

<ul>
<li><code>MySQL_error_code</code> 和 <code>sqlstate_value</code> 都可以表示 MySQL 的错误。<ul>
<li>  MySQL_error_code 是数值类型错误代码。</li>
<li>  sqlstate_value 是长度为5的字符串类型错误代码。</li>
</ul>
</li>
<li>  例如，在 ERROR 1418 (HY000) 中，1418 是 MySQL_error_code，’HY000’ 是 sqlstate_value。</li>
<li>  例如，在 ERROR 1142（42000）中，1142 是 MySQL_error_code，’42000’ 是 sqlstate_value。</li>
</ul>
<p><strong>举例1：</strong>自定义 “Field_Not_Be_NULL” 错误名，与 MySQL 中违反非空约束的错误类型是 “ERROR 1048 (23000)” 对应。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 使用 MySQL_error_code</span><br><span class="line">DECLARE Field_Not_Be_NULL CONDITION FOR 1048;</span><br><span class="line"></span><br><span class="line"># 使用 sqlstate_value</span><br><span class="line">DECLARE Field_Not_Be_NULL CONDITION FOR SQLSTATE &#x27;23000&#x27;;</span><br></pre></td></tr></table></figure>



<p><strong>举例2：</strong>定义 “ERROR 1148(42000)” 错误，名称为 command_not_allowed。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 使用MySQL_error_code</span><br><span class="line">DECLARE command_not_allowed CONDITION FOR 1148;</span><br><span class="line"></span><br><span class="line"># 使用sqlstate_value</span><br><span class="line">DECLARE command_not_allowed CONDITION FOR SQLSTATE &#x27;42000&#x27;;</span><br></pre></td></tr></table></figure>





<hr>
<h2 id="2-3-定义处理程序"><a href="#2-3-定义处理程序" class="headerlink" title="2.3 定义处理程序"></a>2.3 定义处理程序</h2><p>可以为 SQL 执行过程中发生的某种类型的错误定义特殊的处理程序。定义处理程序时，使用 DECLARE 语句的语法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE 处理方式 HANDLER FOR 错误类型 处理语句</span><br></pre></td></tr></table></figure>



<ul>
<li><strong>处理方式：</strong>处理方式有3个取值：CONTINUE、EXIT、UNDO。<ul>
<li>  <code>CONTINUE</code> ：表示遇到错误不处理，继续执行。</li>
<li>  <code>EXIT</code> ：表示遇到错误马上退出程序（默认）。</li>
<li>  <code>UNDO</code> ：表示遇到错误后撤回之前的操作（回滚）。MySQL中暂时不支持这样的操作。</li>
</ul>
</li>
<li><strong>错误类型</strong>（即条件）可以有如下取值：<ul>
<li>  <code>SQLSTATE &#39;字符串错误码&#39;</code> ：表示长度为5的 sqlstate_value 类型的错误代码；</li>
<li>  <code>MySQL_error_code</code> ：匹配数值类型错误代码；</li>
<li>  <code>错误名称</code> ：表示 DECLARE … CONDITION 定义的错误条件名称。</li>
<li>  <code>SQLWARNING</code> ：匹配所有以 01 开头的 SQLSTATE 错误代码；</li>
<li>  <code>NOT FOUND</code> ：匹配所有以 02 开头的 SQLSTATE 错误代码；</li>
<li>  <code>SQLEXCEPTION</code> ：匹配所有没有被 SQLWARNING 或 NOT FOUND 捕获的 SQLSTATE 错误代码；</li>
</ul>
</li>
<li>  <strong>处理语句：</strong>如果出现上述条件之一，则采用对应的处理方式，并执行指定的处理语句。语句可以是像 <code>SET 变量 = 值</code> 这样的简单语句，也可以是使用 <code>BEGIN ... END</code> 编写的复合语句。</li>
</ul>
<p>定义处理程序的几种方式，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#方法1：捕获sqlstate_value</span><br><span class="line">DECLARE CONTINUE HANDLER FOR SQLSTATE &#x27;42S02&#x27; SET @info = &#x27;NO_SUCH_TABLE&#x27;;</span><br><span class="line"></span><br><span class="line">#方法2：捕获mysql_error_value</span><br><span class="line">DECLARE CONTINUE HANDLER FOR 1146 SET @info = &#x27;NO_SUCH_TABLE&#x27;;</span><br><span class="line"></span><br><span class="line">#方法3：先定义条件，再调用</span><br><span class="line">DECLARE no_such_table CONDITION FOR 1146;</span><br><span class="line">DECLARE CONTINUE HANDLER FOR NO_SUCH_TABLE SET @info = &#x27;NO_SUCH_TABLE&#x27;;</span><br><span class="line"></span><br><span class="line">#方法4：使用SQLWARNING</span><br><span class="line">DECLARE EXIT HANDLER FOR SQLWARNING SET @info = &#x27;ERROR&#x27;;</span><br><span class="line"></span><br><span class="line">#方法5：使用NOT FOUND</span><br><span class="line">DECLARE EXIT HANDLER FOR NOT FOUND SET @info = &#x27;NO_SUCH_TABLE&#x27;;</span><br><span class="line"></span><br><span class="line">#方法6：使用SQLEXCEPTION</span><br><span class="line">DECLARE EXIT HANDLER FOR SQLEXCEPTION SET @info = &#x27;ERROR&#x27;;</span><br></pre></td></tr></table></figure>



<hr>
<h2 id="2-4-案例解决"><a href="#2-4-案例解决" class="headerlink" title="2.4    案例解决"></a>2.4    案例解决</h2><p>在存储过程中，定义处理程序，捕获 sqlstate_value 值，当遇到 MySQL_error_code 值为 1048 时，执行 CONTINUE 操作，并且将 @flag 的值设置为 -1。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE UpdateDataNoCondition()</span><br><span class="line">BEGIN</span><br><span class="line">    # 声明处理程序</span><br><span class="line">    DECLARE CONTINUE HANDLER FOR 1048 SET @flag = -1;</span><br><span class="line">    </span><br><span class="line">    SET @x = 1;</span><br><span class="line">    UPDATE employees SET email = NULL WHERE last_name = &#x27;Abel&#x27;;</span><br><span class="line">    SET @x = 2;</span><br><span class="line">    UPDATE employees SET email = &#x27;aabbel&#x27; WHERE last_name = &#x27;Abel&#x27;;</span><br><span class="line">    SET @x = 3;</span><br><span class="line">END $</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>调用过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 调用</span><br><span class="line">mysql&gt; CALL UpdateDataWithCondition();</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"># 查询 @flag 的值，若为 -1 则证明存储过程执行出错；</span><br><span class="line"># 查询 @x 的值，若为 3 则证明程序出错时不会中止而是继续执行</span><br><span class="line">mysql&gt; SELECT @x,@proc_value;</span><br><span class="line">+------+-------------+</span><br><span class="line">| @x | @flag |</span><br><span class="line">+------+-------------+</span><br><span class="line">| 3 | -1 |</span><br><span class="line">+------+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>





<p><strong>举例：</strong>创建一个名称为 “InsertDataWithCondition” 的存储过程，代码如下。</p>
<p>在存储过程中，定义处理程序，捕获 sqlstate_value 值，当遇到 sqlstate_value 值为 23000 时，执行 EXIT 操作，并且将 @proc_value 的值设置为 -1。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 准备工作：给 department_name 字段加唯一性约束</span><br><span class="line">ALTER TABLE departments</span><br><span class="line">ADD CONSTRAINT uk_dept_name UNIQUE(department_name);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE InsertDataWithCondition()</span><br><span class="line">BEGIN</span><br><span class="line">	# 定义条件（给错误码起一个好听的名字）</span><br><span class="line">    DECLARE duplicate_entry CONDITION FOR SQLSTATE &#x27;23000&#x27; ;</span><br><span class="line">    # 处理程序</span><br><span class="line">    DECLARE EXIT HANDLER FOR duplicate_entry SET @proc_value = -1;</span><br><span class="line">    </span><br><span class="line">    SET @x = 1;</span><br><span class="line">    INSERT INTO departments(department_name) VALUES(&#x27;测试&#x27;);</span><br><span class="line">    SET @x = 2;</span><br><span class="line">    INSERT INTO departments(department_name) VALUES(&#x27;测试&#x27;);</span><br><span class="line">    SET @x = 3;</span><br><span class="line">END //</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>调用存储过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CALL InsertDataWithCondition();</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT @x,@proc_value;</span><br><span class="line">+------+-------------+</span><br><span class="line">| @x | @proc_value |</span><br><span class="line">+------+-------------+</span><br><span class="line">| 2 | -1 |</span><br><span class="line">+------+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>





<hr>
<h1 id="3-流程控制"><a href="#3-流程控制" class="headerlink" title="3 流程控制"></a>3 流程控制</h1><p>解决复杂问题不可能通过一个 SQL 语句完成，我们需要执行多个 SQL 操作。流程控制语句的作用就是控制存储过程中 SQL 语句的执行顺序，是我们完成复杂操作必不可少的一部分。只要是执行的程序，流程就分为三大类：</p>
<ul>
<li>  <code>顺序结构</code>：程序从上往下依次执行</li>
<li>  <code>分支结构</code>：程序按条件进行选择执行，从两条或多条路径中选择一条执行</li>
<li>  <code>循环结构</code>：程序满足一定条件下，重复执行一组语句</li>
</ul>
<p>针对于 MySQL 的流程控制语句主要有 3 类。<strong>注意：只能用于存储程序。</strong></p>
<ul>
<li>  <code>条件判断语句</code>：IF 语句和 CASE 语句</li>
<li>  <code>循环语句</code>：LOOP、WHILE 和 REPEAT 语句</li>
<li>  <code>跳转语句</code>：ITERATE 和 LEAVE 语句</li>
</ul>
<hr>
<h2 id="3-1-分支结构之IF"><a href="#3-1-分支结构之IF" class="headerlink" title="3.1 分支结构之IF"></a>3.1 分支结构之IF</h2><p>IF 语句的语法结构是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IF 表达式1 THEN 操作1</span><br><span class="line">[ELSEIF 表达式2 THEN 操作2]……</span><br><span class="line">[ELSE 操作N]</span><br><span class="line">END IF</span><br></pre></td></tr></table></figure>

<p>根据表达式的结果为 TRUE 或 FALSE 执行相应的语句。这里 “[]” 中的内容是可选的。</p>
<ul>
<li><p>  特点：① 不同的表达式对应不同的操作 ② 使用在 begin…end 中</p>
</li>
<li><p><strong>举例1：</strong></p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IF val IS NULL THEN </span><br><span class="line">	SELECT &#x27;val is null&#x27;;</span><br><span class="line">ELSE </span><br><span class="line">	SELECT &#x27;val is not null&#x27;;</span><br><span class="line">END IF;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>举例2：</strong>声明存储过程 “update_salary_by_eid1”，定义 IN 参数 emp_id，输入员工编号。判断该员工薪资如果低于 8000 元并且入职时间超过 5 年，就涨薪 500 元；否则就不变。</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE update_salary_by_eid1(IN emp_id INT)</span><br><span class="line">BEGIN</span><br><span class="line">	# 声明局部变量</span><br><span class="line">	DECLARE emp_salary DOUBLE;</span><br><span class="line">	DECLARE hire_year DOUBLE;</span><br><span class="line">	# 给局部变量赋值</span><br><span class="line">	SELECT salary INTO emp_salary FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	SELECT DATEDIFF(CURDATE(),hire_date)/365 INTO hire_year FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	</span><br><span class="line">	# 条件语句判断</span><br><span class="line">	IF emp_salary &lt; 8000 AND hire_year &gt; 5</span><br><span class="line">		THEN UPDATE employees SET salary = salary + 500 WHERE employee_id = emp_id;</span><br><span class="line">	END IF;</span><br><span class="line">END $</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

</li>
<li><p><strong>举例3：</strong>声明存储过程 “update_salary_by_eid2”，定义 IN 参数 emp_id，输入员工编号。判断该员工薪资如果低于9000元并且入职时间超过5年，就涨薪500元；否则就涨薪100元。</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE update_salary_by_eid2(IN emp_id INT)</span><br><span class="line">BEGIN</span><br><span class="line">	DECLARE emp_salary DOUBLE;</span><br><span class="line">	DECLARE hire_year DOUBLE;</span><br><span class="line">	</span><br><span class="line">	SELECT salary INTO emp_salary FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	SELECT DATEDIFF(CURDATE(),hire_date)/365 INTO hire_year FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	</span><br><span class="line">	IF emp_salary &lt; 8000 AND hire_year &gt; 5</span><br><span class="line">		THEN UPDATE employees SET salary = salary + 500 WHERE employee_id = emp_id;</span><br><span class="line">	ELSE</span><br><span class="line">		UPDATE employees SET salary = salary + 100 WHERE employee_id = emp_id;</span><br><span class="line">	END IF;</span><br><span class="line">END //</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>举例4：</strong>声明存储过程 “update_salary_by_eid3”，定义 IN 参数 emp_id，输入员工编号。判断该员工薪资如果低于9000元，就更新薪资为9000元；薪资如果大于等于9000元且低于10000的，但是奖金比例为NULL的，就更新奖金比例为0.01；其他的涨薪100元。</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE update_salary_by_eid3(IN emp_id INT)</span><br><span class="line">BEGIN</span><br><span class="line">	DECLARE emp_salary DOUBLE;</span><br><span class="line">	DECLARE bonus DECIMAL(3,2);</span><br><span class="line">	</span><br><span class="line">	SELECT salary INTO emp_salary FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	SELECT commission_pct INTO bonus FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	</span><br><span class="line">	IF emp_salary &lt; 9000</span><br><span class="line">		THEN UPDATE employees SET salary = 9000 WHERE employee_id = emp_id;</span><br><span class="line">	ELSEIF emp_salary &lt; 10000 AND bonus IS NULL</span><br><span class="line">		THEN UPDATE employees SET commission_pct = 0.01 WHERE employee_id = emp_id;</span><br><span class="line">	ELSE</span><br><span class="line">		UPDATE employees SET salary = salary + 100 WHERE employee_id = emp_id;</span><br><span class="line">	END IF;</span><br><span class="line">END //</span><br><span class="line"> </span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="3-2-分支结构之CASE"><a href="#3-2-分支结构之CASE" class="headerlink" title="3.2 分支结构之CASE"></a>3.2 分支结构之CASE</h2><p>CASE 语句的语法结构1：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 情况一：类似于switch</span><br><span class="line">CASE 表达式</span><br><span class="line">WHEN 值1 </span><br><span class="line">	THEN 结果1或语句1(如果是语句，需要加分号)</span><br><span class="line">WHEN 值2 </span><br><span class="line">	THEN 结果2或语句2(如果是语句，需要加分号)</span><br><span class="line">...</span><br><span class="line">ELSE </span><br><span class="line">	结果n或语句n(如果是语句，需要加分号)</span><br><span class="line">END [case] # 如果是放在 begin end 中需要加上 case，如果放在 select 后面不需要</span><br></pre></td></tr></table></figure>

<p>CASE 语句的语法结构2：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 情况二：类似于多重if</span><br><span class="line">CASE</span><br><span class="line">WHEN 条件1 </span><br><span class="line">	THEN 结果1或语句1(如果是语句，需要加分号)</span><br><span class="line">WHEN 条件2 </span><br><span class="line">	THEN 结果2或语句2(如果是语句，需要加分号)</span><br><span class="line">...</span><br><span class="line">ELSE </span><br><span class="line">	结果n或语句n(如果是语句，需要加分号)</span><br><span class="line">END [case] # 如果是放在 begin end 中需要加上 case，如果放在 select 后面不需要</span><br></pre></td></tr></table></figure>

<p><strong>举例1：</strong>使用 CASE 流程控制语句的第1种格式，判断 val 值等于1、等于2，或者两者都不等。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CASE val</span><br><span class="line">	WHEN 1 </span><br><span class="line">		THEN SELECT &#x27;val is 1&#x27;;</span><br><span class="line">	WHEN 2 </span><br><span class="line">		THEN SELECT &#x27;val is 2&#x27;;</span><br><span class="line">	ELSE </span><br><span class="line">		SELECT &#x27;val is not 1 or 2&#x27;;</span><br><span class="line">END CASE;</span><br></pre></td></tr></table></figure>

<p><strong>举例2：</strong>使用 CASE 流程控制语句的第2种格式，判断 val 是否为空、小于0、大于0或者等于0。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CASE</span><br><span class="line"></span><br><span class="line">WHEN val IS NULL </span><br><span class="line">	THEN SELECT &#x27;val is null&#x27;;</span><br><span class="line">WHEN val &lt; 0 </span><br><span class="line">	THEN SELECT &#x27;val is less than 0&#x27;;</span><br><span class="line">WHEN val &gt; 0 </span><br><span class="line">	THEN SELECT &#x27;val is greater than 0&#x27;;</span><br><span class="line">ELSE </span><br><span class="line">	SELECT &#x27;val is 0&#x27;;</span><br><span class="line"></span><br><span class="line">END CASE;</span><br></pre></td></tr></table></figure>

<p><strong>举例3：</strong>声明存储过程 “update_salary_by_eid4”，定义 IN 参数 emp_id，输入员工编号。判断该员工薪资如果低于9000元，就更新薪资为9000元；薪资大于等于9000元且低于10000的，但是奖金比例为 NULL 的，就更新奖金比例为0.01；其他的涨薪100元。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE update_salary_by_eid4(IN emp_id INT)</span><br><span class="line">BEGIN</span><br><span class="line">	# 定义局部变量</span><br><span class="line">	DECLARE emp_sal DOUBLE;	# 员工薪资</span><br><span class="line">	DECLARE bonus DECIMAL(3,2); # 奖金比例</span><br><span class="line">	# 局部变量赋值</span><br><span class="line">	SELECT salary INTO emp_sal FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	SELECT commission_pct INTO bonus FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	</span><br><span class="line">	#</span><br><span class="line">	CASE</span><br><span class="line">	WHEN emp_sal &lt; 9000</span><br><span class="line">		THEN UPDATE employees SET salary=9000 WHERE employee_id = emp_id;</span><br><span class="line">	WHEN emp_sal &gt; 9000 AND emp_sal &lt; 10000 AND bonus = 0.01</span><br><span class="line">		THEN UPDATE employees SET commission_pct=0.01 WHERE employee_id = emp_id; </span><br><span class="line">	ELSE</span><br><span class="line">		UPDATE employees SET salary=salary+100 WHERE employee_id = emp_id;</span><br><span class="line">	END CASE;</span><br><span class="line">END $</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p><strong>举例4：</strong>声明存储过程 update_salary_by_eid5，定义 IN 参数 emp_id，输入员工编号。判断该员工的入职年限，如果是0年，薪资涨50；如果是1年，薪资涨100；如果是2年，薪资涨200；如果是3年，薪资涨300；如果是4年，薪资涨400；其他的涨薪500。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE update_salary_by_eid5(IN emp_id INT)</span><br><span class="line">BEGIN</span><br><span class="line">	# 声明局部变量</span><br><span class="line">	DECLARE emp_sal DOUBLE;	# 员工薪资</span><br><span class="line">	DECLARE hire_year DOUBLE; # 入职年限</span><br><span class="line">	# 局部变量赋值</span><br><span class="line">	SELECT salary INTO emp_sal FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	SELECT ROUND(DATEDIFF(CURDATE(),hire_date)/365) INTO hire_year FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	</span><br><span class="line">	#</span><br><span class="line">	CASE hire_year</span><br><span class="line">	WHEN 0 </span><br><span class="line">		THEN UPDATE employees SET salary=salary+50 WHERE employee_id = emp_id;</span><br><span class="line">	WHEN 1 </span><br><span class="line">		THEN UPDATE employees SET salary=salary+100 WHERE employee_id = emp_id;</span><br><span class="line">	WHEN 2 </span><br><span class="line">		THEN UPDATE employees SET salary=salary+200 WHERE employee_id = emp_id;</span><br><span class="line">	WHEN 3 </span><br><span class="line">		THEN UPDATE employees SET salary=salary+300 WHERE employee_id = emp_id;</span><br><span class="line">	WHEN 4 </span><br><span class="line">		THEN UPDATE employees SET salary=salary+400 WHERE employee_id = emp_id;</span><br><span class="line">	ELSE </span><br><span class="line">		UPDATE employees SET salary=salary+500 WHERE employee_id = emp_id;</span><br><span class="line">	END CASE;</span><br><span class="line">END //</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>



<hr>
<h2 id="3-3-循环结构之LOOP"><a href="#3-3-循环结构之LOOP" class="headerlink" title="3.3 循环结构之LOOP"></a>3.3 循环结构之LOOP</h2><p><code>LOOP</code> 循环语句用来重复执行某些语句。LOOP 内的语句一直重复执行直到循环被退出（使用 <code>LEAVE</code> 子句），跳出循环过程。</p>
<p>LOOP 语句的基本格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[loop_label:] LOOP</span><br><span class="line">	循环执行的语句</span><br><span class="line">END LOOP [loop_label]</span><br></pre></td></tr></table></figure>

<p>其中，loop_label 表示 LOOP 语句的标注名称，该参数可以省略。</p>
<p><strong>举例1：</strong>使用 LOOP 语句进行循环操作，id 值小于10时将重复执行循环过程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DECLARE id INT DEFAULT 0;</span><br><span class="line">add_loop:LOOP</span><br><span class="line">SET id = id +1;</span><br><span class="line">IF id &gt;= 10 THEN LEAVE add_loop;</span><br><span class="line">END IF;</span><br><span class="line">END LOOP add_loop;</span><br><span class="line"></span><br><span class="line">DELIMITER $</span><br><span class="line">CREATE PROCEDURE test_loop1()</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE id INT DEFAULT 0;</span><br><span class="line">    add_loop: LOOP</span><br><span class="line">        # 循环体语句</span><br><span class="line">        SET id = id + 1;</span><br><span class="line">        # 退出条件</span><br><span class="line">        IF id &gt;= 10</span><br><span class="line">            THEN LEAVE add_loop;</span><br><span class="line">        END IF;</span><br><span class="line">    END LOOP add_loop;</span><br><span class="line">END $</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>



<p><strong>举例2：</strong>当市场环境变好时，公司为了奖励大家，决定给大家涨工资。声明存储过程 “update_salary_loop()”，声明 OUT 参数 num，输出循环次数。存储过程中实现循环给大家涨薪，薪资涨为原来的1.1倍。直到全公司的平均薪资达到12000结束。并统计循环次数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE update_salary_loop(OUT num INT)</span><br><span class="line">BEGIN</span><br><span class="line"></span><br><span class="line">DECLARE avg_salary DOUBLE;</span><br><span class="line">DECLARE loop_count INT DEFAULT 0;</span><br><span class="line">SELECT AVG(salary) INTO avg_salary FROM employees;</span><br><span class="line"></span><br><span class="line">label_loop:LOOP</span><br><span class="line">	IF avg_salary &gt;= 12000 THEN LEAVE label_loop;</span><br><span class="line">    END IF;</span><br><span class="line">	UPDATE employees SET salary = salary * 1.1;</span><br><span class="line">	SET loop_count = loop_count + 1;</span><br><span class="line">	SELECT AVG(salary) INTO avg_salary FROM employees;</span><br><span class="line">END LOOP label_loop;</span><br><span class="line"></span><br><span class="line">SET num = loop_count;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELIMITER $</span><br><span class="line">CREATE PROCEDURE update_salary_loop(OUT num INT)</span><br><span class="line">BEGIN</span><br><span class="line">	DECLARE loop_count INT DEFAULT 0; # 循环次数</span><br><span class="line">	DECLARE avg_sal DOUBLE(8,2); # 平均薪资</span><br><span class="line">	</span><br><span class="line">	# 循环体语句</span><br><span class="line">	label_loop: LOOP</span><br><span class="line">		# 查询当前平均工资</span><br><span class="line">		SELECT AVG(salary) INTO avg_sal FROM employees;</span><br><span class="line">		# 判断：如果 avg_sal&gt;12000 循环结束，否则每个员工的薪资增长1.1倍</span><br><span class="line">		# 退出条件</span><br><span class="line">		IF avg_sal &gt;= 12000</span><br><span class="line">			THEN LEAVE label_loop;</span><br><span class="line">		ELSE </span><br><span class="line">			UPDATE employees SET salary = salary * 1.1;</span><br><span class="line">			SET loop_count = loop_count + 1;</span><br><span class="line">		END IF;</span><br><span class="line">	END LOOP label_loop;</span><br><span class="line">	SET num = loop_count;</span><br><span class="line">END $</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>





<h2 id="3-4-循环结构之WHILE"><a href="#3-4-循环结构之WHILE" class="headerlink" title="3.4 循环结构之WHILE"></a>3.4 循环结构之WHILE</h2><p><code>WHILE</code> 语句创建一个带条件判断的循环过程。WHILE 在执行语句执行时，先对指定的表达式进行判断，如<br>果为真，就执行循环内的语句，否则退出循环。WHILE 语句的基本格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[while_label:] WHILE 循环条件 DO </span><br><span class="line">	循环体</span><br><span class="line">END WHILE [while_label];</span><br></pre></td></tr></table></figure>

<p>while_label 为 WHILE 语句的标注名称；如果循环条件结果为真，WHILE 语句内的语句或语句群被执行，直<br>至循环条件为假，退出循环。</p>
<p><strong>举例1：</strong>WHILE 语句示例，i 值小于 10 时，将重复执行循环过程，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE test_while()</span><br><span class="line">BEGIN</span><br><span class="line"></span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">WHILE i &lt; 10 DO</span><br><span class="line">	SET i = i + 1;</span><br><span class="line">END WHILE;</span><br><span class="line">SELECT i;</span><br><span class="line"></span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"># 调用</span><br><span class="line">CALL test_while();</span><br></pre></td></tr></table></figure>

<p><strong>举例2：</strong>市场环境不好时，公司为了渡过难关，决定暂时降低大家的薪资。声明存储过程 “update_salary_while()”，声明 OUT 参数 num，输出循环次数。存储过程中实现循环给大家降薪，薪资降为原来的 90%。直到全公司的平均薪资达到5000结束。并统计循环次数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE update_salary_while(OUT num INT)</span><br><span class="line">BEGIN</span><br><span class="line"></span><br><span class="line">DECLARE avg_sal DOUBLE ;</span><br><span class="line">DECLARE while_count INT DEFAULT 0;</span><br><span class="line">SELECT AVG(salary) INTO avg_sal FROM employees;</span><br><span class="line"></span><br><span class="line">WHILE avg_sal &gt; 5000 DO</span><br><span class="line">	UPDATE employees SET salary = salary * 0.9;</span><br><span class="line">	SET while_count = while_count + 1;</span><br><span class="line">	SELECT AVG(salary) INTO avg_sal FROM employees;</span><br><span class="line">END WHILE;</span><br><span class="line">SET num = while_count;</span><br><span class="line"></span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>





<h2 id="3-5-循环结构之REPEAT"><a href="#3-5-循环结构之REPEAT" class="headerlink" title="3.5 循环结构之REPEAT"></a>3.5 循环结构之REPEAT</h2><p><code>REPEAT</code> 语句创建一个带条件判断的循环过程。与 WHILE 循环不同的是，REPEAT 循环首先会执行一次循<br>环，然后在 <code>UNTIL</code> 中进行表达式的判断，如果满足条件就退出，即 <code>END REPEAT</code>；如果条件不满足，就会继续执行循环，直到满足退出条件为止。</p>
<p>REPEAT 语句的基本格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[repeat_label:] REPEAT</span><br><span class="line">　　　　循环体的语句</span><br><span class="line">UNTIL 结束循环的条件表达式</span><br><span class="line">END REPEAT [repeat_label]</span><br></pre></td></tr></table></figure>

<p>repeat_label 为 REPEAT 语句的标注名称，该参数可以省略；REPEAT 语句内的语句或语句群被重复，直至  expr_condition 为真。</p>
<p><strong>举例1：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line">CREATE PROCEDURE test_repeat()</span><br><span class="line">BEGIN</span><br><span class="line"></span><br><span class="line">	DECLARE i INT DEFAULT 0;</span><br><span class="line">	</span><br><span class="line">	REPEAT </span><br><span class="line">		# 无条件先执行一次</span><br><span class="line">		SET i = i + 1;</span><br><span class="line">	# 循环结束条件</span><br><span class="line">	UNTIL i &gt;= 10</span><br><span class="line">	END REPEAT;</span><br><span class="line"></span><br><span class="line">	# 验证</span><br><span class="line">	SELECT i;</span><br><span class="line">	</span><br><span class="line">END $</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p><strong>举例2：</strong>当市场环境变好时，公司为了奖励大家，决定给大家涨工资。声明存储过程 “update_salary_repeat()”，声明 OUT 参数 num ，输出循环次数。存储过程中实现循环给大家涨薪，薪资涨为原来的 1.15 倍。直到全公司的平均薪资达到 13000 结束。并统计循环次数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line">CREATE PROCEDURE update_salary_repeat(OUT num INT)</span><br><span class="line">BEGIN	</span><br><span class="line">	DECLARE repeat_count INT DEFAULT 0; # 循环次数</span><br><span class="line">	DECLARE avg_sal DOUBLE; # 平均工资</span><br><span class="line">	SELECT AVG(salary) INTO avg_sal FROM employees;  </span><br><span class="line">	</span><br><span class="line">	# 循环体：</span><br><span class="line">	REPEAT</span><br><span class="line">		# 1、所有员工的薪资涨为原来的1.15倍</span><br><span class="line">		UPDATE employees SET salary = salary * 1.15;</span><br><span class="line">		# 2、更新 avg_sal</span><br><span class="line">		SELECT AVG(salary) INTO avg_sal FROM employees;</span><br><span class="line">		# 3、更新 repeat_count</span><br><span class="line">		SET repeat_count = repeat_count + 1;</span><br><span class="line">		</span><br><span class="line">	# 循环结束条件：avg_sal达到13000</span><br><span class="line">	UNTIL avg_sal &gt;= 13000</span><br><span class="line">		END REPEAT;</span><br><span class="line">	</span><br><span class="line">	# 更新输出变量</span><br><span class="line">	SET num = repeat_count;</span><br><span class="line">END $</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p><strong>对比三种循环结构：</strong></p>
<ol>
<li> 这三种循环都可以省略名称，但如果循环中添加了循环控制语句（LEAVE或ITERATE）则必须添加名称。 </li>
<li> LOOP：一般用于实现简单的”死”循环；WHILE：先判断后执行； REPEAT：先执行后判断，无条件至少执行一次</li>
</ol>
<hr>
<h2 id="3-6-跳转语句之LEAVE语句"><a href="#3-6-跳转语句之LEAVE语句" class="headerlink" title="3.6 跳转语句之LEAVE语句"></a>3.6 跳转语句之LEAVE语句</h2><p><code>LEAVE</code> 语句：可以用在循环语句内，或者以 BEGIN…END 包裹起来的程序体内，表示跳出循环或者跳出<br>程序体的操作。如果你有面向过程的编程语言的使用经验，你可以把 LEAVE 理解为 break。</p>
<p>基本格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LEAVE 标记名</span><br></pre></td></tr></table></figure>

<p>其中，label 参数表示循环的标志。LEAVE 和 BEGIN … END 或循环一起被使用。</p>
<p><strong>举例1：</strong>创建存储过程 “leave_begin()”，声明INT类型的IN参数num。给BEGIN…END加标记名，并在 BEGIN…END 中使用 IF 语句判断num 参数的值。</p>
<ul>
<li>  如果num&lt;=0，则使用LEAVE语句退出BEGIN…END；</li>
<li>  如果num=1，则查询“employees”表的平均薪资；</li>
<li>  如果num=2，则查询“employees”表的最低薪资；</li>
<li>  如果num&gt;2，则查询“employees”表的最高薪资。</li>
</ul>
<p>IF语句结束后查询“employees”表的总人数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE leave_begin(IN num INT)</span><br><span class="line">begin_label: BEGIN</span><br><span class="line"></span><br><span class="line">IF num&lt;=0 </span><br><span class="line">	THEN LEAVE begin_label;</span><br><span class="line">ELSEIF num=1</span><br><span class="line">	THEN SELECT AVG(salary) FROM employees;</span><br><span class="line">ELSEIF num=2</span><br><span class="line">	THEN SELECT MIN(salary) FROM employees;</span><br><span class="line">ELSE</span><br><span class="line">	SELECT MAX(salary) FROM employees;</span><br><span class="line">END IF;</span><br><span class="line"></span><br><span class="line">SELECT COUNT(*) FROM employees;</span><br><span class="line"></span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>



<p><strong>举例2：</strong>当市场环境不好时，公司为了渡过难关，决定暂时降低大家的薪资。声明存储过程“leave_while()”，声明OUT参数num，输出循环次数，存储过程中使用WHILE循环给大家降低薪资为原来薪资的90%，直到全公司的平均薪资小于等于10000，并统计循环次数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE leave_while(OUT num INT)</span><br><span class="line">BEGIN</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DECLARE avg_sal DOUBLE; # 记录平均工资</span><br><span class="line">DECLARE while_count INT DEFAULT 0; # 记录循环次数</span><br><span class="line">SELECT AVG(salary) INTO avg_sal FROM employees; #① 初始化条件</span><br><span class="line"></span><br><span class="line">while_label:WHILE TRUE DO #② 循环条件</span><br><span class="line">	#③ 循环体</span><br><span class="line">	IF avg_sal &lt;= 10000 </span><br><span class="line">		THEN LEAVE while_label;</span><br><span class="line">	END IF;</span><br><span class="line">	</span><br><span class="line">	UPDATE employees SET salary = salary * 0.9;</span><br><span class="line">	SET while_count = while_count + 1;</span><br><span class="line">	#④ 迭代条件</span><br><span class="line">	SELECT AVG(salary) INTO avg_sal FROM employees;</span><br><span class="line">	END WHILE;</span><br><span class="line"></span><br><span class="line"># 赋值</span><br><span class="line">SET num = while_count;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>





<hr>
<h2 id="3-7-跳转语句之ITERATE语句"><a href="#3-7-跳转语句之ITERATE语句" class="headerlink" title="3.7 跳转语句之ITERATE语句"></a>3.7 跳转语句之ITERATE语句</h2><p><code>ITERATE </code>语句：只能用在循环语句（LOOP、REPEAT和WHILE语句）内，表示重新开始循环，将执行顺序<br>转到语句段开头处。如果你有面向过程的编程语言的使用经验，你<strong>可以把 ITERATE 理解为 continue</strong>，意<br>思为“再次循环”。</p>
<p>语句基本格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ITERATE label</span><br></pre></td></tr></table></figure>

<p>label 参数表示循环的标志。ITERATE 语句必须跟在循环标志前面。</p>
<p><strong>举例：</strong> 定义局部变量num，初始值为0。循环结构中执行 num+1 操作。</p>
<ul>
<li>  如果num &lt; 10，则继续执行循环；</li>
<li>  如果num &gt; 15，则退出循环结构；</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE test_iterate()</span><br><span class="line">BEGIN</span><br><span class="line"></span><br><span class="line">DECLARE num INT DEFAULT 0;</span><br><span class="line"></span><br><span class="line">my_loop:LOOP</span><br><span class="line">	SET num = num + 1;</span><br><span class="line">	IF num &lt; 10</span><br><span class="line">		THEN ITERATE my_loop;</span><br><span class="line">	ELSEIF num &gt; 15</span><br><span class="line">		THEN LEAVE my_loop; </span><br><span class="line">	END IF;</span><br><span class="line">	</span><br><span class="line">	SELECT &#x27;Other&#x27;;</span><br><span class="line">END LOOP my_loop;</span><br><span class="line"></span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>





<hr>
<h1 id="常见存储函数与存储过程"><a href="#常见存储函数与存储过程" class="headerlink" title="常见存储函数与存储过程"></a>常见存储函数与存储过程</h1><h2 id="存储函数"><a href="#存储函数" class="headerlink" title="存储函数"></a>存储函数</h2><p><strong>rand_num(from_num INT ,to_num INT)：</strong>用于生成 <code>from_num ~ to_num</code> 之间的随机整数。</p>
<ul>
<li>  声明存储函数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"># 使用数据库</span><br><span class="line">USE `gmall`$$</span><br><span class="line"># 如果存在同名函数则先删除</span><br><span class="line">DROP FUNCTION IF EXISTS `rand_num`$$</span><br><span class="line"></span><br><span class="line"># 创建存储函数，接收两个参数：from_num 和 to_num，返回值是 int 类型</span><br><span class="line">CREATE DEFINER=`root`@`localhost` FUNCTION `rand_num`(from_num INT ,to_num INT) RETURNS INT(11)</span><br><span class="line">BEGIN   </span><br><span class="line">	</span><br><span class="line">	# 声明局部变量i，默认值为0</span><br><span class="line">	DECLARE i INT DEFAULT 0;  </span><br><span class="line">	SET i = FLOOR(from_num +RAND()*(to_num -from_num+1))   ;</span><br><span class="line">	RETURN i;  </span><br><span class="line"></span><br><span class="line">END$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>  调用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 生成 1~10 之间的随机整数</span><br><span class="line">SELECT rand_num(1, 10);</span><br></pre></td></tr></table></figure>





<p>**rand_num_seed(from_num INT ,to_num INT,seed LONG)**：生成 <code>from_num ~ to_num</code> 之间的随机整数，可以指定随机数种子。</p>
<ul>
<li>  声明存储函数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line">USE `gmall`$$</span><br><span class="line"></span><br><span class="line">DROP FUNCTION IF EXISTS `rand_num_seed`$$</span><br><span class="line"></span><br><span class="line">CREATE DEFINER=`root`@`localhost` FUNCTION `rand_num_seed`(from_num INT ,to_num INT,seed LONG ) RETURNS INT(11)</span><br><span class="line">BEGIN   </span><br><span class="line"> DECLARE i INT DEFAULT 0;  </span><br><span class="line"> SET i = FLOOR(from_num +RAND(seed+UNIX_TIMESTAMP(NOW()))*(to_num -from_num+1))   ;</span><br><span class="line">RETURN i;  </span><br><span class="line"> END$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>  调用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT rand_num_seed(1, 10, 3);</span><br></pre></td></tr></table></figure>





<p>**rand_nums( from_num INT, to_num INT, n INT, delemit VARCHAR(20) )**：在<code>from_num ~ to_num</code> 区间内生成 n 个随机整数，每个数之间用 delemit 分隔。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line">USE `gmall`$$</span><br><span class="line"></span><br><span class="line">DROP FUNCTION IF EXISTS `rand_nums`$$</span><br><span class="line"></span><br><span class="line">CREATE DEFINER=`root`@`localhost` FUNCTION `rand_nums`(from_num INT ,to_num INT,n INT ,delemit VARCHAR(20)) RETURNS VARCHAR(255) CHARSET utf8</span><br><span class="line">BEGIN   </span><br><span class="line"> DECLARE i INT DEFAULT 0;  </span><br><span class="line"> DECLARE v INT DEFAULT 0;</span><br><span class="line"> DECLARE return_str VARCHAR(255) DEFAULT &#x27;&#x27;;  </span><br><span class="line"> WHILE i &lt; n DO </span><br><span class="line">	 SET v = rand_num (from_num   ,to_num  ) ;</span><br><span class="line">	 SET return_str=CONCAT(return_str,v);</span><br><span class="line">	 IF LENGTH(return_str)&gt;0 THEN </span><br><span class="line">	   SET return_str=CONCAT(return_str,delemit) ;</span><br><span class="line">	 END IF;</span><br><span class="line">	 SET i = i + 1;</span><br><span class="line">END WHILE;</span><br><span class="line"> RETURN return_str;</span><br><span class="line">END$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>  调用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 生成 9~99 之间的 5 个整数，每个数之间以 “，” 分隔</span><br><span class="line">SELECT rand_nums(9, 99, 5, &quot;，&quot;);</span><br></pre></td></tr></table></figure>



<p>**rand_string(n INT)**：创建 n 个字符长度的随机字符串</p>
<ul>
<li>  声明存储函数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line">USE `gmall`$$</span><br><span class="line"></span><br><span class="line">DROP FUNCTION IF EXISTS `rand_string`$$</span><br><span class="line"></span><br><span class="line">CREATE DEFINER=`root`@`localhost` FUNCTION `rand_string`(n INT) RETURNS VARCHAR(255) CHARSET utf8</span><br><span class="line">BEGIN    </span><br><span class="line">DECLARE chars_str VARCHAR(100) DEFAULT &#x27;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#x27;;</span><br><span class="line"> DECLARE return_str VARCHAR(255) DEFAULT &#x27;&#x27;;</span><br><span class="line"> DECLARE i INT DEFAULT 0;</span><br><span class="line"> WHILE i &lt; n DO  </span><br><span class="line"> SET return_str =CONCAT(return_str,SUBSTRING(chars_str,FLOOR(1+RAND()*52),1));  </span><br><span class="line"> SET i = i + 1;</span><br><span class="line"> END WHILE;</span><br><span class="line"> RETURN return_str;</span><br><span class="line">END$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>  调用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 创建5个长度的随机字符串</span><br><span class="line">SELECT rand_string(5);</span><br></pre></td></tr></table></figure>





<h2 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h2><p><strong>insert_order( create_time_string VARCHAR(200), max_num INT, user_num INT, sku_num INT )</strong></p>
<p>作用：向 order_info 表中插入数据</p>
<p>参数：</p>
<ul>
<li>  <code>create_time_string VARCHAR(200)</code>：创建时间，以字符串的形式传入</li>
<li>  <code>max_num INT</code>：循环结束的条件</li>
<li>  <code>user_num INT</code>：一共有多少个用户</li>
<li>  <code>sku_num INT</code>：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line">USE `gmall`$$</span><br><span class="line">DROP PROCEDURE IF EXISTS `insert_order`$$</span><br><span class="line">CREATE DEFINER=`root`@`localhost` PROCEDURE `insert_order`( create_time_string VARCHAR(200), max_num INT, user_num INT, sku_num INT  )</span><br><span class="line">BEGIN</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 声明局部变量</span><br><span class="line">DECLARE v_create_time DATETIME DEFAULT NULL; # 创建时间（必有值）</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">DECLARE v_order_status INT DEFAULT 0; # 订单状态（1或2） </span><br><span class="line">DECLARE v_operate_time DATETIME DEFAULT NULL; # 操作时间（有值或为NULL）</span><br><span class="line">DECLARE v_order_id INT DEFAULT NULL; # 订单id</span><br><span class="line">DECLARE v_order_detail_num INT DEFAULT NULL; # 订单详情 </span><br><span class="line">DECLARE j INT DEFAULT 0;</span><br><span class="line">SET autocommit = 0; # 开启主键自增策略</span><br><span class="line"></span><br><span class="line"># 循环开始</span><br><span class="line">REPEAT</span><br><span class="line">	SET i = i + 1;  </span><br><span class="line">	SET v_create_time=DATE_ADD(DATE_FORMAT(create_time_string, &#x27;%Y-%m-%d&#x27;), INTERVAL rand_num(30,3600*23) SECOND);</span><br><span class="line">	SET v_order_status=rand_num(1,2); </span><br><span class="line"></span><br><span class="line">	IF v_order_status&gt;1 THEN </span><br><span class="line">		SET v_operate_time= DATE_ADD(v_create_time ,INTERVAL rand_num(30,3600) SECOND);</span><br><span class="line">	ELSE</span><br><span class="line">		SET v_operate_time=NULL;</span><br><span class="line">	END IF;</span><br><span class="line">	</span><br><span class="line">	# 向 order_info 表中插入一条数据（order_info表的主键id是自动生成的，无需手动插入）    	</span><br><span class="line">	INSERT INTO order_info </span><br><span class="line">		(consignee,</span><br><span class="line">		 consignee_tel,</span><br><span class="line">	 	 total_amount ,</span><br><span class="line">	 	 order_status ,</span><br><span class="line">	 	 user_id,</span><br><span class="line">	 	 payment_way,</span><br><span class="line">	 	 delivery_address,</span><br><span class="line">	 	 order_comment,</span><br><span class="line">	 	 out_trade_no,</span><br><span class="line">	 	 trade_body,</span><br><span class="line">	 	 create_time,</span><br><span class="line">	 	 operate_time,</span><br><span class="line">	 	 expire_time, </span><br><span class="line">	 	 tracking_no,</span><br><span class="line">	 	 parent_order_id, </span><br><span class="line">	 	 img_url) </span><br><span class="line">	VALUES (rand_string(6), # 收货人</span><br><span class="line">		CONCAT(&#x27;13&#x27;,rand_nums(0,9,9,&#x27;&#x27;)), # 收货人电话</span><br><span class="line">		CAST(rand_num(50,1000) AS DECIMAL(10,2)), # 总金额</span><br><span class="line">		v_order_status, # 订单状态</span><br><span class="line">		rand_num(1,user_num), # 用户id</span><br><span class="line">		rand_num(1,2), # 付款方式</span><br><span class="line">		rand_string(20), # 送货地址</span><br><span class="line">		rand_string(20), # 订单备注</span><br><span class="line">		rand_nums(0,9,10,&#x27;&#x27;), # 订单交易编号</span><br><span class="line">		&#x27;&#x27;, # 订单描述</span><br><span class="line">		v_create_time,  # 创建时间</span><br><span class="line">		v_operate_time,	# 操作时间</span><br><span class="line">		NULL,	# 失效时间</span><br><span class="line">		NULL,	# 物流单编号</span><br><span class="line">		NULL,	# 父订单编号</span><br><span class="line">		NULL    # 图片路径</span><br><span class="line">		);</span><br><span class="line">	</span><br><span class="line">	# SELECT  LAST_INSERT_ID() 的作用是得到刚 insert 进去记录的主键值</span><br><span class="line">	SELECT  LAST_INSERT_ID() INTO v_order_id ;</span><br><span class="line">	# 设置订单详情中的购买个数</span><br><span class="line">	SET v_order_detail_num=rand_num(1,5);</span><br><span class="line">	# 每购买一次，就会生成一条订单详情数据 </span><br><span class="line">	WHILE j &lt; v_order_detail_num DO</span><br><span class="line">		SET j=j+1;</span><br><span class="line">		# 向 order_detail 表插入数据</span><br><span class="line">		INSERT INTO order_detail</span><br><span class="line">		(order_id, sku_id, sku_name ,img_url ,order_price, sku_num ) </span><br><span class="line">		VALUES </span><br><span class="line">		(v_order_id , rand_num(1,sku_num), rand_string(10), CONCAT(&#x27;http://&#x27;,rand_string(40)) ,CAST(rand_num(20,5000) AS DECIMAL(10,2)), rand_num(1,5)  ); </span><br><span class="line">	END WHILE;</span><br><span class="line">	</span><br><span class="line">	SET j=0;</span><br><span class="line"></span><br><span class="line"># 循环结束。结束条件：i = max_num</span><br><span class="line">UNTIL i = max_num</span><br><span class="line">	END REPEAT;  </span><br><span class="line"></span><br><span class="line"># 提交所有操作</span><br><span class="line">COMMIT;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">END$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>



<p><strong>验证OK！调用：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CALL insert_order(&quot;2019-02-10&quot;, 100, 100, 100);</span><br></pre></td></tr></table></figure>







<p><strong>init_data( do_date_string VARCHAR(20) ,order_incr_num INT,user_incr_num INT ,sku_num INT ,if_truncate BOOLEAN  )</strong></p>
<ul>
<li>  <code>do_date_string</code>：</li>
<li>  <code>order_incr_num</code></li>
<li>  <code>user_incr_num</code>：</li>
<li>  <code>sku_num</code>：向 sku 表中插入数据的条数</li>
<li>  <code>if_truncate</code>：插入数据前是否删除已存在的数据</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line">USE `gmall`$$</span><br><span class="line">DROP PROCEDURE IF EXISTS `init_data`$$</span><br><span class="line">CREATE DEFINER=`root`@`localhost` PROCEDURE `init_data`( do_date_string VARCHAR(20) ,order_incr_num INT,user_incr_num INT ,sku_num INT ,if_truncate BOOLEAN  )</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">	# 声明局部变量</span><br><span class="line">     DECLARE user_count INT DEFAULT 0; </span><br><span class="line">     DECLARE sku_count INT DEFAULT 0; </span><br><span class="line">     DECLARE do_date VARCHAR(20) DEFAULT do_date_string;</span><br><span class="line">     </span><br><span class="line">     # 是否清空原始数据</span><br><span class="line">     IF if_truncate  THEN </span><br><span class="line">        TRUNCATE TABLE order_info ;</span><br><span class="line">        TRUNCATE TABLE order_detail ;</span><br><span class="line">        TRUNCATE TABLE sku_info ;</span><br><span class="line">        TRUNCATE TABLE user_info ;</span><br><span class="line">     END IF ;</span><br><span class="line">     </span><br><span class="line">     # 调用存储过程 insert_sku</span><br><span class="line">     CALL insert_sku(do_date, sku_num);</span><br><span class="line">     # 为变量 sku_count 赋值</span><br><span class="line">     SELECT COUNT(*) INTO sku_count FROM  sku_info;</span><br><span class="line">     </span><br><span class="line">     # 调用存储过程 insert_user</span><br><span class="line">     CALL insert_user(do_date,user_incr_num );</span><br><span class="line">     # 为变量 user_count 赋值</span><br><span class="line">     SELECT COUNT(*) INTO user_count FROM  user_info;</span><br><span class="line">     </span><br><span class="line">     # 调用存储过程 update_order</span><br><span class="line">     CALL update_order(do_date);</span><br><span class="line">     # 调用存储过程 insert_order</span><br><span class="line">     CALL insert_order(do_date,order_incr_num,user_count,sku_count);</span><br><span class="line">     # 调用存储过程 insert_payment</span><br><span class="line">     CALL insert_payment(do_date);</span><br><span class="line">END$$</span><br><span class="line"></span><br><span class="line">DELIMITER ; </span><br></pre></td></tr></table></figure>





<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><code>DATE_ADD(d，INTERVAL expr type)</code></td>
<td>计算起始日期 d 加上一个时间段后的日期，type 值可以是</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>insert_user( create_time_string VARCHAR(200), max_num INT)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line">USE `gmall`$$</span><br><span class="line">DROP PROCEDURE IF EXISTS `insert_user`$$</span><br><span class="line">CREATE DEFINER=`root`@`localhost` PROCEDURE `insert_user`( create_time_string VARCHAR(200),max_num INT  )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">	# 声明局部变量</span><br><span class="line">	DECLARE v_create_time DATETIME DEFAULT NULL;</span><br><span class="line"> 	DECLARE i INT DEFAULT 0;</span><br><span class="line"> 	DECLARE v_birthday DATE DEFAULT NULL;</span><br><span class="line"> 	DECLARE v_gender VARCHAR(1) DEFAULT NULL;</span><br><span class="line"> 	# 设置主键自增</span><br><span class="line">	SET autocommit = 0;    </span><br><span class="line"> 	</span><br><span class="line"> 	# 循环Start</span><br><span class="line">	REPEAT</span><br><span class="line">		SET i  = i + 1;  </span><br><span class="line">		SET v_create_time=DATE_ADD(DATE_FORMAT(create_time_string,&#x27;%Y-%m-%d&#x27;), INTERVAL rand_num(1,3600*24) SECOND);</span><br><span class="line">		SET v_birthday=DATE_ADD(DATE_FORMAT(&#x27;1950-01-01&#x27;,&#x27;%Y-%m-%d&#x27;) ,INTERVAL rand_num(1,365*50) DAY); </span><br><span class="line">		SET v_gender=IF(rand_num(0,1)=0,&#x27;M&#x27;,&#x27;F&#x27;);</span><br><span class="line"> 		</span><br><span class="line"> 		# 插入数据</span><br><span class="line"> 		INSERT INTO user_info (login_name,nick_name,passwd,NAME,phone_num,email,head_img,user_level,birthday,gender,create_time  ) </span><br><span class="line">		VALUES (rand_string(20) ,rand_string(20) , CONCAT(&#x27;pwd&#x27;,rand_string(20)), rand_string(30), CONCAT(&#x27;13&#x27;,rand_nums(0,9,9,&#x27;&#x27;))    ,CONCAT(rand_string(8),&#x27;@&#x27;,rand_string(3),&#x27;.com&#x27;) ,  CONCAT(&#x27;http://&#x27;,rand_string(40)), rand_num(1,5),v_birthday,v_gender,v_create_time    ); </span><br><span class="line"> </span><br><span class="line">	# 循环结束</span><br><span class="line">	UNTIL i = max_num  </span><br><span class="line"> 		END REPEAT;  </span><br><span class="line"> 	</span><br><span class="line"> 	# 提交</span><br><span class="line">	COMMIT;  </span><br><span class="line"></span><br><span class="line">END$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>


    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2022/01/18/MySQL-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E4%B8%8E%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0/" rel="prev" title="MySQL_存储过程与存储函数">
                  <i class="fa fa-chevron-left"></i> MySQL_存储过程与存储函数
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2022/01/25/Azkaban/" rel="next" title="Azkaban">
                  Azkaban <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>






</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
