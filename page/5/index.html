<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width">
<meta name="theme-color" content="#222"><meta name="generator" content="Hexo 5.4.2">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" integrity="sha256-DfWjNxDkM94fVBWx1H5BMMp0Zq7luBlV8QRcSES7s+0=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{"hostname":"example.com","root":"/","images":"/images","scheme":"Muse","darkmode":false,"version":"8.11.1","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12},"copycode":{"enable":false,"style":null},"bookmark":{"enable":false,"color":"#222","save":"auto"},"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"stickytabs":false,"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"fadeInDown","post_body":"fadeInDown","coll_header":"fadeInLeft","sidebar":"fadeInUp"}},"prism":false,"i18n":{"placeholder":"Searching...","empty":"We didn't find any results for the search: ${query}","hits_time":"${hits} results found in ${time} ms","hits":"${hits} results found"}}</script><script src="/js/config.js"></script>

    <meta property="og:type" content="website">
<meta property="og:title" content="Hexo">
<meta property="og:url" content="http://example.com/page/5/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/page/5/">



<script class="next-config" data-name="page" type="application/json">{"sidebar":"","isHome":true,"isPost":false,"lang":"en","comments":"","permalink":"","path":"page/5/index.html","title":""}</script>

<script class="next-config" data-name="calendar" type="application/json">""</script>
<title>Hexo</title>
  





  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">Hexo</h1>
      <i class="logo-line"></i>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>







</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-overview-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
        <a href="/archives/">
          <span class="site-state-item-count">235</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
          <a href="/categories/">
        <span class="site-state-item-count">70</span>
        <span class="site-state-item-name">categories</span></a>
      </div>
      <div class="site-state-item site-state-tags">
          <a href="/tags/">
        <span class="site-state-item-count">3</span>
        <span class="site-state-item-name">tags</span></a>
      </div>
  </nav>
</div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner index posts-expand">

    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/29/MySQL%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/29/MySQL%E6%97%A5%E5%BF%97%E7%B3%BB%E7%BB%9F/" class="post-title-link" itemprop="url">MySQL日志系统</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-01-29 19:33:06 / Modified: 19:34:00" itemprop="dateCreated datePublished" datetime="2022-01-29T19:33:06+08:00">2022-01-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL%E6%96%B0%E7%89%88/" itemprop="url" rel="index"><span itemprop="name">MySQL新版</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="日志系统：一条SQL更新语句是如何执行的？"><a href="#日志系统：一条SQL更新语句是如何执行的？" class="headerlink" title="日志系统：一条SQL更新语句是如何执行的？"></a>日志系统：一条SQL更新语句是如何执行的？</h1>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/29/MySQL%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/29/MySQL%E5%9F%BA%E7%A1%80%E6%9E%B6%E6%9E%84/" class="post-title-link" itemprop="url">MySQL基础架构</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-01-29 19:29:05 / Modified: 19:32:37" itemprop="dateCreated datePublished" datetime="2022-01-29T19:29:05+08:00">2022-01-29</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySQL%E6%96%B0%E7%89%88/" itemprop="url" rel="index"><span itemprop="name">MySQL新版</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="基础架构：一条SQL查询语句是如何执行的？"><a href="#基础架构：一条SQL查询语句是如何执行的？" class="headerlink" title="基础架构：一条SQL查询语句是如何执行的？"></a>基础架构：一条SQL查询语句是如何执行的？</h1>
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/28/MySQL-%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/28/MySQL-%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/" class="post-title-link" itemprop="url">MySQL-多版本并发控制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-28 20:10:19" itemprop="dateCreated datePublished" datetime="2022-01-28T20:10:19+08:00">2022-01-28</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-04-07 21:39:44" itemprop="dateModified" datetime="2022-04-07T21:39:44+08:00">2022-04-07</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySql/" itemprop="url" rel="index"><span itemprop="name">MySql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-什么是MVCC"><a href="#1-什么是MVCC" class="headerlink" title="1 什么是MVCC"></a>1 什么是MVCC</h1><blockquote>
<p>  多版本并发控制，Multiversion Concurrency Control，MVCC</p>
</blockquote>
<p>顾名思义，MVCC 是通过表中记录的多个版本管理来实现数据库的并发控制。这项技术使得在 InnoDB 的事务隔离级别下执行一致性读操作有了保证。换言之，就是为了查询一些正在被另一个事务更新的行，并且可以看到它们被更新之前的值，这样在做查询的时候就不用等待另一个事务释放锁。</p>
<h1 id="2-快照读与当前读"><a href="#2-快照读与当前读" class="headerlink" title="2 快照读与当前读"></a>2 快照读与当前读</h1><p>MVCC 在 MySQL InnoDB 中的实现主要是为了提高数据库并发性能，<u>用更好的方式去处理<code>读-写冲突</code>，做到即使有读写冲突时，也能做到不加锁</u>， 非阻塞并发读，而这个读指的就是快照读, 而非当前读。</p>
<p>当前读实际上是一种加锁的操作，是悲观锁的实现。而 MVCC 本质是采用乐观锁思想的一种方式。</p>
<h2 id="2-1-快照读"><a href="#2-1-快照读" class="headerlink" title="2.1 快照读"></a>2.1 快照读</h2><p>快照读又叫一致性读，读取的是快照数据。<strong>不加锁的简单的 SELECT 都属于快照读</strong>，即不加锁的非阻塞读。比如这样：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM player WHERE ...</span><br></pre></td></tr></table></figure>

<p>之所以出现快照读的情况，是基于提高并发性能的考虑，快照读的实现是基于MVCC，它在很多情况下，避免了加锁操作，降低了开销。</p>
<p><u>既然是基于多版本，那么快照读可能读到的并不一定是数据的最新版本，而有可能是之前的历史版本。</u></p>
<p><u>快照读的前提是隔离级别不是串行级别，串行级别下的快照读会退化成当前读。</u></p>
<h2 id="2-2-当前读"><a href="#2-2-当前读" class="headerlink" title="2.2 当前读"></a>2.2 当前读</h2><p>当前读读取的是记录的最新版本（最新数据，而不是历史版本的数据），<u>读取时还要保证其他并发事务不能修改当前记录，会对读取的记录进行加锁。</u></p>
<p>加锁的 SELECT，或者对数据进行增删改都会进行当前读。比如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM student LOCK IN SHARE MODE; # 共享锁</span><br><span class="line">SELECT * FROM student FOR UPDATE; # 排它锁</span><br><span class="line">INSERT INTO student values ... # 排它锁</span><br><span class="line">DELETE FROM student WHERE ... # 排它锁</span><br><span class="line">UPDATE student SET ... # 排它锁</span><br></pre></td></tr></table></figure>





<h1 id="3-复习"><a href="#3-复习" class="headerlink" title="3 复习"></a>3 复习</h1><h2 id="3-1-再谈隔离级别"><a href="#3-1-再谈隔离级别" class="headerlink" title="3.1 再谈隔离级别"></a>3.1 再谈隔离级别</h2><p>我们知道事务有 4 个隔离级别，可能存在三种并发问题：</p>
<p><img src="/2022/01/28/MySQL-%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/image-20220407211710668.png" alt="image-20220407211710668"></p>
<p>另图：</p>
<p><img src="/2022/01/28/MySQL-%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/image-20220407211810571.png" alt="image-20220407211810571"></p>
<h2 id="3-2-隐藏字段、Undo-Log版本链"><a href="#3-2-隐藏字段、Undo-Log版本链" class="headerlink" title="3.2 隐藏字段、Undo Log版本链"></a>3.2 隐藏字段、Undo Log版本链</h2><p>回顾一下 undo 日志的版本链，对于使用 InnoDB 存储引擎的表来说，它的聚簇索引记录中都包含两个必要的隐藏列。</p>
<ul>
<li>  <code>trx_id</code>：每次一个事务对某条聚簇索引记录进行改动时，都会把该事务的事务id 赋值给 trx_id 隐藏列。</li>
<li>  <code>roll_pointer</code>：每次对某条聚簇索引记录进行改动时，都会把旧的版本写入到 undo 日志中，然后这个隐藏列就相当于一个指针，可以通过它来找到该记录修改前的信息。</li>
</ul>
<p><img src="/2022/01/28/MySQL-%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/image-20220407212125650.png" alt="image-20220407212125650"></p>
<blockquote>
<p>  insert undo 只在事务回滚时起作用，当事务提交后，该类型的 undo 日志就没用了，它占用的 Undo Log Segment也会被系统回收（也就是该undo日志占用的Undo页面链表要么被重用，要么被释放）。</p>
</blockquote>
<p>假设之后两个事务id分别为10 、20 的事务对这条记录进行UPDATE 操作，操作流程如下：</p>
<table>
<thead>
<tr>
<th>发生时间顺序</th>
<th>事务10</th>
<th>事务20</th>
</tr>
</thead>
<tbody><tr>
<td>1</td>
<td>BEGIN;</td>
<td></td>
</tr>
<tr>
<td>2</td>
<td></td>
<td>BEGIN;</td>
</tr>
<tr>
<td>3</td>
<td>UPDATE student SET name=”李四” WHERE id=1;</td>
<td></td>
</tr>
<tr>
<td>4</td>
<td>UPDATE student SET name=”王五” WHERE id=1;</td>
<td></td>
</tr>
<tr>
<td>5</td>
<td>COMMIT;</td>
<td></td>
</tr>
<tr>
<td>6</td>
<td></td>
<td>UPDATE student SET name=”钱七” WHERE id=1;</td>
</tr>
<tr>
<td>7</td>
<td></td>
<td>UPDATE student SET name=”宋八” WHERE id=1;</td>
</tr>
<tr>
<td>8</td>
<td></td>
<td>COMMIT;</td>
</tr>
</tbody></table>
<p>每次对记录进行改动，都会记录一条 undo 日志，每条 undo 日志也都有一个 roll_pointer 属性（INSERT 操作对应的undo日志没有该属性，因为该记录并没有更早的版本），可以将这些undo日志都连起来，串成一个链表：</p>
<p><img src="/2022/01/28/MySQL-%E5%A4%9A%E7%89%88%E6%9C%AC%E5%B9%B6%E5%8F%91%E6%8E%A7%E5%88%B6/image-20220407213039611.png" alt="image-20220407213039611"></p>
<p>对该记录每次更新后，都会将旧值放到一条 undo 日志中，就算是该记录的一个旧版本，随着更新次数的增多，所有的版本都会被 roll_pointer 属性连接成一个链表，我们把这个链表称之为版本链，版本链的头节点就是当前记录最新的值。</p>
<p>每个版本中还包含生成该版本时对应的事务id 。</p>
<hr>
<h1 id="4-MVCC-实现原理之-ReadView"><a href="#4-MVCC-实现原理之-ReadView" class="headerlink" title="4 MVCC 实现原理之 ReadView"></a>4 MVCC 实现原理之 ReadView</h1><p>MVCC 的实现依赖于：<strong>隐藏字段、Undo Log、Read View</strong>。</p>
<h2 id="4-1-什么是ReadView"><a href="#4-1-什么是ReadView" class="headerlink" title="4.1 什么是ReadView"></a>4.1 什么是ReadView</h2><h2 id="4-2-设计思路"><a href="#4-2-设计思路" class="headerlink" title="4.2 设计思路"></a>4.2 设计思路</h2><ul>
<li>  使用 <code>READ UNCOMMITTED</code> 隔离级别的事务，由于可以读到未提交事务修改过的记录，所以直接读取记录的最新版本就好了。</li>
<li>  使用 <code>SERIALIZABLE</code> 隔离级别的事务，InnoDB 规定使用加锁的方式来访问记录。</li>
<li>  使用 <code>READ COMMITTED</code> 和 <code>REPEATABLE READ</code> 隔离级别的事务，都必须保证读到已经提交了的事务修改成功的记录。假如另一个事务已经修改了记录但是尚未提交，是不能直接读取最新版本的记录的，核心问题就是需要判断一下版本链中的哪个版本是当前事务可见的，这是 ReadView 要解决的主要问题。</li>
</ul>
<p>这个 ReadView 中主要包含 4 个比较重要的内容，分别如下：</p>
<ol start="3">
<li><p><code>creator_trx_id</code>，创建这个 Read View 的事务 ID。</p>
<blockquote>
<p>  说明：只有在对表中的记录做改动时（执行 INSERT、DELETE、UPDATE 这些语句时）才会为事务分配事务id，否则在一个只读事务中的事务 id 值都默认为 0。</p>
</blockquote>
</li>
<li><p><code>trx_ids</code>，表示在生成 ReadView 时当前系统中活跃的读写事务的事务 id 列表。</p>
</li>
<li><p><code>up_limit_id</code>，活跃的事务中最小的事务 ID。</p>
</li>
<li><p><code>low_limit_id</code>，表示生成 ReadView 时系统中应该分配给下一个事务的 id 值。low_limit_id 是系统最大的事务 id 值，这里要注意是系统中的事务 id，需要区别于正在活跃的事务ID。</p>
<blockquote>
<p>  注意：low_limit_id 并不是 trx_ids 中的最大值，事务 id 是递增分配的。比如，现在有 id 为 1，2，3 这三个事务，之后 id 为 3 的事务提交了。那么一个新的读事务在生成 ReadView 时，trx_ids 就包括 1 和 2，up_limit_id 的值就是 1，low_limit_id 的值就是 4。</p>
</blockquote>
<h2 id="4-3-ReadView的规则"><a href="#4-3-ReadView的规则" class="headerlink" title="4.3 ReadView的规则"></a>4.3 ReadView的规则</h2><p> 有了这个 ReadView，这样在访问某条记录时，只需要按照下边的步骤判断记录的某个版本是否可见。</p>
<ul>
<li>  如果被访问版本的 trx_id 属性值与 ReadView 中的 creator_trx_id 值相同，意味着当前事务在访问它自己修改过的记录，所以该版本可以被当前事务访问。</li>
<li>如果被访问版本的 trx_id 属性值小于 ReadView 中的 up_limit_id 值，表明生成该版本的事务在当前事务生成ReadView前已经提交，所以该版本可以被当前事务访问。<br>  如果被访问版本的trx_id属性值大于或等于ReadView中的low_limit_id 值，表明生成该版本的事<br>  务在当前事务生成ReadView后才开启，所以该版本不可以被当前事务访问。<br>  如果被访问版本的trx_id属性值在ReadView的up_limit_id 和low_limit_id 之间，那就需要判<br>  断一下trx_id属性值是不是在trx_ids 列表中。<br>  如果在，说明创建ReadView时生成该版本的事务还是活跃的，该版本不可以被访问。<br>  如果不在，说明创建ReadView时生成该版本的事务已经被提交，该版本可以被访问。<br>  事务说明<br>  begin;<br>  select * from student where id &gt;2; 获取一次Read View<br>  ………<br>  select * from student where id &gt;2; 获取一次Read View<br>  commit;<br>  4.4 MVCC整体操作流程<br>  了解了这些概念之后，我们来看下当查询一条记录的时候，系统如何通过MVCC找到它：</li>
</ul>
</li>
<li><p>首先获取事务自己的版本号，也就是事务 ID；</p>
</li>
<li><p>获取 ReadView；</p>
</li>
<li><p>查询得到的数据，然后与 ReadView 中的事务版本号进行比较；</p>
</li>
<li><p>如果不符合 ReadView 规则，就需要从 Undo Log 中获取历史快照；</p>
</li>
<li><p>最后返回符合规则的数据。</p>
<pre><code>在隔离级别为读已提交（Read Committed）时，一个事务中的每一次 SELECT 查询都会重新获取一次
Read View。
如表所示：
注意，此时同样的查询语句都会重新获取一次 Read View，这时如果 Read View 不同，就可能产生
不可重复读或者幻读的情况。
当隔离级别为可重复读的时候，就避免了不可重复读，这是因为一个事务只在第一次 SELECT 的时候会
获取一次 Read View，而后面所有的 SELECT 都会复用这个 Read View，如下表所示：
</code></pre>
</li>
<li><p>举例说明<br>   5.1 READ COMMITTED隔离级别下<br>   READ COMMITTED ：每次读取数据前都生成一个ReadView。<br>   现在有两个事务id 分别为10 、20 的事务在执行：<br>   此刻，表student 中id 为1 的记录得到的版本链表如下所示：<br>   假设现在有一个使用READ COMMITTED 隔离级别的事务开始执行：<br>   之后，我们把事务id 为10 的事务提交一下：<br>   然后再到事务id 为20 的事务中更新一下表student 中id 为1 的记录：<br>   此刻，表student中id 为1 的记录的版本链就长这样：</p>
</li>
</ol>
<h1 id="Transaction-10"><a href="#Transaction-10" class="headerlink" title="Transaction 10"></a>Transaction 10</h1><p>BEGIN;<br>UPDATE student SET name=”李四” WHERE id=1;<br>UPDATE student SET name=”王五” WHERE id=1;</p>
<h1 id="Transaction-20"><a href="#Transaction-20" class="headerlink" title="Transaction 20"></a>Transaction 20</h1><p>BEGIN;</p>
<h1 id="更新了一些别的表的记录"><a href="#更新了一些别的表的记录" class="headerlink" title="更新了一些别的表的记录"></a>更新了一些别的表的记录</h1><p>…</p>
<h1 id="使用READ-COMMITTED隔离级别的事务"><a href="#使用READ-COMMITTED隔离级别的事务" class="headerlink" title="使用READ COMMITTED隔离级别的事务"></a>使用READ COMMITTED隔离级别的事务</h1><p>BEGIN;</p>
<h1 id="SELECT1：Transaction-10、20未提交"><a href="#SELECT1：Transaction-10、20未提交" class="headerlink" title="SELECT1：Transaction 10、20未提交"></a>SELECT1：Transaction 10、20未提交</h1><p>SELECT * FROM student WHERE id = 1; # 得到的列name的值为’张三’</p>
<h1 id="Transaction-10-1"><a href="#Transaction-10-1" class="headerlink" title="Transaction 10"></a>Transaction 10</h1><p>BEGIN;<br>UPDATE student SET name=”李四” WHERE id=1;<br>UPDATE student SET name=”王五” WHERE id=1;<br>COMMIT;</p>
<h1 id="Transaction-20-1"><a href="#Transaction-20-1" class="headerlink" title="Transaction 20"></a>Transaction 20</h1><p>BEGIN;</p>
<h1 id="更新了一些别的表的记录-1"><a href="#更新了一些别的表的记录-1" class="headerlink" title="更新了一些别的表的记录"></a>更新了一些别的表的记录</h1><p>…<br>UPDATE student SET name=”钱七” WHERE id=1;<br>UPDATE student SET name=”宋八” WHERE id=1;<br>然后再到刚才使用READ COMMITTED 隔离级别的事务中继续查找这个id 为1 的记录，如下：<br>5.2 REPEATABLE READ隔离级别下<br>使用REPEATABLE READ 隔离级别的事务来说，只会在第一次执行查询语句时生成一个ReadView ，之<br>后的查询就不会重复生成了。<br>比如，系统里有两个事务id 分别为10 、20 的事务在执行：<br>此刻，表student 中id 为1 的记录得到的版本链表如下所示：<br>假设现在有一个使用REPEATABLE READ 隔离级别的事务开始执行：</p>
<h1 id="使用READ-COMMITTED隔离级别的事务-1"><a href="#使用READ-COMMITTED隔离级别的事务-1" class="headerlink" title="使用READ COMMITTED隔离级别的事务"></a>使用READ COMMITTED隔离级别的事务</h1><p>BEGIN;</p>
<h1 id="SELECT1：Transaction-10、20均未提交"><a href="#SELECT1：Transaction-10、20均未提交" class="headerlink" title="SELECT1：Transaction 10、20均未提交"></a>SELECT1：Transaction 10、20均未提交</h1><p>SELECT * FROM student WHERE id = 1; # 得到的列name的值为’张三’</p>
<h1 id="SELECT2：Transaction-10提交，Transaction-20未提交"><a href="#SELECT2：Transaction-10提交，Transaction-20未提交" class="headerlink" title="SELECT2：Transaction 10提交，Transaction 20未提交"></a>SELECT2：Transaction 10提交，Transaction 20未提交</h1><p>SELECT * FROM student WHERE id = 1; # 得到的列name的值为’王五’</p>
<h1 id="Transaction-10-2"><a href="#Transaction-10-2" class="headerlink" title="Transaction 10"></a>Transaction 10</h1><p>BEGIN;<br>UPDATE student SET name=”李四” WHERE id=1;<br>UPDATE student SET name=”王五” WHERE id=1;</p>
<h1 id="Transaction-20-2"><a href="#Transaction-20-2" class="headerlink" title="Transaction 20"></a>Transaction 20</h1><p>BEGIN;</p>
<h1 id="更新了一些别的表的记录-2"><a href="#更新了一些别的表的记录-2" class="headerlink" title="更新了一些别的表的记录"></a>更新了一些别的表的记录</h1><p>…<br>之后，我们把事务id 为10 的事务提交一下，就像这样：<br>然后再到事务id 为20 的事务中更新一下表student 中id 为1 的记录：<br>此刻，表student 中id 为1 的记录的版本链长这样：<br>然后再到刚才使用REPEATABLE READ 隔离级别的事务中继续查找这个id 为1 的记录，如下：</p>
<h1 id="使用REPEATABLE-READ隔离级别的事务"><a href="#使用REPEATABLE-READ隔离级别的事务" class="headerlink" title="使用REPEATABLE READ隔离级别的事务"></a>使用REPEATABLE READ隔离级别的事务</h1><p>BEGIN;</p>
<h1 id="SELECT1：Transaction-10、20未提交-1"><a href="#SELECT1：Transaction-10、20未提交-1" class="headerlink" title="SELECT1：Transaction 10、20未提交"></a>SELECT1：Transaction 10、20未提交</h1><p>SELECT * FROM student WHERE id = 1; # 得到的列name的值为’张三’</p>
<h1 id="Transaction-10-3"><a href="#Transaction-10-3" class="headerlink" title="Transaction 10"></a>Transaction 10</h1><p>BEGIN;<br>UPDATE student SET name=”李四” WHERE id=1;<br>UPDATE student SET name=”王五” WHERE id=1;<br>COMMIT;</p>
<h1 id="Transaction-20-3"><a href="#Transaction-20-3" class="headerlink" title="Transaction 20"></a>Transaction 20</h1><p>BEGIN;</p>
<h1 id="更新了一些别的表的记录-3"><a href="#更新了一些别的表的记录-3" class="headerlink" title="更新了一些别的表的记录"></a>更新了一些别的表的记录</h1><p>…<br>UPDATE student SET name=”钱七” WHERE id=1;<br>UPDATE student SET name=”宋八” WHERE id=1;</p>
<h1 id="使用REPEATABLE-READ隔离级别的事务-1"><a href="#使用REPEATABLE-READ隔离级别的事务-1" class="headerlink" title="使用REPEATABLE READ隔离级别的事务"></a>使用REPEATABLE READ隔离级别的事务</h1><p>BEGIN;</p>
<h1 id="SELECT1：Transaction-10、20均未提交-1"><a href="#SELECT1：Transaction-10、20均未提交-1" class="headerlink" title="SELECT1：Transaction 10、20均未提交"></a>SELECT1：Transaction 10、20均未提交</h1><p>SELECT * FROM student WHERE id = 1; # 得到的列name的值为’张三’</p>
<h1 id="SELECT2：Transaction-10提交，Transaction-20未提交-1"><a href="#SELECT2：Transaction-10提交，Transaction-20未提交-1" class="headerlink" title="SELECT2：Transaction 10提交，Transaction 20未提交"></a>SELECT2：Transaction 10提交，Transaction 20未提交</h1><p>SELECT * FROM student WHERE id = 1; # 得到的列name的值仍为’张三’<br>5.3 如何解决幻读<br>接下来说明InnoDB 是如何解决幻读的。<br>假设现在表 student 中只有一条数据，数据内容中，主键 id=1，隐藏的 trx_id=10，它的 undo log 如下图<br>所示。<br>假设现在有事务 A 和事务 B 并发执行， 事务 A 的事务 id 为 20 ， 事务 B 的事务 id 为 30 。<br>步骤1：事务 A 开始第一次查询数据，查询的 SQL 语句如下。<br>在开始查询之前，MySQL 会为事务 A 产生一个 ReadView，此时 ReadView 的内容如下： trx_ids=<br>[20,30] ， up_limit_id=20 ， low_limit_id=31 ， creator_trx_id=20 。<br>由于此时表 student 中只有一条数据，且符合 where id&gt;=1 条件，因此会查询出来。然后根据 ReadView<br>机制，发现该行数据的trx_id=10，小于事务 A 的 ReadView 里 up_limit_id，这表示这条数据是事务 A 开<br>启之前，其他事务就已经提交了的数据，因此事务 A 可以读取到。<br>结论：事务 A 的第一次查询，能读取到一条数据，id=1。<br>步骤2：接着事务 B(trx_id=30)，往表 student 中新插入两条数据，并提交事务。<br>此时表student 中就有三条数据了，对应的 undo 如下图所示：<br>步骤3：接着事务 A 开启第二次查询，根据可重复读隔离级别的规则，此时事务 A 并不会再重新生成<br>ReadView。此时表 student 中的 3 条数据都满足 where id&gt;=1 的条件，因此会先查出来。然后根据<br>ReadView 机制，判断每条数据是不是都可以被事务 A 看到。<br>1）首先 id=1 的这条数据，前面已经说过了，可以被事务 A 看到。<br>2）然后是 id=2 的数据，它的 trx_id=30，此时事务 A 发现，这个值处于 up_limit_id 和 low_limit_id 之<br>间，因此还需要再判断 30 是否处于 trx_ids 数组内。由于事务 A 的 trx_ids=[20,30]，因此在数组内，这表<br>示 id=2 的这条数据是与事务 A 在同一时刻启动的其他事务提交的，所以这条数据不能让事务 A 看到。<br>3）同理，id=3 的这条数据，trx_id 也为 30，因此也不能被事务 A 看见。<br>select * from student where id &gt;= 1;<br>insert into student(id,name) values(2,’李四’);<br>insert into student(id,name) values(3,’王五’);<br>结论：最终事务 A 的第二次查询，只能查询出 id=1 的这条数据。这和事务 A 的第一次查询的结果是一样<br>的，因此没有出现幻读现象，所以说在 MySQL 的可重复读隔离级别下，不存在幻读问题。<br>6. 总结<br>这里介绍了MVCC 在READ COMMITTD 、REPEATABLE READ 这两种隔离级别的事务在执行快照读操作时<br>访问记录的版本链的过程。这样使不同事务的读-写、写-读操作并发执行，从而提升系统性能。<br>核心点在于 ReadView 的原理， READ COMMITTD 、REPEATABLE READ 这两个隔离级别的一个很大不同<br>就是生成ReadView的时机不同：<br>READ COMMITTD 在每一次进行普通SELECT操作前都会生成一个ReadView<br>REPEATABLE READ 只在第一次进行普通SELECT操作前生成一个ReadView，之后的查询操作都重复<br>使用这个ReadView就好了。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/27/Spring-Boot-Starter%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/27/Spring-Boot-Starter%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">Spring-Boot-Starter详解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-01-27 22:51:06 / Modified: 22:57:07" itemprop="dateCreated datePublished" datetime="2022-01-27T22:51:06+08:00">2022-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SpringBoot/" itemprop="url" rel="index"><span itemprop="name">SpringBoot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/27/Starter%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/27/Starter%E8%AF%A6%E8%A7%A3/" class="post-title-link" itemprop="url">Starter详解</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2022-01-27 22:47:14 / Modified: 23:12:37" itemprop="dateCreated datePublished" datetime="2022-01-27T22:47:14+08:00">2022-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/SpringBoot/" itemprop="url" rel="index"><span itemprop="name">SpringBoot</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          
      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/26/Vim%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/26/Vim%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A/" class="post-title-link" itemprop="url">Vim必知必会</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-26 22:55:16" itemprop="dateCreated datePublished" datetime="2022-01-26T22:55:16+08:00">2022-01-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-27 10:15:36" itemprop="dateModified" datetime="2022-01-27T10:15:36+08:00">2022-01-27</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Vim/" itemprop="url" rel="index"><span itemprop="name">Vim</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>Vim 的设计目的是解放鼠标，用键盘完成所有的操作。</p>
<h1 id="Vim模式转换"><a href="#Vim模式转换" class="headerlink" title="Vim模式转换"></a>Vim模式转换</h1><p>想用好 Vim，先要理解 Vim 的模式转换。Vim 常用的模式有4种：</p>
<ol>
<li> <strong>普通模式</strong>：Vim 启动后的默认模式，用来移动光标、删除文本、覆盖输入文本、恢复操作、粘贴文本等等。</li>
<li> <strong>插入模式</strong>：输入 i 或 a 进入插入模式，在这个模式下敲击键盘会向文字缓冲区增加文字，相等于普通编辑器的编辑模式。</li>
<li> <strong>可视模式</strong>：选择文本，可以行选、块选和依次选择，选择后可以进行复制、删除、排序等操作。</li>
<li><strong>命令模式</strong>：执行内部和外部命令，通过 <code>“:” “/” “?” “:!”</code> 可以进入命令模式，分别对应的是：<ul>
<li>  <code>:</code>  执行内部命令</li>
<li>  <code>/</code>  向上搜索</li>
<li>  <code>?</code>  向下搜索</li>
<li>  <code>:!</code>  执行外部命令</li>
</ul>
</li>
</ol>
<h2 id="3-1-一般模式"><a href="#3-1-一般模式" class="headerlink" title="3.1    一般模式"></a>3.1    一般模式</h2><p>以 <code>vi/vim</code> 打开一个文档就直接进入一般模式了（这是<strong>默认的模式</strong>）。在这个模式中， 你可以使用『上下左右』按键来移动光标，你可以使用『删除字符』或『删除整行』来处理档案内容， 也可以使用『复制、粘贴』来处理你的文件数据。</p>
<blockquote>
<p>常用语法</p>
</blockquote>
<table>
<thead>
<tr>
<th align="center">语法</th>
<th>功能描述</th>
<th align="center">Demo</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>yy</code></td>
<td><strong>复制</strong>光标所在行（包括空行）</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><code>y数字y</code></td>
<td>复制一段（从光标所在的行开始复制几行[空行也算一行]）</td>
<td align="center"><code>y3y</code>：复制3行</td>
</tr>
<tr>
<td align="center"><code> p </code></td>
<td>从光标所在行开始进行<strong>粘贴</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><code> u </code></td>
<td><strong>撤销上一步</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><code> dd </code></td>
<td><strong>删除</strong>光标所在行</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><code> d数字d </code></td>
<td>删除光标（含）后多少行</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><code> x </code></td>
<td>删除一个字母，相当于del，<strong>向后删</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><code> X </code></td>
<td>删除一个字母，相当于Backspace，向前删</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><code> yw </code></td>
<td>复制一个词</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><code> dw </code></td>
<td>删除一个词</td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><code> ^ </code></td>
<td><strong>移动到行头</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><code> $ </code></td>
<td><strong>移动到行尾</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><code>  gg</code>或者<code>1+G  </code></td>
<td><strong>移动到页头</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><code> G </code></td>
<td><strong>移动到页尾</strong></td>
<td align="center"></td>
</tr>
<tr>
<td align="center"><code>数字+G</code>（先输入数字，在按G）</td>
<td><strong>移动到目标行</strong></td>
<td align="center"><code>6G</code>：移动到第6行</td>
</tr>
</tbody></table>
<h2 id="3-2-编辑模式"><a href="#3-2-编辑模式" class="headerlink" title="3.2    编辑模式"></a>3.2    编辑模式</h2><p><strong>在一般模式中可以进行删除、复制、粘贴等的动作，但是无法编辑文件内容</strong>！要等到你按下<code>『i, I, o, O, a, A』</code>等任何一个字母之后才会进入编辑模式。</p>
<p>通常在Linux中，按下这些按键时，在画面的左下方会出现『INSERT或 REPLACE』的字样，此时才可以进行编辑。而如果要回到一般模式时， 则必须要按下『Esc』键退出编辑模式。</p>
<blockquote>
<ol>
<li>进入编辑模式</li>
</ol>
</blockquote>
<table>
<thead>
<tr>
<th align="center">按键</th>
<th align="left">功能</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code> i </code></td>
<td align="left"><strong>当前光标前</strong></td>
</tr>
<tr>
<td align="center"><code> a </code></td>
<td align="left">当前光标后</td>
</tr>
<tr>
<td align="center"><code> o </code></td>
<td align="left"><strong>当前光标行的下一行</strong></td>
</tr>
<tr>
<td align="center"><code> I </code></td>
<td align="left">光标所在行最前</td>
</tr>
<tr>
<td align="center"><code> A </code></td>
<td align="left">光标所在行最后</td>
</tr>
<tr>
<td align="center"><code> O </code></td>
<td align="left">当前光标行的上一行</td>
</tr>
</tbody></table>
<blockquote>
<ol start="2">
<li>退出编辑模式</li>
</ol>
</blockquote>
<ul>
<li>按<code>『Esc』</code>键</li>
</ul>
<h2 id="3-3-命令模式"><a href="#3-3-命令模式" class="headerlink" title="3.3    命令模式"></a>3.3    命令模式</h2><p>在<strong>一般模式</strong>当中，输入<code>『 :  /  ?』</code>3个中的任何一个按钮，就可以将光标移动到最底下那一行。</p>
<p>在这个模式当中， 可以提供你『搜寻资料』的动作，而读取、存盘、大量取代字符、离开 vi 、显示行号等动作也是在此模式中实现的。</p>
<blockquote>
<ol>
<li>基本语法</li>
</ol>
</blockquote>
<p>表1-3</p>
<table>
<thead>
<tr>
<th align="center">命令</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code> :w </code></td>
<td><strong>保存</strong></td>
</tr>
<tr>
<td align="center"><code> :q </code></td>
<td><strong>退出</strong></td>
</tr>
<tr>
<td align="center"><code> :! </code></td>
<td><strong>强制执行</strong></td>
</tr>
<tr>
<td align="center"><code> : %s/old字符/new字符 </code></td>
<td><strong>批量替换</strong></td>
</tr>
<tr>
<td align="center"><code> / 要查找的词 </code></td>
<td>n 查找下一个，N 往上查找</td>
</tr>
<tr>
<td align="center"><code> ? 要查找的词 </code></td>
<td>n是查找上一个，N是往下查找</td>
</tr>
<tr>
<td align="center"><code> :set nu </code></td>
<td>显示行号</td>
</tr>
<tr>
<td align="center"><code> :set nonu </code></td>
<td>关闭行号</td>
</tr>
<tr>
<td align="center"><code>ZZ </code></td>
<td><strong>没有修改文件直接退出，如果修改了文件保存后退</strong>  <strong>去除高亮显示</strong></td>
</tr>
<tr>
<td align="center"><code>:nohl</code></td>
<td>去除高亮显示。在进行查找操作之后查找到的此会被高亮显示。<code>[no highlight]</code></td>
</tr>
</tbody></table>
<h2 id="3-4-模式间转换"><a href="#3-4-模式间转换" class="headerlink" title="3.4    模式间转换"></a>3.4    模式间转换</h2><p><img src="/2022/01/26/Vim%E5%BF%85%E7%9F%A5%E5%BF%85%E4%BC%9A/image-20210204110521292.png" alt="image-20210204110521292"></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/25/Azkaban/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/25/Azkaban/" class="post-title-link" itemprop="url">Azkaban</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-25 12:31:25" itemprop="dateCreated datePublished" datetime="2022-01-25T12:31:25+08:00">2022-01-25</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-01-26 22:21:49" itemprop="dateModified" datetime="2022-01-26T22:21:49+08:00">2022-01-26</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/Azkaban/" itemprop="url" rel="index"><span itemprop="name">Azkaban</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="第1章-Azkaban-概论"><a href="#第1章-Azkaban-概论" class="headerlink" title="第1章 Azkaban 概论"></a>第1章 Azkaban 概论</h1><h2 id="1-1-为什么需要工作流调度系统"><a href="#1-1-为什么需要工作流调度系统" class="headerlink" title="1.1 为什么需要工作流调度系统"></a>1.1 为什么需要工作流调度系统</h2><ol>
<li><p>一个完整的数据分析系统通常都是由大量任务单元组成：</p>
<p> Shell 脚本程序，Java 程序，MapReduce 程序、Hive 脚本等。</p>
</li>
<li><p> 各任务单元之间存在时间先后及前后依赖关系</p>
</li>
<li><p> 为了很好地组织起这样的复杂执行计划，需要一个工作流调度系统来调度执行；</p>
</li>
</ol>
<p><img src="/2022/01/25/Azkaban/image-20220125123407206.png" alt="image-20220125123407206"></p>
<hr>
<h2 id="1-2-常见工作流调度系统"><a href="#1-2-常见工作流调度系统" class="headerlink" title="1.2 常见工作流调度系统"></a>1.2 常见工作流调度系统</h2><ol>
<li> 简单的任务调度：直接使用 Linux 的 Crontab 来定义；</li>
<li> 复杂的任务调度：开发调度平台或使用现成的开源调度系统，比如 Ooize、Azkaban、Airflow、DolphinScheduler 等。</li>
</ol>
<hr>
<h2 id="1-3-Azkaban-与Oozie-对比"><a href="#1-3-Azkaban-与Oozie-对比" class="headerlink" title="1.3 Azkaban 与Oozie 对比"></a>1.3 Azkaban 与Oozie 对比</h2><p>总体来说，Ooize 相比 Azkaban 是一个重量级的任务调度系统，功能全面，但配置使用也更复杂。如果可以不在意某些功能的缺失，轻量级调度器 Azkaban 是很不错的候选对象。</p>
<hr>
<h1 id="第2章-Azkaban-入门"><a href="#第2章-Azkaban-入门" class="headerlink" title="第2章 Azkaban 入门"></a>第2章 Azkaban 入门</h1><h2 id="2-1-Azkaban-基本架构"><a href="#2-1-Azkaban-基本架构" class="headerlink" title="2.1 Azkaban 基本架构"></a>2.1 Azkaban 基本架构</h2><ol>
<li><strong>Azkaban Web Server</strong><ul>
<li>  项目管理/用户管理/权限管理</li>
<li>  任务的定时和触发</li>
<li>  UI界面</li>
</ul>
</li>
<li><strong>Azkaban Executor Server</strong><ul>
<li>  具体任务的执行</li>
</ul>
</li>
<li><strong>MySQL</strong><ul>
<li>  存储工作流程配置、定时规则、以及任务的执行状态等数据</li>
</ul>
</li>
</ol>
<h2 id="2-2-Azkaban-部署模式"><a href="#2-2-Azkaban-部署模式" class="headerlink" title="2.2 Azkaban 部署模式"></a>2.2 Azkaban 部署模式</h2><ol>
<li> <strong>单机模式</strong>：Web Server 和 Executor Server 部署在同一个服务器节点上。</li>
<li> <strong>集群模式</strong>：Web Server 和 Executor Server 分别位于不同的服务器节点上。集群模式支持部署多个 Executor Server 节点，起到负载均衡和容灾的作用。</li>
</ol>
<h2 id="2-3-集群模式安装"><a href="#2-3-集群模式安装" class="headerlink" title="2.3 集群模式安装"></a>2.3 集群模式安装</h2><h3 id="2-3-1-集群规划"><a href="#2-3-1-集群规划" class="headerlink" title="2.3.1 集群规划"></a>2.3.1 集群规划</h3><table>
<thead>
<tr>
<th>服务器节点</th>
<th>角色</th>
</tr>
</thead>
<tbody><tr>
<td>Hadoop102</td>
<td>Web Server/Executor Server</td>
</tr>
<tr>
<td>Hadoop103</td>
<td>Executor Server</td>
</tr>
<tr>
<td>Hadoop104</td>
<td>Executor Server</td>
</tr>
</tbody></table>
<h3 id="2-3-2-上传tar包"><a href="#2-3-2-上传tar包" class="headerlink" title="2.3.2 上传tar包"></a>2.3.2 上传tar包</h3><ol>
<li><p>将 <code>azkaban-db-3.84.4.tar.gz</code>、 <code>azkaban-exec-server-3.84.4.tar.gz</code>、 <code>azkaban-web-server-3.84.4.tar.gz</code> 上传到 hadoop102 的 <code>opt/software/azkaban</code> 路径下。</p>
<ul>
<li>   <code>azkaban-exec-server.*</code> 是 Web Server 的安装包；</li>
<li>  <code>azkaban-web-server.*</code> 是 Executor Server 的安装包；</li>
<li>  <code>azkaban-db.*</code>：Azkaban 在运行时会用到 MySQL，需要提前在 MySQL 中创建好 Azkaban 所用到的库和表，该压缩包就是一个 SQL 脚本文件，里面是对应的建库和建表语句。 </li>
</ul>
</li>
<li><p>新建 <code>/opt/module/azkaban</code> 目录，并将所有 tar 包解压到该目录下。</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[lvnengdong@hadoop102 module]$ tar -zxvf /opt/software/azkaban/azkaban-db-3.84.4.tar.gz -C /opt/module/azkaban/</span><br><span class="line"></span><br><span class="line">[lvnengdong@hadoop102 module]$ tar -zxvf /opt/software/azkaban/azkaban-exec-server-3.84.4.tar.gz -C /opt/module/azkaban/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[lvnengdong@hadoop102 module]$ tar -zxvf /opt/software/azkaban/azkaban-web-server-3.84.4.tar.gz -C /opt/module/azkaban/</span><br></pre></td></tr></table></figure></li>
<li><p>进入到 <code>opt/module/azkaban</code> 目录，依次修改名称</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[lvnengdong@hadoop102 azkaban]$ <span class="built_in">mv</span> azkaban-exec-server-3.84.4/ azkaban-exec</span><br><span class="line">[lvnengdong@hadoop102 azkaban]$ <span class="built_in">mv</span> azkaban-web-server-3.84.4/ azkaban-web</span><br></pre></td></tr></table></figure></li>
</ol>
<h3 id="2-3-3-配置-MySQL"><a href="#2-3-3-配置-MySQL" class="headerlink" title="2.3.3 配置 MySQL"></a>2.3.3 配置 MySQL</h3><ol>
<li><p> 正常安装 MySQL。</p>
</li>
<li><p>启动MySQL服务 ==&gt; 登录MySQL ==&gt; 创建 azkaban 数据库</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 1、启动MySQL</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 2、登录MySQL</span></span><br><span class="line">[lvnengdong@hadoop102 azkaban]$ mysql -uroot -p123456</span><br><span class="line"></span><br><span class="line"><span class="comment"># 3、创建 azkaban 数据库</span></span><br><span class="line">mysql&gt; create database azkaban;	</span><br></pre></td></tr></table></figure></li>
<li><p>创建 azkaban 用户并赋予权限（如果直接使用 root 用户操作可以跳过这一步）</p>
<ul>
<li><p>设置密码有效长度 4 位及以上</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global validate_password_length=4;</span><br></pre></td></tr></table></figure></li>
<li><p>设置密码策略最低级别</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; set global validate_password_policy=0;</span><br></pre></td></tr></table></figure></li>
<li><p>创建 azkaban 用户，任何主机都可以访问 azkaban ，密码是 123456</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE USER &#x27;azkaban&#x27;@&#x27;%&#x27; IDENTIFIED BY &#x27;123456&#x27;;</span><br></pre></td></tr></table></figure></li>
<li><p>赋予 azkaban 用户增删改查权限</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; GRANT SELECT,INSERT,UPDATE,DELETE ON azkaban.* to &#x27;azkaban&#x27;@&#x27;%&#x27; WITH GRANT OPTION;</span><br></pre></td></tr></table></figure></li>
</ul>
</li>
<li><p>执行解压后的数据库脚本文件，创建对应的数据库表，完成后退出 MySQL</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; use azkaban;</span><br><span class="line"></span><br><span class="line"># 执行脚本文件</span><br><span class="line">mysql&gt; source /opt/module/azkaban/azkaban-db-3.84.4/create-all-sql-3.84.4.sql</span><br><span class="line"></span><br><span class="line">mysql&gt; quit;</span><br></pre></td></tr></table></figure></li>
<li><p>更改 MySQL 包大小，防止 Azkaban 连接 MySQL 阻塞</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[lvnengdong@hadoop102 etc]$ sudo vim /etc/my.cnf</span><br></pre></td></tr></table></figure>

<p> 在在 <strong>[mysqld]</strong> 下面加一行 <strong>max_allowed_packet=1024M</strong>，该参数限制了 MySQL Client 向 MySQL Server 单次发送数据包大小的上限，默认为 1M，超过该值就会陷入阻塞。</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[mysqld]</span><br><span class="line">max_allowed_packet=1024M</span><br></pre></td></tr></table></figure></li>
<li><p>重启 MySQL</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[lvnengdong@hadoop102 etc]$ sudo systemctl restart mysqld</span><br></pre></td></tr></table></figure>

</li>
</ol>
<hr>
<h3 id="2-3-4-配置-Executor-Server"><a href="#2-3-4-配置-Executor-Server" class="headerlink" title="2.3.4 配置 Executor Server"></a>2.3.4 配置 Executor Server</h3><p>Azkaban Executor Server 负责处理工作流和作业的实际执行。</p>
<ol>
<li><p>编辑 <code>azkaban.properties</code> 配置文件</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[lvnengdong@hadoop102 /]$ vim /opt/module/azkaban/azkaban-exec/conf/azkaban.properties</span><br></pre></td></tr></table></figure>

<p> 修改部分属性：</p>
 <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认时区</span></span><br><span class="line"><span class="attr">default.timezone.id</span>=<span class="string">Asia/Shanghai</span></span><br><span class="line"><span class="comment"># Web Server 的 URL</span></span><br><span class="line"><span class="attr">azkaban.webserver.url</span>=<span class="string">http://hadoop102:8081</span></span><br><span class="line"><span class="comment"># 设置 executor 为固定端口（新添加）</span></span><br><span class="line"><span class="attr">executor.port</span>=<span class="string">12321</span></span><br><span class="line"><span class="comment"># MySQL相关配置</span></span><br><span class="line"><span class="attr">database.type</span>=<span class="string">mysql</span></span><br><span class="line"><span class="attr">mysql.port</span>=<span class="string">3306</span></span><br><span class="line"><span class="attr">mysql.host</span> =<span class="string">hadoop 102</span></span><br><span class="line"><span class="attr">mysql.database</span>=<span class="string">azkaban</span></span><br><span class="line"><span class="attr">mysql.user</span>=<span class="string">azkaban</span></span><br><span class="line"><span class="attr">mysql.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="attr">mysql.numconnections</span>=<span class="string">100</span></span><br></pre></td></tr></table></figure></li>
<li><p>同步 <code>azkaban-exec</code> 到所有节点</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[lvnengdong@hadoop102 /]$ xsync /opt/module/azkaban/azkaban-exec/</span><br></pre></td></tr></table></figure></li>
<li><p>进入到 <code>opt/module/azkaban/azkaban-exec</code> 路径，分别在三台机器上启动 Executor<br> Server</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[lvnengdong@hadoop102 azkaban-exec]$ bin/start-exec.sh</span><br><span class="line">[lvnengdong@hadoop103 azkaban-exec]$ bin/start-exec.sh</span><br><span class="line">[lvnengdong@hadoop104 azkaban-exec]$ bin/start-exec.sh</span><br></pre></td></tr></table></figure>

<ul>
<li>  注意：如果在 <code>/opt/module/azkaban/azkaban-exec</code> 目录下出现 <code>executor.port</code> 文件，说明启动成功</li>
<li>  或者从 MySQL 的 azkaban 数据库的 executors 表中查询元数据信息，也能看到 Executor Server  节点信息。</li>
</ul>
<p> <img src="/2022/01/25/Azkaban/image-20220125221413005.png" alt="image-20220125221413005"></p>
<blockquote>
<p>  表中字段的含义：</p>
<ul>
<li>  port：端口号</li>
<li>  active：激活状态，0为未激活，1为已激活。</li>
</ul>
</blockquote>
</li>
<li><p>Executor Server 启动后还不能正常工作，还需要进行激活。激活步骤：向 Executor Server 提供的激活服务发送 GET 请求即可。</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Hadoop102</span></span><br><span class="line">[lvnengdong@hadoop102 azkaban-exec]$ curl -G <span class="string">&quot;hadoop102:12321/executor?action=activate&quot;</span> &amp;&amp; <span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hadoop103</span></span><br><span class="line">[lvnengdong@hadoop103 azkaban-exec]$ curl -G <span class="string">&quot;hadoop103:12321/executor?action=activate&quot;</span> &amp;&amp; <span class="built_in">echo</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Hadoop104</span></span><br><span class="line">[lvnengdong@hadoop104 azkaban-exec]$ curl -G <span class="string">&quot;hadoop104:12321/executor?action=activate&quot;</span> &amp;&amp; <span class="built_in">echo</span></span><br></pre></td></tr></table></figure>

<p> 若三台机器都出现提示：<code>&#123;&quot;status&quot;:&quot;success&quot;&#125;</code>，则表示激活成功。</p>
</li>
</ol>
<hr>
<h3 id="2-3-5-配置-Web-Server"><a href="#2-3-5-配置-Web-Server" class="headerlink" title="2.3.5 配置 Web Server"></a>2.3.5 配置 Web Server</h3><p>Azkaban Web Server 主要负责：项目管理，身份验证，计划和执行触发。</p>
<ol>
<li><p>编辑配置文件：<code>azkaban.properties</code></p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[atguigu@hadoop102 azkaban]$ vim /opt/module/ azkaban</span><br><span class="line">web /conf/azkaban.properties</span><br></pre></td></tr></table></figure>

<p> 修改如下属性</p>
 <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">default.timezone.id</span>=<span class="string">Asia/Shanghai</span></span><br><span class="line"><span class="attr">database.type</span>=<span class="string">mysql</span></span><br><span class="line"><span class="attr">mysql.port</span>=<span class="string">3306</span></span><br><span class="line"><span class="attr">mysql.host</span> =<span class="string">hadoop102</span></span><br><span class="line"><span class="attr">mysql.database</span>=<span class="string">azkaban</span></span><br><span class="line"><span class="attr">mysql.user</span>=<span class="string">azkaban</span></span><br><span class="line"><span class="attr">mysql.password</span>=<span class="string">123456</span></span><br><span class="line"><span class="attr">mysql.numconnections</span>=<span class="string">100</span></span><br><span class="line"><span class="attr">azkaban.executorselector.filters</span>=<span class="string">StaticRemainingFlowSize,CpuStatus</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>  azkaban.executorselector.filters 属性说明：该属性只在有多个 Executor 的情况下生效。当存在多个 Executor 时，具体某个任务由哪个 Executor 执行由任务调度策略决定。 </p>
<ul>
<li>  StaticRemainingFlowSize：该策略是基于正在排队的任务数，哪个 Executor 当前的任务数最少优先拾取新任务。</li>
<li>  CpuStatus：根据 CPU 占用情况拾取任务，剩余性能更多的优先拾取任务。</li>
<li>  MinimumFreeMemory：根据内存占用情况拾取任务，剩余内存更多的优先拾取任务。默认情况下，当服务器节点的剩余内存不足 6G 时就不再拾取任务，所以在测试环境下，必须将 MinimumFreeMemory 删除掉，否则它会认为集群资源不够而不执行任务。</li>
</ul>
</blockquote>
</li>
<li><p>修改 <code>azkaban-users.xml</code> 文件，添加 lvnengdong 用户</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[lvnengdong@hadoop102 azkaban-exec]$ vim /opt/module/azkaban/azkaban-web/conf/azkaban-users.xml</span><br></pre></td></tr></table></figure>

<p> 修改文件内容为：</p>
 <figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">azkaban-users</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">user</span> <span class="attr">groups</span>=<span class="string">&quot;azkaban&quot;</span> <span class="attr">password</span>=<span class="string">&quot;azkaban&quot;</span> <span class="attr">roles</span>=<span class="string">&quot;admin&quot;</span> <span class="attr">username</span>=<span class="string">&quot;azkaban&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">user</span> <span class="attr">password</span>=<span class="string">&quot;metrics&quot;</span> <span class="attr">roles</span>=<span class="string">&quot;metrics&quot;</span> <span class="attr">username</span>=<span class="string">&quot;metrics&quot;</span>/&gt;</span></span><br><span class="line">    <span class="comment">&lt;!-- 新增一个自定义用户 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">user</span> <span class="attr">password</span>=<span class="string">&quot;123456&quot;</span> <span class="attr">roles</span>=<span class="string">&quot;admin&quot;</span> <span class="attr">username</span>=<span class="string">&quot;lvnengdong&quot;</span>/&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">role</span> <span class="attr">name</span>=<span class="string">&quot;admin&quot;</span> <span class="attr">permissions</span>=<span class="string">&quot;ADMIN&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">role</span> <span class="attr">name</span>=<span class="string">&quot;metrics&quot;</span> <span class="attr">permissions</span>=<span class="string">&quot;METRICS&quot;</span>/&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">azkaban-users</span>&gt;</span></span><br></pre></td></tr></table></figure>

</li>
<li><p>进入到 hadoop102 的 <code>/opt/module/azkaban/azkaban-web</code> 路径， 启动 Web Server 服务</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[lvnengdong@hadoop102 azkaban-web]$ bin/start-web.sh</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用 JPS 查看启动状态</span></span><br><span class="line">[lvnengdong@hadoop102 azkaban-web]$ jps</span><br><span class="line">15379 AzkabanWebServer</span><br></pre></td></tr></table></figure>

</li>
<li><p>访问 <a target="_blank" rel="noopener" href="http://hadoop102:8081/">http://hadoop102:8081</a> ，并使用 lvnengdong 用户登陆</p>
<p> <img src="/2022/01/25/Azkaban/image-20220125224154284.png" alt="image-20220125224154284"></p>
</li>
</ol>
<hr>
<h2 id="2-4-Work-Flow-入门案例"><a href="#2-4-Work-Flow-入门案例" class="headerlink" title="2.4 Work Flow 入门案例"></a>2.4 Work Flow 入门案例</h2><h3 id="2-4-1-HelloWorld-案例"><a href="#2-4-1-HelloWorld-案例" class="headerlink" title="2.4.1 HelloWorld 案例"></a>2.4.1 HelloWorld 案例</h3><ol>
<li><p>创建描述工作流程的文件</p>
<ul>
<li><p>在 Windows 环境下，新建 <code>my_first_demo.project</code> 文件，编辑内容如下：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">azkaban-flow-version: 2.0</span><br></pre></td></tr></table></figure></li>
<li><p>新建 <code>my_first_demo.flow</code> 文件，编辑内容如下：</p>
  <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodes:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jobA</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">config:</span> </span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">&quot;Hello World&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<ol>
<li> Name：job名称</li>
<li> Type：job类型。command 表示待执行的job的方式为命令</li>
<li> config：job配置</li>
</ol>
</blockquote>
</li>
<li><p>  将 <code>my_first_demo.project</code> 和 <code>my_first_demo.flow</code> 文件压缩到一个 zip 文件中，文件名称必须是英文，我这里起名为 ``my_first_demo.zip`。该压缩包就是工作流程的描述文件。</p>
</li>
</ul>
</li>
<li><p>在 WebServer 新建项目： <a target="_blank" rel="noopener" href="http://hadoop102:8081/index">http://hadoop102:8081/index</a></p>
<p> <img src="/2022/01/25/Azkaban/image-20220126113158617.png" alt="image-20220126113158617"></p>
</li>
<li><p>给项目命名、添加项目描述</p>
<p> <img src="/2022/01/25/Azkaban/image-20220126113351345.png" alt="image-20220126113351345"></p>
</li>
<li><p>创建项目成功后，上传工作流程的描述文件zip</p>
<p> <img src="/2022/01/25/Azkaban/image-20220126113713009.png" alt="image-20220126113713009"></p>
<p> Azkaban 在上传 zip 包时会校验描述文件的语法格式，只有在语法无误的情况下才能上传成功。也就是说，如果上传成功了，那么语法一定是正确的。</p>
</li>
<li><p>上传成功后，执行任务流</p>
<p> <img src="/2022/01/25/Azkaban/image-20220126114313834.png" alt="image-20220126114313834"></p>
<ul>
<li>  工作流程图：当前流程只有一个Job，即JobA</li>
</ul>
<p> <img src="/2022/01/25/Azkaban/image-20220126114348471.png" alt="image-20220126114348471"></p>
<blockquote>
<ul>
<li>  Execute：当前 Job 会立即执行且只执行一次</li>
<li>  Schedule：定时调度</li>
</ul>
</blockquote>
<ul>
<li>  以 Excute 的方式执行</li>
</ul>
<p> <img src="/2022/01/25/Azkaban/image-20220126114415573.png" alt="image-20220126114415573"></p>
<p> <img src="/2022/01/25/Azkaban/image-20220126114436888.png" alt="image-20220126114436888"></p>
</li>
<li><p>在日志中，查看运行结果</p>
<p> <img src="/2022/01/25/Azkaban/image-20220126114528652.png" alt="image-20220126114528652"></p>
<p> <img src="/2022/01/25/Azkaban/image-20220126114707764.png" alt="image-20220126114707764"></p>
</li>
</ol>
<hr>
<h3 id="2-4-2-配置文件编写规则"><a href="#2-4-2-配置文件编写规则" class="headerlink" title="2.4.2 配置文件编写规则"></a>2.4.2 配置文件编写规则</h3><ul>
<li><p><code>xxx.project</code>：固定写法，声明 azkaban-flow 的版本。在1.0版本中使用 properties，在2.0版本中使用 yaml。</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">azkaban-flow-version: &#123;1.0 | 2.0&#125;</span><br></pre></td></tr></table></figure></li>
<li><p><code>xxx.flow</code>：用于描述具体工作流程的配置文件。支持 properties 和 yaml 两种语法格式，azkaban-flow 1.0 支持的是 properties 语法，2.0 支持的是 yaml 语法格式。</p>
</li>
</ul>
<hr>
<h3 id="2-4-3-作业依赖案例"><a href="#2-4-3-作业依赖案例" class="headerlink" title="2.4.3 作业依赖案例"></a>2.4.3 作业依赖案例</h3><p><strong>需求：</strong>JobA 和 JobB 执行完了，才能执行 JobC</p>
<p><strong>具体步骤：</strong></p>
<ol>
<li><p>创建工作流描述文件</p>
<ul>
<li><p>  拷贝 <code>my_first_demo.project</code> 文件重命名为 <code>my_second_demo.project</code></p>
</li>
<li><p>新建 <code>my_second_demo.flow</code> 文件，编辑内容如下：</p>
  <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jobC</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="comment"># jobC 依赖 jobA 和 jobB</span></span><br><span class="line">    <span class="attr">dependsOn:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">jobA</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">jobB</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">&quot;I am JobC&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jobA</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">&quot;I am JobA&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jobB</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">&quot;I am JobB&quot;</span></span><br></pre></td></tr></table></figure>

<blockquote>
<p>  在 yaml 中，<code>-</code> 表示数组中的一个元素</p>
</blockquote>
</li>
</ul>
</li>
<li><p> 将两个工作流描述文件压缩成 zip 包</p>
</li>
<li><p>在 Web Server 中：新建项目 ==&gt; 上传flow ==&gt; 执行flow</p>
<p> 工作流程图：jobA 和 jobB 都执行完成之后，才能执行 jobC</p>
<p> <img src="/2022/01/25/Azkaban/image-20220126135606672.png" alt="image-20220126135606672"></p>
<p> 通过时间线我们可以看到，jobA 和 jobB 是并行执行的，而 jobC 则是在 jobA 和 jobB 执行完成之后才执行的。</p>
<p> <img src="/2022/01/25/Azkaban/image-20220126143304512.png" alt="image-20220126143304512"></p>
</li>
</ol>
<hr>
<h3 id="2-4-4-自动失败重试案例"><a href="#2-4-4-自动失败重试案例" class="headerlink" title="2.4.4 自动失败重试案例"></a>2.4.4 自动失败重试案例</h3><p><strong>语法：</strong></p>
<p>在 node.config 属性下增加以下两个配置参数即可。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JobA</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">xxx</span></span><br><span class="line">      <span class="comment"># 重试次数</span></span><br><span class="line">      <span class="attr">retries:</span> <span class="number">3</span></span><br><span class="line">      <span class="comment"># 每次重试的时间间隔（单位：ms）</span></span><br><span class="line">      <span class="attr">retry.backoff:</span> <span class="number">5000</span></span><br></pre></td></tr></table></figure>



<p><strong>需求：</strong>如果执行任务失败，自动重试 3 次，重试的时间间隔 10000ms</p>
<p><strong>具体步骤：</strong></p>
<ol>
<li><p> 执行上面的工作流，因为 command 是一个不存在的命令，所以必然会执行失败。</p>
</li>
<li><p>查看 Job 执行的时间线，发现该任务单元总共执行了四次，重试了三次后宣布失败。</p>
<p> <img src="/2022/01/25/Azkaban/image-20220126144747392.png" alt="image-20220126144747392"></p>
<p> 查看日志也能发现总共执行了四次</p>
<p> <img src="/2022/01/25/Azkaban/image-20220126145022109.png" alt="image-20220126145022109"></p>
</li>
</ol>
<hr>
<h3 id="2-4-5-手动失败重试案例"><a href="#2-4-5-手动失败重试案例" class="headerlink" title="2.4.5 手动失败重试案例"></a>2.4.5 手动失败重试案例</h3><p><strong>是什么：</strong>某个工作流程执行成功乐一部分，在失败后手动重试时，把已完成的 Job 跳过，从上次失败的 Job 开始重新执行。</p>
<p><strong>需求：</strong>JobA =&gt; JobB（依赖于 A）=&gt; JobC =&gt; JobD =&gt; JobE =&gt; JobF。生产环境下，任何 Job 都有可能挂掉，可以根据需求执行想要执行的 Job。</p>
<p><strong>具体步骤：</strong></p>
<ol>
<li><p>编写工作流描述文件：<code>four.flow</code> </p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JobA</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">&quot;This is JobA.&quot;</span></span><br><span class="line">    </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JobB</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">dependsOn:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JobA</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">&quot;This is JobB.&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JobC</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">dependsOn:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JobB</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">&quot;This is JobC.&quot;</span></span><br><span class="line">      </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JobD</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">dependsOn:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JobC</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">&quot;This is JobD.&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JobE</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">dependsOn:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JobD</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">&quot;This is JobE.&quot;</span></span><br><span class="line">  </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JobF</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">dependsOn:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JobE</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">echo</span> <span class="string">&quot;This is JobF.&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p>打包 =&gt; 上传 =&gt; 生成工作流程图</p>
<p> <img src="/2022/01/25/Azkaban/image-20220126150931478.png" alt="image-20220126150931478"></p>
</li>
<li><p>手动失败重试。</p>
<p> <strong>方式一</strong>：<code>History =&gt; Flow =&gt; Prepare Execution</code>：自动跳过成功的 Job，从上次失败的 Job 开始重新执行 Flow。 </p>
<p> <img src="/2022/01/25/Azkaban/image-20220126151515522.png" alt="image-20220126151515522"></p>
<p> <img src="/2022/01/25/Azkaban/image-20220126151608652.png" alt="image-20220126151608652"></p>
<p> <strong>方式二：</strong>手动忽略。在执行 Flow 之前手动选择不希望执行的 Job 进行忽略。</p>
<p> <img src="/2022/01/25/Azkaban/image-20220126152050666.png" alt="image-20220126152050666"></p>
</li>
</ol>
<hr>
<h1 id="第3章-Azkaban-进阶"><a href="#第3章-Azkaban-进阶" class="headerlink" title="第3章 Azkaban 进阶"></a>第3章 Azkaban 进阶</h1><blockquote>
<ol>
<li> Azkaban支持的任务类型：</li>
<li> 条件工作流</li>
<li> 定时执行</li>
<li> 邮件报警/电话报警</li>
</ol>
</blockquote>
<h2 id="3-1-Azkaban支持的任务类型"><a href="#3-1-Azkaban支持的任务类型" class="headerlink" title="3.1 Azkaban支持的任务类型"></a>3.1 Azkaban支持的任务类型</h2><p>任务类型是 Job 的一个描述信息，在配置文件中使用 <code>node.type</code> 属性来指定。Azkaban 内置了两种任务类型：</p>
<ol>
<li> <strong>command</strong>：将 Job 编写成 shell 命令或脚本，通过执行 shell 命令来执行 Job。</li>
<li> <strong>JavaProcess</strong>：将 Job 封装成一个 Java 程序，通过执行 Java 进程来执行 Job。</li>
</ol>
<p>在大数据开发中，绝大多数的 Job 都可以使用 command 来完成，包括 HQL、MapReduce、Spark任务、Flink任务等都可以封装到一个 shell 脚本中。</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodes:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">jobA</span></span><br><span class="line">    <span class="attr">type:</span>  &#123;<span class="string">command</span> <span class="string">|</span> <span class="string">javaprocess</span> &#125;</span><br></pre></td></tr></table></figure>







<h2 id="3-2-JavaProcess-作业类型案例"><a href="#3-2-JavaProcess-作业类型案例" class="headerlink" title="3.2 JavaProcess 作业类型案例"></a>3.2 JavaProcess 作业类型案例</h2><p>JavaProcess 类型可以运行一个自定义主类方法，<code>type</code> 类型为 <code>javaprocess</code>，可用的子配置信息有：</p>
<ul>
<li>  <strong>Xms</strong>：最小的堆内存</li>
<li>  <strong>Xmx</strong>：最大的堆内存</li>
<li>  <strong>classpath</strong>：jar包所在路径。<strong>类路径可以省略，缺省值是 .flow 文件的当前路径</strong>。所以说如果 jar 包与 .flow 文件处于同一级目录下，可以不用显式指定该值。</li>
<li>  <strong>java.class</strong>：jar包中主类（包含 Main 方法的类）的全限定类名。</li>
<li>  <strong>main.args</strong>：main方法的参数。多个参数之间用空格分隔。</li>
</ul>
<p><strong>案例：</strong></p>
<ol>
<li><p> 新建一个 maven 项目，命名为 azkaban。</p>
</li>
<li><p>创建 AzTest 类</p>
 <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> lnd</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Date</span> 2022/1/26 17:21</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Version</span> 1.0</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">AzTest</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        System.out.println(<span class="string">&quot;Azkaban JavaProcess Test！&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li><p> 打成jar包：<code>azkaban-1.0-SNAPSHOT.jar</code> </p>
</li>
<li><p>新建 <code>test_java.flow</code></p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">test_java</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">javaprocess</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">Xms:</span> <span class="string">128M</span></span><br><span class="line">      <span class="attr">Xmx:</span> <span class="string">128M</span></span><br><span class="line">      <span class="attr">java.class:</span> <span class="string">com.example.AzTest</span></span><br></pre></td></tr></table></figure>

</li>
<li><p> 将 Jar 包、 flow 文件和 project 文件压缩为 javatest.zip</p>
</li>
<li><p>创建项目 =&gt; 上传 javatest.zip =&gt; 执行作业 =&gt; 观察结果</p>
<p> <img src="/2022/01/25/Azkaban/image-20220126173205145.png" alt="image-20220126173205145"></p>
</li>
</ol>
<hr>
<h2 id="3-3-条件工作流"><a href="#3-3-条件工作流" class="headerlink" title="3.3 条件工作流"></a>3.3 条件工作流</h2><p>条件工作流允许用户自定义执行条件来决定是否运行某些 Job。</p>
<p>条件可以由当前 Job 的父 Job 输出的运行时参数构成，也可以使用预定义宏。在这些条件下，用户可以在确定 Job 执行逻辑时获得更大的灵活性。例如，只要父 Job 之一成功，就可以运行当前 Job。</p>
<blockquote>
<ul>
<li>  父Job的运行时参数：比如 jobB 依赖于 jobA，jobB 是否执行取决于 jobA 执行完成后输出的参数，这就叫做父Job输出的运行时参数。</li>
<li>  预定义宏：预定义宏是指 Azkaban 内置的一些判断条件表达式。</li>
</ul>
</blockquote>
<h3 id="3-3-1-运行时参数案例"><a href="#3-3-1-运行时参数案例" class="headerlink" title="3.3.1 运行时参数案例"></a>3.3.1 运行时参数案例</h3><h4 id="一、基本原理"><a href="#一、基本原理" class="headerlink" title="一、基本原理"></a>一、基本原理</h4><ol>
<li><p> 父 Job 将输出参数写入 <strong>JOB_OUTPUT_PROP_FILE</strong> 环境变量所指向的文件。</p>
</li>
<li><p>子 Job 使用 <code>$&#123;jobName:param&#125;</code> 来获取文件中父 Job 输出的参数并定义执行条件。</p>
<blockquote>
<p>  每个 Job 对应会生成一个文件，子 Job 可以通过 <strong>父Job名+参数名</strong> 获取父 Job 文件中对应参数的值。</p>
</blockquote>
</li>
</ol>
<h4 id="二、支持的条件运算符："><a href="#二、支持的条件运算符：" class="headerlink" title="二、支持的条件运算符："></a>二、支持的条件运算符：</h4><table>
<thead>
<tr>
<th align="center"></th>
<th align="left"></th>
</tr>
</thead>
<tbody><tr>
<td align="center"><code>==</code></td>
<td align="left">等于</td>
</tr>
<tr>
<td align="center"><code>!=</code></td>
<td align="left">不等于</td>
</tr>
<tr>
<td align="center"><code>&gt;</code></td>
<td align="left">大于</td>
</tr>
<tr>
<td align="center"><code>&gt;=</code></td>
<td align="left">大于等于</td>
</tr>
<tr>
<td align="center"><code>&lt;</code></td>
<td align="left">小于</td>
</tr>
<tr>
<td align="center"><code>&lt;=</code></td>
<td align="left">小于等于</td>
</tr>
<tr>
<td align="center"><code>&amp;&amp;</code></td>
<td align="left">与</td>
</tr>
<tr>
<td align="center">`</td>
<td align="left"></td>
</tr>
<tr>
<td align="center"><code>!</code></td>
<td align="left">非</td>
</tr>
</tbody></table>
<h4 id="三、案例"><a href="#三、案例" class="headerlink" title="三、案例"></a>三、案例</h4><p><strong>需求：</strong></p>
<ul>
<li>  JobA 执行一个 shell 脚本。</li>
<li>  JobB 执行一个 shell 脚本，但 JobB 不需要每天都执行，而只需要每个周一执行。</li>
</ul>
<p><strong>实现：</strong></p>
<ol>
<li><p>新建 JobA.sh</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;do JobA&quot;</span></span><br><span class="line"><span class="comment"># 输出当前日期是周几</span></span><br><span class="line">wk=`<span class="built_in">date</span> +%w`</span><br><span class="line"><span class="comment"># 将 wk 写出到指定目录下的文件中</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;&#123;\&quot;wk\&quot;:<span class="variable">$wk</span>&#125;&quot;</span> &gt; <span class="variable">$JOB_OUTPUT_PROP_FILE</span></span><br></pre></td></tr></table></figure>

</li>
<li><p>新建 JobB.sh</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;do JobB&quot;</span></span><br></pre></td></tr></table></figure>

</li>
<li><p>新建 <code>condition.flow</code></p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JobA</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">     <span class="attr">command:</span> <span class="string">sh</span> <span class="string">JobA.sh</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JobB</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">dependsOn:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JobA</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">sh</span> <span class="string">JobB.sh</span></span><br><span class="line">    <span class="comment"># 拿到 JobA.wk 变量，只有值等于1的时候才执行JobB</span></span><br><span class="line">    <span class="attr">condition:</span> <span class="string">$&#123;JobA:wk&#125;</span> <span class="string">==</span> <span class="number">1</span></span><br></pre></td></tr></table></figure></li>
<li><p> 将 JobA.sh、JobB.sh、condition.flow 和 azkaban.project 打包成 condition.zip</p>
</li>
<li><p> 创建 condition 项目 =&gt; 上传 condition.zip文件 =&gt; 执行作业 =&gt; 观察结果</p>
</li>
<li><p>按照我们设定的条件， JobB 会根据当日日期决定是否执行。</p>
 <img src="/2022/01/25/Azkaban/image-20220126195508740.png" alt="image-20220126195508740" style="zoom:50%;"></li>
</ol>
<hr>
<h3 id="3-3-2-预定义宏案例"><a href="#3-3-2-预定义宏案例" class="headerlink" title="3.3.2 预定义宏案例"></a>3.3.2 预定义宏案例</h3><p>Azkaban 中预置了几个特殊的判断条件，称为预定义宏。</p>
<p>预定义宏会根据所有父 Job 的完成情况进行判断，再决定是否执行。可用的预定义宏有：</p>
<ol>
<li><p> <strong>all_success</strong>：表示父 Job 全部成功才执行(默认执行逻辑)</p>
</li>
<li><p><strong>all_done</strong>：表示父 Job 全部完成才执行。</p>
<blockquote>
<p>  “完成”是指：不管父Job是否成功，只要执行结束了子Job就可以执行。</p>
</blockquote>
</li>
<li><p> <strong>all_failed</strong>：表示父 Job 全部失败才执行</p>
</li>
<li><p> <strong>one_success</strong>：表示父 Job 只要成功一个就执行</p>
</li>
<li><p> <strong>one_failed</strong>：表示父 Job 至少一个失败才执行</p>
</li>
</ol>
<h4 id="案例"><a href="#案例" class="headerlink" title="案例"></a>案例</h4><p><strong>需求：</strong></p>
<ul>
<li>  JobA 执行一个 shell 脚本</li>
<li>  JobB 执行一个 shell 脚本</li>
<li>  JobC 执行一个 shell 脚本，要求 JobA、 JobB 中至少有一个成功才执行 JobC</li>
</ul>
<p><strong>实现：</strong></p>
<ol>
<li><p>新建 JobA.sh</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;do JobA&quot;</span></span><br></pre></td></tr></table></figure></li>
<li><p>  新建 JobC.sh</p>
</li>
</ol>
<pre><code><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">&quot;do JobC&quot;</span></span><br></pre></td></tr></table></figure>
</code></pre>
<ol start="3">
<li><p> 无需创建 JobB.sh，因为 A 和 B 只要有一个成功 C 就可以执行了。</p>
</li>
<li><p>新建 macro.flow</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JobA</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">sh</span> <span class="string">JobA.sh</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JobB</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">sh</span> <span class="string">JobB.sh</span></span><br><span class="line"></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">JobC</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">dependsOn:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JobA</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">JobB</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">sh</span> <span class="string">JobC.sh</span></span><br><span class="line">    <span class="attr">condition:</span> <span class="string">one_success</span></span><br></pre></td></tr></table></figure></li>
<li><p> JobA.sh、JobC.sh、macro.flow、azkaban.project 文件打包成 macro.zip。</p>
</li>
<li><p>创建 macro 项目 =&gt; 上传 macro.zip文件 =&gt; 执行作业 =&gt; 观察结果</p>
 <img src="/2022/01/25/Azkaban/image-20220126201013836.png" alt="image-20220126201013836" style="zoom:67%;">

<p> 表示 JobA 执行成功，JobB 执行失败，但是 JobC 执行成功。</p>
</li>
</ol>
<hr>
<h3 id="3-3-3-定时执行案例"><a href="#3-3-3-定时执行案例" class="headerlink" title="3.3.3 定时执行案例"></a>3.3.3 定时执行案例</h3><p><strong>需求：</strong>JobA 每间隔 2 分钟执行一次。</p>
<p><strong>实现：</strong></p>
<ol>
<li><p>Azkaban 可以定时执行工作流。在执行工作流时候，选择左下角 <code>Schedule</code></p>
<p> <img src="/2022/01/25/Azkaban/image-20220126114348471.png" alt="image-20220126114348471"></p>
</li>
<li><p>右上角注意时区是上海，然后在左面填写具体执行事件，填写的方法和 Linux 中使用 crontab 配置定时任务规则一致。</p>
 <img src="/2022/01/25/Azkaban/image-20220126202504516.png" alt="image-20220126202504516" style="zoom:80%;"></li>
<li><p>观察结果</p>
<p> 时间间隔为每两分钟执行一次。</p>
<p> <img src="/2022/01/25/Azkaban/image-20220126202910617.png" alt="image-20220126202910617"></p>
</li>
<li><p>删除定时调度。</p>
<p> 点击 remove Schedule 即可删除当前任务的调度规则。</p>
<p> <img src="/2022/01/25/Azkaban/image-20220126202653520.png" alt="image-20220126202653520"></p>
</li>
</ol>
<hr>
<h2 id="3-4-邮件报警案例"><a href="#3-4-邮件报警案例" class="headerlink" title="3.4 邮件报警案例"></a>3.4 邮件报警案例</h2><p>TODO…</p>
<h2 id="3-5-电话报警案例"><a href="#3-5-电话报警案例" class="headerlink" title="3.5 电话报警案例"></a>3.5 电话报警案例</h2><p>TODO…</p>
<hr>
<h2 id="3-6-Azkaban的多Executor模式注意事项"><a href="#3-6-Azkaban的多Executor模式注意事项" class="headerlink" title="3.6 Azkaban的多Executor模式注意事项"></a>3.6 Azkaban的多Executor模式注意事项</h2><p>Azkaban 的多 Executor 模式是指：在集群中多个节点部署 Executor。在这种模式下，Azkaban Web Server 会根据策略，选取其中一个 Executor 去执行任务。</p>
<p><strong>场景模拟：</strong></p>
<p>假设集群中有3台机器，Hadoop102，Hadoop103 和 Hadoop104，三个节点都安装了 Executor，现有一脚本 test.sh 存储在 Hadoop102 上，通过 Azkaban 调用 Executor 执行一个工作流，该 Flow 执行时依赖 test.sh 脚本。这种情况下，该 Flow 可能会执行成功，也可能会执行失败，因为脚本文件只存在于 Hadoop102 上，如果执行 Flow 时恰好是由 Hadoop102 上的 Executor 拾取到了任务，那么可以执行成功，如果由另外两台机器上的 Executor 拾取到了任务，显然会执行失败。 </p>
<ol>
<li><p>在 Hadoop102 上创建 test.sh 脚本</p>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[lvnengdong@hadoop102 tmp]$ vim test.sh</span><br></pre></td></tr></table></figure>

<ul>
<li>  脚本内容</li>
</ul>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> hello</span><br></pre></td></tr></table></figure>

<ul>
<li>  给脚本文件增加执行权限</li>
</ul>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[lvnengdong@hadoop102 tmp]$ <span class="built_in">chmod</span> 777 test.sh</span><br></pre></td></tr></table></figure>

<ul>
<li>  测试脚本能否正常执行</li>
</ul>
 <figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[lvnengdong@hadoop102 tmp]$ /tmp/test.sh </span><br><span class="line">hello</span><br></pre></td></tr></table></figure>

</li>
<li><p>编写 test.flow</p>
 <figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">nodes:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">testJob</span></span><br><span class="line">    <span class="attr">type:</span> <span class="string">command</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="comment"># 使用在Hadoop102下的绝对路径执行 test.sh 脚本</span></span><br><span class="line">      <span class="attr">command:</span> <span class="string">/tmp/test.sh</span></span><br></pre></td></tr></table></figure>

</li>
<li><p> 将 test.flow、azkaban.project 文件压缩成 test.zip</p>
</li>
<li><p> 创建 test 项目 =&gt; 上传 test.zip文件 =&gt; 执行作业 =&gt; 观察结果 =&gt; 结果可能成功，也可能失败。</p>
</li>
</ol>
<p><strong>解决策略：</strong></p>
<p>为确保所选的 Executor 能够准确的执行任务 ，我们须在以下两种方案中任选其一 ，推荐使用方案二。</p>
<p><strong>方案一：</strong>指定特定的 Executor(比如：hadoop102)去执行任务。</p>
<ol>
<li><p>在 MySQL 中 azkaban 数据库 executors 表中，查询 hadoop102 上的 Executor 的 id。</p>
<p> <img src="/2022/01/25/Azkaban/image-20220126205853007.png" alt="image-20220126205853007"></p>
</li>
<li><p>在执行工作流程时加入 <code>useExecutor</code> 属性，如下</p>
<p> <img src="/2022/01/25/Azkaban/image-20220126210010690.png" alt="image-20220126210010690"></p>
</li>
<li><p> 执行成功！</p>
</li>
</ol>
<p><strong>方案二：</strong>将执行所需的脚本和应用分发到 Executor 所在的所有节点上。</p>
<hr>
<h1 id="第4章-参考资料"><a href="#第4章-参考资料" class="headerlink" title="第4章 参考资料"></a>第4章 参考资料</h1><h2 id="4-1-Azkaban-完整配置"><a href="#4-1-Azkaban-完整配置" class="headerlink" title="4.1 Azkaban 完整配置"></a>4.1 Azkaban 完整配置</h2><p>官网文档：<a target="_blank" rel="noopener" href="https://azkaban.readthedocs.io/en/latest/configuration.html">https://azkaban.readthedocs.io/en/latest/configuration.html</a></p>
<h2 id="4-2-YAML-语法"><a href="#4-2-YAML-语法" class="headerlink" title="4.2 YAML 语法"></a>4.2 YAML 语法</h2><p><a target="_blank" rel="noopener" href="https://www.ruanyifeng.com/blog/2016/07/yaml.html">https://www.ruanyifeng.com/blog/2016/07/yaml.html</a></p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/18/MySQL-%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/18/MySQL-%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/" class="post-title-link" itemprop="url">MySQL-变量与流程控制</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-18 13:36:19" itemprop="dateCreated datePublished" datetime="2022-01-18T13:36:19+08:00">2022-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-04-06 11:22:57" itemprop="dateModified" datetime="2022-04-06T11:22:57+08:00">2022-04-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySql/" itemprop="url" rel="index"><span itemprop="name">MySql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-变量"><a href="#1-变量" class="headerlink" title="1 变量"></a>1 变量</h1><p>在 MySQL 数据库的存储过程和存储函数中，可以使用变量来存储查询或计算的中间结果数据，或者输出最终的结果数据到变量中。</p>
<p>在 MySQL 数据库中，变量分为<code>系统变量</code>以及<code>用户自定义变量</code>。</p>
<h2 id="1-1-系统变量"><a href="#1-1-系统变量" class="headerlink" title="1.1 系统变量"></a>1.1 系统变量</h2><h3 id="1-1-1-系统变量分类"><a href="#1-1-1-系统变量分类" class="headerlink" title="1.1.1 系统变量分类"></a>1.1.1 系统变量分类</h3><p>变量由系统而不是用户定义，属于服务器层面。启动 MySQL 服务，生成 MySQL 服务实例期间，MySQL 服务器内存中的系统变量将被赋值。</p>
<p>这些系统变量定义了当前 MySQL 服务实例的属性、特征。这些系统变量的值要么是<code>编译 MySQL 时参数</code>的默认值，要么是<code>配置文件</code>（例如 my.ini 等）中的参数值。大家可以通过网址 <code>https://dev.mysql.com/doc/refman/8.0/en/server-systemvariables.html</code> 查看 MySQL 文档的系统变量。</p>
<p>系统变量又可细分为<strong>全局系统变量</strong>（需要添加 <code>global</code> 关键字）和<strong>会话系统变量</strong>（需要添加 <code>session</code> 关键字）。有时也把全局系统变量简称为全局变量，有时也把会话系统变量称为 local 变量。<strong>如果不写，默认会话级别</strong>。静态变量（在 MySQL 服务实例运行期间它们的值不能使用 set 动态修改）属于特殊的全局系统变量。</p>
<p>每一个 MySQL 客户端成功连接 MySQL 服务器后，都会产生与之对应的会话。会话期间，MySQL 服务实例会在 MySQL 服务器内存中生成与该会话对应的会话系统变量，这些会话系统变量的初始值是全局系统变量值的复制。如下图：</p>
<img src="/2022/01/18/MySQL-%E5%8F%98%E9%87%8F%E4%B8%8E%E6%B5%81%E7%A8%8B%E6%8E%A7%E5%88%B6/image-20220118134321274.png" alt="image-20220118134321274" style="zoom:67%;">

<ul>
<li>  全局系统变量针对于所有会话（连接）有效，但<strong>不能跨重启</strong>。</li>
<li>  会话系统变量仅针对于当前会话（连接）有效。会话期间，当前会话对某个会话系统变量值的修改，不会影响其它会话同名会话系统变量的值。</li>
<li>  但是会话1对某个全局系统变量值的修改会导致会话2中同一个全局系统变量值的修改。</li>
</ul>
<p>在 MySQL 中有些系统变量只能是全局的，例如 max_connections 用于限制服务器的最大连接数；有些系统变量作用域既可以是全局又可以是会话，例如 character_set_client 用于设置客户端的字符集；有些系统变量的作用域只能是当前会话，例如 pseudo_thread_id 用于标记当前会话的 MySQL 连接 ID。</p>
<hr>
<h3 id="1-1-2-查看系统变量"><a href="#1-1-2-查看系统变量" class="headerlink" title="1.1.2 查看系统变量"></a>1.1.2 查看系统变量</h3><p><strong>查看所有或部分系统变量</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 查看所有全局变量</span><br><span class="line">SHOW GLOBAL VARIABLES;</span><br><span class="line"></span><br><span class="line"># 查看所有会话变量</span><br><span class="line">SHOW SESSION VARIABLES;</span><br><span class="line"># 或（默认会话级别）</span><br><span class="line">SHOW VARIABLES;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查看满足条件的部分系统变量。</span><br><span class="line">SHOW GLOBAL VARIABLES LIKE &#x27;%标识符%&#x27;;</span><br><span class="line"></span><br><span class="line"># 查看满足条件的部分会话变量</span><br><span class="line">SHOW SESSION VARIABLES LIKE &#x27;%标识符%&#x27;;</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW GLOBAL VARIABLES LIKE &#x27;admin_%&#x27;;</span><br></pre></td></tr></table></figure>





<p><strong>查看指定系统变量</strong></p>
<p>作为 MySQL 编码规范，MySQL 中的系统变量以<code>两个“@”</code> 开头，其中 <code>“@@global”</code> 仅用于标记全局系统变量， <code>“@@session”</code> 仅用于标记会话系统变量。如果不加英文关键字， <code>“@@”</code> 首先会被标记会话系统变量，如果会话系统变量不存在，则标记全局系统变量。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">#查看指定的系统变量的值</span><br><span class="line">SELECT @@global.变量名;</span><br><span class="line"></span><br><span class="line">#查看指定的会话变量的值</span><br><span class="line">SELECT @@session.变量名;</span><br><span class="line"></span><br><span class="line">#或者（首先去会话系统变量中查找，如果不存在，再去全局系统变量中查找）</span><br><span class="line">SELECT @@变量名;</span><br></pre></td></tr></table></figure>





<p><strong>修改系统变量的值</strong></p>
<p>有些时候，数据库管理员需要修改系统变量的默认值，以便修改当前会话或者 MySQL 服务实例的属性、特征。具体方法如下：</p>
<ul>
<li>  方式1：修改 MySQL <code>配置文件</code>，继而修改 MySQL 系统变量的值（该方法需要重启 MySQL 服务）</li>
<li>  方式2：在 MySQL 服务运行期间，使用 <code>“set” 命令</code>重新设置系统变量的值</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 为某个系统变量赋值</span><br><span class="line">#方式1：</span><br><span class="line">SET @@global.变量名=变量值;</span><br><span class="line">#方式2：</span><br><span class="line">SET GLOBAL 变量名=变量值;</span><br><span class="line"></span><br><span class="line">#为某个会话变量赋值</span><br><span class="line">#方式1：</span><br><span class="line">SET @@session.变量名=变量值;</span><br><span class="line">#方式2：</span><br><span class="line">SET SESSION 变量名=变量值;</span><br></pre></td></tr></table></figure>

<p>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT @@global.autocommit;</span><br><span class="line">SET GLOBAL autocommit=0;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT @@session.tx_isolation;</span><br><span class="line">SET @@session.tx_isolation=&#x27;read-uncommitted&#x27;;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL max_connections = 1000;</span><br><span class="line">SELECT @@global.max_connections;</span><br></pre></td></tr></table></figure>





<hr>
<h2 id="1-2-用户自定义变量"><a href="#1-2-用户自定义变量" class="headerlink" title="1.2 用户自定义变量"></a>1.2 用户自定义变量</h2><h3 id="1-2-1-用户变量分类"><a href="#1-2-1-用户变量分类" class="headerlink" title="1.2.1 用户变量分类"></a>1.2.1 用户变量分类</h3><p>用户变量是用户自己定义的，根据作用范围不同，又分为<strong>会话用户变量</strong>和<strong>局部变量</strong>。MySQL 中的会话用户变量以<code>一个“@”</code> 开头，局部变量不使用 @ 符号修饰。</p>
<ul>
<li>  会话用户变量：作用域和会话变量一样，只对当前连接会话有效。</li>
<li>  局部变量：只在 BEGIN…END 语句块中有效。局部变量只能在存储过程和存储函数中使用。</li>
</ul>
<h3 id="1-2-2-会话用户变量"><a href="#1-2-2-会话用户变量" class="headerlink" title="1.2.2 会话用户变量"></a>1.2.2 会话用户变量</h3><ul>
<li>  <strong>变量的定义</strong></li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"># 方式1：“=” 或 “:=”</span><br><span class="line">SET @用户变量 = 值;</span><br><span class="line">SET @用户变量 := 值;</span><br><span class="line"></span><br><span class="line"># 方式2：“:=” 或 INTO 关键字</span><br><span class="line">SELECT @用户变量 := 表达式 [FROM 等子句];</span><br><span class="line">SELECT 表达式 INTO @用户变量 [FROM 等子句];</span><br></pre></td></tr></table></figure>

<ul>
<li>  查看用户变量的值 （查看、比较、运算等）</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT @用户变量</span><br></pre></td></tr></table></figure>

<ul>
<li>  举例</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET @a = 1;</span><br><span class="line">SELECT @a;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT @num := COUNT(*) FROM employees;</span><br><span class="line">SELECT @num;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SELECT AVG(salary) INTO @avgsalary FROM employees;</span><br><span class="line"></span><br><span class="line">SELECT @avgsalary;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT @big; # 查看某个未声明的变量时，将得到NULL值</span><br></pre></td></tr></table></figure>



<hr>
<h3 id="1-2-3-局部变量"><a href="#1-2-3-局部变量" class="headerlink" title="1.2.3 局部变量"></a>1.2.3 局部变量</h3><p><strong>定义：</strong>可以使用 <code>DECLARE</code> 关键字定义一个局部变量</p>
<p><strong>作用域：</strong>仅仅在定义它的 BEGIN … END 中有效</p>
<p><strong>位置：</strong>只能放在 BEGIN … END 中，而且必须放在第一句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">BEGIN</span><br><span class="line">    # 声明局部变量</span><br><span class="line">    DECLARE 变量名1 变量数据类型 [DEFAULT 变量默认值];</span><br><span class="line">    DECLARE 变量名2,变量名3,... 变量数据类型 [DEFAULT 变量默认值];</span><br><span class="line">    </span><br><span class="line">    # 为局部变量赋值</span><br><span class="line">    SET 变量名1 = 值; # 方式一：赋固定值</span><br><span class="line">    SELECT 值 INTO 变量名2 [FROM 子句]; # 方式二：查询赋值</span><br><span class="line">    </span><br><span class="line">    # 查看局部变量的值</span><br><span class="line">    SELECT 变量1,变量2,变量3;</span><br><span class="line">END</span><br></pre></td></tr></table></figure>



<ol>
<li><p><strong>定义变量</strong></p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE 变量名 类型 [default 值]; # 如果没有DEFAULT子句，初始值为NULL</span><br></pre></td></tr></table></figure>

<p> 举例：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE　myparam　INT　DEFAULT 100;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>变量赋值</strong></p>
<p> 方式1：一般用于赋简单的值</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET 变量名=值;</span><br><span class="line">SET 变量名:=值;</span><br></pre></td></tr></table></figure>

<p> 方式2：一般用于赋表中的字段值（先查再给）</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT 字段名或表达式 INTO 变量名 FROM 表;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>使用变量</strong>（查看、比较、运算等）</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT 局部变量名;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p><strong>举例1：</strong>声明局部变量，并分别赋值为 employees 表中 employee_id 为 102 的 last_name 和 salary</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE set_value()</span><br><span class="line">BEGIN</span><br><span class="line">	# 声明局部变量</span><br><span class="line">	DECLARE emp_name VARCHAR(25);</span><br><span class="line">	DECLARE sal DOUBLE(10,2);</span><br><span class="line"></span><br><span class="line">	# 为局部变量赋值</span><br><span class="line">	SELECT last_name, salary INTO emp_name, sal</span><br><span class="line">	FROM employees</span><br><span class="line">	WHERE employee_id = 102;</span><br><span class="line">	</span><br><span class="line">	# 查看赋值的结果（局部变量只在当前存储过程的上下文中有效）</span><br><span class="line">	SELECT emp_name, sal;</span><br><span class="line">END $</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>


<p><strong>举例2：</strong>声明两个变量，求和并打印 （分别使用会话用户变量、局部变量的方式实现）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 方式1：使用用户变量</span><br><span class="line">SET @a := 1;</span><br><span class="line">SET @b := 2;</span><br><span class="line">SET @sum = @a + @b;</span><br><span class="line">SELECT @sum;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 方式2：使用局部变量</span><br><span class="line">DELIMITER //</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE add_value()</span><br><span class="line">BEGIN</span><br><span class="line">    # 局部变量</span><br><span class="line">    DECLARE m INT DEFAULT 1;</span><br><span class="line">    DECLARE n INT DEFAULT 3;</span><br><span class="line">    DECLARE SUM INT;</span><br><span class="line">    </span><br><span class="line">SET SUM = m+n;</span><br><span class="line">    </span><br><span class="line">SELECT SUM;</span><br><span class="line">END //</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>


<p><strong>举例3：</strong>创建存储过程 “different_salary” 查询某员工和他领导的薪资差距，并用 IN 参数 emp_id 接收员工 id ，用 OUT 参数 dif_salary 输出薪资差距结果。</p>
<ul>
<li>  不使用局部变量的写法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE different_salary(IN emp_id INT, OUT dif_salary DOUBLE)</span><br><span class="line">BEGIN</span><br><span class="line">	SELECT (employees.salary - tmp.salary) INTO dif_salary </span><br><span class="line">	FROM employees, ( SELECT manager_id, salary FROM employees WHERE employee_id = emp_id ) AS tmp</span><br><span class="line">	WHERE employee_id = tmp.manager_id;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>  调用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 调用</span><br><span class="line">SET @emp_id = 102;</span><br><span class="line">CALL different_salary(@emp_id,@diff_sal);</span><br><span class="line"># 查看</span><br><span class="line">SELECT @diff_sal;</span><br></pre></td></tr></table></figure>

<ul>
<li>  使用局部变量的写法</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE different_salary(IN emp_id INT, OUT dif_salary DOUBLE)</span><br><span class="line">BEGIN</span><br><span class="line">	# 声明局部变量</span><br><span class="line">	DECLARE emp_sal, mgr_sal DOUBLE DEFAULT 0.0;</span><br><span class="line">	DECLARE mgr_id INT;</span><br><span class="line">	</span><br><span class="line">	# 员工工资</span><br><span class="line">	SELECT salary INTO emp_sal FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	# 领导id</span><br><span class="line">	SELECT manager_id INTO mgr_id FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	# 领导工资</span><br><span class="line">	SELECT salary INTO mgr_sal FROM employees WHERE employee_id = mgr_id;</span><br><span class="line">	# 工资差</span><br><span class="line">	SET dif_salary = mgr_sal - emp_sal;</span><br><span class="line">END //</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>





<hr>
<h3 id="1-2-4-对比会话用户变量与局部变量"><a href="#1-2-4-对比会话用户变量与局部变量" class="headerlink" title="1.2.4    对比会话用户变量与局部变量"></a>1.2.4    对比会话用户变量与局部变量</h3><table>
<thead>
<tr>
<th></th>
<th>作用域</th>
<th>定义位置</th>
<th>语法</th>
</tr>
</thead>
<tbody><tr>
<td>会话用户变量</td>
<td>当前会话</td>
<td>会话的任何地方</td>
<td>加@符号，不用指定类型</td>
</tr>
<tr>
<td>局部变量</td>
<td>定义它的 BEGIN END 中</td>
<td>BEGIN END的第一句话</td>
<td>一般不用加@,需要指定类型</td>
</tr>
</tbody></table>
<hr>
<h1 id="2-定义条件与处理程序"><a href="#2-定义条件与处理程序" class="headerlink" title="2 定义条件与处理程序"></a>2 定义条件与处理程序</h1><p>定义条件与处理机制就是针对程序中可能出现的可预见的错误采取的解决措施。</p>
<p><code>定义条件</code>指事先定义程序执行过程中可能遇到的问题，<code>处理程序</code>则定义了在遇到问题时应当采取的处理方式，并且保证存储过程或函数在遇到警告或错误时能继续执行。类似于 Java 语言中的 try…catch 代码块。这样可以增强存储程序处理问题的能力，避免程序异常停止运行。</p>
<p><strong>说明：</strong>定义条件和处理程序在存储过程、存储函数中都是支持的。</p>
<hr>
<h2 id="2-1-案例分析"><a href="#2-1-案例分析" class="headerlink" title="2.1 案例分析"></a>2.1 案例分析</h2><p><strong>案例分析：</strong>创建一个名为 “UpdateDataNoCondition” 的存储过程。代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE UpdateDataNoCondition()</span><br><span class="line">BEGIN</span><br><span class="line">    SET @x = 1;</span><br><span class="line">    # “email” cannot be null</span><br><span class="line">    UPDATE employees SET email = NULL WHERE last_name = &#x27;Abel&#x27;;</span><br><span class="line">    SET @x = 2;</span><br><span class="line">    UPDATE employees SET email = &#x27;aabbel&#x27; WHERE last_name = &#x27;Abel&#x27;;</span><br><span class="line">    SET @x = 3;</span><br><span class="line">END $</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>



<p>调用存储过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CALL UpdateDataNoCondition();</span><br><span class="line">ERROR 1048 (23000): Column &#x27;email&#x27; cannot be null</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT @x;</span><br><span class="line">+------+</span><br><span class="line">| @x |</span><br><span class="line">+------+</span><br><span class="line">| 1 |</span><br><span class="line">+------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>可以看到，此时 @x 变量的值为1。结合创建存储过程的 SQL 语句代码可以得出：在存储过程中未定义条件和处理程序，且当存储过程中执行的 SQL 语句报错时，MySQL 数据库会抛出错误，并退出当前 SQL 逻辑，不再向下继续执行。</p>
<hr>
<h2 id="2-2-定义条件"><a href="#2-2-定义条件" class="headerlink" title="2.2 定义条件"></a>2.2 定义条件</h2><p>定义条件就是给 MySQL 中的错误码命名，这有助于存储的程序代码更清晰。它将一个<code>错误名字</code>和<code>指定的错误条件</code>关联起来。这个名字可以随后被用在定义处理程序的 <code>DECLARE HANDLER</code> 语句中。</p>
<p>定义条件使用 DECLARE 语句，语法格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE 错误名称 CONDITION FOR 错误码（或错误条件）</span><br></pre></td></tr></table></figure>

<p>错误码的说明：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ERROR 1048 (23000): ......</span><br></pre></td></tr></table></figure>

<ul>
<li><code>MySQL_error_code</code> 和 <code>sqlstate_value</code> 都可以表示 MySQL 的错误。<ul>
<li>  MySQL_error_code 是数值类型错误代码。</li>
<li>  sqlstate_value 是长度为5的字符串类型错误代码。</li>
</ul>
</li>
<li>  例如，在 ERROR 1418 (HY000) 中，1418 是 MySQL_error_code，’HY000’ 是 sqlstate_value。</li>
<li>  例如，在 ERROR 1142（42000）中，1142 是 MySQL_error_code，’42000’ 是 sqlstate_value。</li>
</ul>
<p><strong>举例1：</strong>自定义 “Field_Not_Be_NULL” 错误名，与 MySQL 中违反非空约束的错误类型是 “ERROR 1048 (23000)” 对应。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 使用 MySQL_error_code</span><br><span class="line">DECLARE Field_Not_Be_NULL CONDITION FOR 1048;</span><br><span class="line"></span><br><span class="line"># 使用 sqlstate_value</span><br><span class="line">DECLARE Field_Not_Be_NULL CONDITION FOR SQLSTATE &#x27;23000&#x27;;</span><br></pre></td></tr></table></figure>



<p><strong>举例2：</strong>定义 “ERROR 1148(42000)” 错误，名称为 command_not_allowed。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 使用MySQL_error_code</span><br><span class="line">DECLARE command_not_allowed CONDITION FOR 1148;</span><br><span class="line"></span><br><span class="line"># 使用sqlstate_value</span><br><span class="line">DECLARE command_not_allowed CONDITION FOR SQLSTATE &#x27;42000&#x27;;</span><br></pre></td></tr></table></figure>





<hr>
<h2 id="2-3-定义处理程序"><a href="#2-3-定义处理程序" class="headerlink" title="2.3 定义处理程序"></a>2.3 定义处理程序</h2><p>可以为 SQL 执行过程中发生的某种类型的错误定义特殊的处理程序。定义处理程序时，使用 DECLARE 语句的语法如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DECLARE 处理方式 HANDLER FOR 错误类型 处理语句</span><br></pre></td></tr></table></figure>



<ul>
<li><strong>处理方式：</strong>处理方式有3个取值：CONTINUE、EXIT、UNDO。<ul>
<li>  <code>CONTINUE</code> ：表示遇到错误不处理，继续执行。</li>
<li>  <code>EXIT</code> ：表示遇到错误马上退出程序（默认）。</li>
<li>  <code>UNDO</code> ：表示遇到错误后撤回之前的操作（回滚）。MySQL中暂时不支持这样的操作。</li>
</ul>
</li>
<li><strong>错误类型</strong>（即条件）可以有如下取值：<ul>
<li>  <code>SQLSTATE &#39;字符串错误码&#39;</code> ：表示长度为5的 sqlstate_value 类型的错误代码；</li>
<li>  <code>MySQL_error_code</code> ：匹配数值类型错误代码；</li>
<li>  <code>错误名称</code> ：表示 DECLARE … CONDITION 定义的错误条件名称。</li>
<li>  <code>SQLWARNING</code> ：匹配所有以 01 开头的 SQLSTATE 错误代码；</li>
<li>  <code>NOT FOUND</code> ：匹配所有以 02 开头的 SQLSTATE 错误代码；</li>
<li>  <code>SQLEXCEPTION</code> ：匹配所有没有被 SQLWARNING 或 NOT FOUND 捕获的 SQLSTATE 错误代码；</li>
</ul>
</li>
<li>  <strong>处理语句：</strong>如果出现上述条件之一，则采用对应的处理方式，并执行指定的处理语句。语句可以是像 <code>SET 变量 = 值</code> 这样的简单语句，也可以是使用 <code>BEGIN ... END</code> 编写的复合语句。</li>
</ul>
<p>定义处理程序的几种方式，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">#方法1：捕获sqlstate_value</span><br><span class="line">DECLARE CONTINUE HANDLER FOR SQLSTATE &#x27;42S02&#x27; SET @info = &#x27;NO_SUCH_TABLE&#x27;;</span><br><span class="line"></span><br><span class="line">#方法2：捕获mysql_error_value</span><br><span class="line">DECLARE CONTINUE HANDLER FOR 1146 SET @info = &#x27;NO_SUCH_TABLE&#x27;;</span><br><span class="line"></span><br><span class="line">#方法3：先定义条件，再调用</span><br><span class="line">DECLARE no_such_table CONDITION FOR 1146;</span><br><span class="line">DECLARE CONTINUE HANDLER FOR NO_SUCH_TABLE SET @info = &#x27;NO_SUCH_TABLE&#x27;;</span><br><span class="line"></span><br><span class="line">#方法4：使用SQLWARNING</span><br><span class="line">DECLARE EXIT HANDLER FOR SQLWARNING SET @info = &#x27;ERROR&#x27;;</span><br><span class="line"></span><br><span class="line">#方法5：使用NOT FOUND</span><br><span class="line">DECLARE EXIT HANDLER FOR NOT FOUND SET @info = &#x27;NO_SUCH_TABLE&#x27;;</span><br><span class="line"></span><br><span class="line">#方法6：使用SQLEXCEPTION</span><br><span class="line">DECLARE EXIT HANDLER FOR SQLEXCEPTION SET @info = &#x27;ERROR&#x27;;</span><br></pre></td></tr></table></figure>



<hr>
<h2 id="2-4-案例解决"><a href="#2-4-案例解决" class="headerlink" title="2.4    案例解决"></a>2.4    案例解决</h2><p>在存储过程中，定义处理程序，捕获 sqlstate_value 值，当遇到 MySQL_error_code 值为 1048 时，执行 CONTINUE 操作，并且将 @flag 的值设置为 -1。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE UpdateDataNoCondition()</span><br><span class="line">BEGIN</span><br><span class="line">    # 声明处理程序</span><br><span class="line">    DECLARE CONTINUE HANDLER FOR 1048 SET @flag = -1;</span><br><span class="line">    </span><br><span class="line">    SET @x = 1;</span><br><span class="line">    UPDATE employees SET email = NULL WHERE last_name = &#x27;Abel&#x27;;</span><br><span class="line">    SET @x = 2;</span><br><span class="line">    UPDATE employees SET email = &#x27;aabbel&#x27; WHERE last_name = &#x27;Abel&#x27;;</span><br><span class="line">    SET @x = 3;</span><br><span class="line">END $</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>调用过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 调用</span><br><span class="line">mysql&gt; CALL UpdateDataWithCondition();</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line"># 查询 @flag 的值，若为 -1 则证明存储过程执行出错；</span><br><span class="line"># 查询 @x 的值，若为 3 则证明程序出错时不会中止而是继续执行</span><br><span class="line">mysql&gt; SELECT @x,@proc_value;</span><br><span class="line">+------+-------------+</span><br><span class="line">| @x | @flag |</span><br><span class="line">+------+-------------+</span><br><span class="line">| 3 | -1 |</span><br><span class="line">+------+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>





<p><strong>举例：</strong>创建一个名称为 “InsertDataWithCondition” 的存储过程，代码如下。</p>
<p>在存储过程中，定义处理程序，捕获 sqlstate_value 值，当遇到 sqlstate_value 值为 23000 时，执行 EXIT 操作，并且将 @proc_value 的值设置为 -1。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"># 准备工作：给 department_name 字段加唯一性约束</span><br><span class="line">ALTER TABLE departments</span><br><span class="line">ADD CONSTRAINT uk_dept_name UNIQUE(department_name);</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE InsertDataWithCondition()</span><br><span class="line">BEGIN</span><br><span class="line">	# 定义条件（给错误码起一个好听的名字）</span><br><span class="line">    DECLARE duplicate_entry CONDITION FOR SQLSTATE &#x27;23000&#x27; ;</span><br><span class="line">    # 处理程序</span><br><span class="line">    DECLARE EXIT HANDLER FOR duplicate_entry SET @proc_value = -1;</span><br><span class="line">    </span><br><span class="line">    SET @x = 1;</span><br><span class="line">    INSERT INTO departments(department_name) VALUES(&#x27;测试&#x27;);</span><br><span class="line">    SET @x = 2;</span><br><span class="line">    INSERT INTO departments(department_name) VALUES(&#x27;测试&#x27;);</span><br><span class="line">    SET @x = 3;</span><br><span class="line">END //</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>调用存储过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CALL InsertDataWithCondition();</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT @x,@proc_value;</span><br><span class="line">+------+-------------+</span><br><span class="line">| @x | @proc_value |</span><br><span class="line">+------+-------------+</span><br><span class="line">| 2 | -1 |</span><br><span class="line">+------+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>





<hr>
<h1 id="3-流程控制"><a href="#3-流程控制" class="headerlink" title="3 流程控制"></a>3 流程控制</h1><p>解决复杂问题不可能通过一个 SQL 语句完成，我们需要执行多个 SQL 操作。流程控制语句的作用就是控制存储过程中 SQL 语句的执行顺序，是我们完成复杂操作必不可少的一部分。只要是执行的程序，流程就分为三大类：</p>
<ul>
<li>  <code>顺序结构</code>：程序从上往下依次执行</li>
<li>  <code>分支结构</code>：程序按条件进行选择执行，从两条或多条路径中选择一条执行</li>
<li>  <code>循环结构</code>：程序满足一定条件下，重复执行一组语句</li>
</ul>
<p>针对于 MySQL 的流程控制语句主要有 3 类。<strong>注意：只能用于存储程序。</strong></p>
<ul>
<li>  <code>条件判断语句</code>：IF 语句和 CASE 语句</li>
<li>  <code>循环语句</code>：LOOP、WHILE 和 REPEAT 语句</li>
<li>  <code>跳转语句</code>：ITERATE 和 LEAVE 语句</li>
</ul>
<hr>
<h2 id="3-1-分支结构之IF"><a href="#3-1-分支结构之IF" class="headerlink" title="3.1 分支结构之IF"></a>3.1 分支结构之IF</h2><p>IF 语句的语法结构是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">IF 表达式1 THEN 操作1</span><br><span class="line">[ELSEIF 表达式2 THEN 操作2]……</span><br><span class="line">[ELSE 操作N]</span><br><span class="line">END IF</span><br></pre></td></tr></table></figure>

<p>根据表达式的结果为 TRUE 或 FALSE 执行相应的语句。这里 “[]” 中的内容是可选的。</p>
<ul>
<li><p>  特点：① 不同的表达式对应不同的操作 ② 使用在 begin…end 中</p>
</li>
<li><p><strong>举例1：</strong></p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">IF val IS NULL THEN </span><br><span class="line">	SELECT &#x27;val is null&#x27;;</span><br><span class="line">ELSE </span><br><span class="line">	SELECT &#x27;val is not null&#x27;;</span><br><span class="line">END IF;</span><br></pre></td></tr></table></figure>
</li>
<li><p><strong>举例2：</strong>声明存储过程 “update_salary_by_eid1”，定义 IN 参数 emp_id，输入员工编号。判断该员工薪资如果低于 8000 元并且入职时间超过 5 年，就涨薪 500 元；否则就不变。</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE update_salary_by_eid1(IN emp_id INT)</span><br><span class="line">BEGIN</span><br><span class="line">	# 声明局部变量</span><br><span class="line">	DECLARE emp_salary DOUBLE;</span><br><span class="line">	DECLARE hire_year DOUBLE;</span><br><span class="line">	# 给局部变量赋值</span><br><span class="line">	SELECT salary INTO emp_salary FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	SELECT DATEDIFF(CURDATE(),hire_date)/365 INTO hire_year FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	</span><br><span class="line">	# 条件语句判断</span><br><span class="line">	IF emp_salary &lt; 8000 AND hire_year &gt; 5</span><br><span class="line">		THEN UPDATE employees SET salary = salary + 500 WHERE employee_id = emp_id;</span><br><span class="line">	END IF;</span><br><span class="line">END $</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

</li>
<li><p><strong>举例3：</strong>声明存储过程 “update_salary_by_eid2”，定义 IN 参数 emp_id，输入员工编号。判断该员工薪资如果低于9000元并且入职时间超过5年，就涨薪500元；否则就涨薪100元。</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE update_salary_by_eid2(IN emp_id INT)</span><br><span class="line">BEGIN</span><br><span class="line">	DECLARE emp_salary DOUBLE;</span><br><span class="line">	DECLARE hire_year DOUBLE;</span><br><span class="line">	</span><br><span class="line">	SELECT salary INTO emp_salary FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	SELECT DATEDIFF(CURDATE(),hire_date)/365 INTO hire_year FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	</span><br><span class="line">	IF emp_salary &lt; 8000 AND hire_year &gt; 5</span><br><span class="line">		THEN UPDATE employees SET salary = salary + 500 WHERE employee_id = emp_id;</span><br><span class="line">	ELSE</span><br><span class="line">		UPDATE employees SET salary = salary + 100 WHERE employee_id = emp_id;</span><br><span class="line">	END IF;</span><br><span class="line">END //</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure></li>
<li><p><strong>举例4：</strong>声明存储过程 “update_salary_by_eid3”，定义 IN 参数 emp_id，输入员工编号。判断该员工薪资如果低于9000元，就更新薪资为9000元；薪资如果大于等于9000元且低于10000的，但是奖金比例为NULL的，就更新奖金比例为0.01；其他的涨薪100元。</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE update_salary_by_eid3(IN emp_id INT)</span><br><span class="line">BEGIN</span><br><span class="line">	DECLARE emp_salary DOUBLE;</span><br><span class="line">	DECLARE bonus DECIMAL(3,2);</span><br><span class="line">	</span><br><span class="line">	SELECT salary INTO emp_salary FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	SELECT commission_pct INTO bonus FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	</span><br><span class="line">	IF emp_salary &lt; 9000</span><br><span class="line">		THEN UPDATE employees SET salary = 9000 WHERE employee_id = emp_id;</span><br><span class="line">	ELSEIF emp_salary &lt; 10000 AND bonus IS NULL</span><br><span class="line">		THEN UPDATE employees SET commission_pct = 0.01 WHERE employee_id = emp_id;</span><br><span class="line">	ELSE</span><br><span class="line">		UPDATE employees SET salary = salary + 100 WHERE employee_id = emp_id;</span><br><span class="line">	END IF;</span><br><span class="line">END //</span><br><span class="line"> </span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="3-2-分支结构之CASE"><a href="#3-2-分支结构之CASE" class="headerlink" title="3.2 分支结构之CASE"></a>3.2 分支结构之CASE</h2><p>CASE 语句的语法结构1：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 情况一：类似于switch</span><br><span class="line">CASE 表达式</span><br><span class="line">WHEN 值1 </span><br><span class="line">	THEN 结果1或语句1(如果是语句，需要加分号)</span><br><span class="line">WHEN 值2 </span><br><span class="line">	THEN 结果2或语句2(如果是语句，需要加分号)</span><br><span class="line">...</span><br><span class="line">ELSE </span><br><span class="line">	结果n或语句n(如果是语句，需要加分号)</span><br><span class="line">END [case] # 如果是放在 begin end 中需要加上 case，如果放在 select 后面不需要</span><br></pre></td></tr></table></figure>

<p>CASE 语句的语法结构2：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># 情况二：类似于多重if</span><br><span class="line">CASE</span><br><span class="line">WHEN 条件1 </span><br><span class="line">	THEN 结果1或语句1(如果是语句，需要加分号)</span><br><span class="line">WHEN 条件2 </span><br><span class="line">	THEN 结果2或语句2(如果是语句，需要加分号)</span><br><span class="line">...</span><br><span class="line">ELSE </span><br><span class="line">	结果n或语句n(如果是语句，需要加分号)</span><br><span class="line">END [case] # 如果是放在 begin end 中需要加上 case，如果放在 select 后面不需要</span><br></pre></td></tr></table></figure>

<p><strong>举例1：</strong>使用 CASE 流程控制语句的第1种格式，判断 val 值等于1、等于2，或者两者都不等。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">CASE val</span><br><span class="line">	WHEN 1 </span><br><span class="line">		THEN SELECT &#x27;val is 1&#x27;;</span><br><span class="line">	WHEN 2 </span><br><span class="line">		THEN SELECT &#x27;val is 2&#x27;;</span><br><span class="line">	ELSE </span><br><span class="line">		SELECT &#x27;val is not 1 or 2&#x27;;</span><br><span class="line">END CASE;</span><br></pre></td></tr></table></figure>

<p><strong>举例2：</strong>使用 CASE 流程控制语句的第2种格式，判断 val 是否为空、小于0、大于0或者等于0。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">CASE</span><br><span class="line"></span><br><span class="line">WHEN val IS NULL </span><br><span class="line">	THEN SELECT &#x27;val is null&#x27;;</span><br><span class="line">WHEN val &lt; 0 </span><br><span class="line">	THEN SELECT &#x27;val is less than 0&#x27;;</span><br><span class="line">WHEN val &gt; 0 </span><br><span class="line">	THEN SELECT &#x27;val is greater than 0&#x27;;</span><br><span class="line">ELSE </span><br><span class="line">	SELECT &#x27;val is 0&#x27;;</span><br><span class="line"></span><br><span class="line">END CASE;</span><br></pre></td></tr></table></figure>

<p><strong>举例3：</strong>声明存储过程 “update_salary_by_eid4”，定义 IN 参数 emp_id，输入员工编号。判断该员工薪资如果低于9000元，就更新薪资为9000元；薪资大于等于9000元且低于10000的，但是奖金比例为 NULL 的，就更新奖金比例为0.01；其他的涨薪100元。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE update_salary_by_eid4(IN emp_id INT)</span><br><span class="line">BEGIN</span><br><span class="line">	# 定义局部变量</span><br><span class="line">	DECLARE emp_sal DOUBLE;	# 员工薪资</span><br><span class="line">	DECLARE bonus DECIMAL(3,2); # 奖金比例</span><br><span class="line">	# 局部变量赋值</span><br><span class="line">	SELECT salary INTO emp_sal FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	SELECT commission_pct INTO bonus FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	</span><br><span class="line">	#</span><br><span class="line">	CASE</span><br><span class="line">	WHEN emp_sal &lt; 9000</span><br><span class="line">		THEN UPDATE employees SET salary=9000 WHERE employee_id = emp_id;</span><br><span class="line">	WHEN emp_sal &gt; 9000 AND emp_sal &lt; 10000 AND bonus = 0.01</span><br><span class="line">		THEN UPDATE employees SET commission_pct=0.01 WHERE employee_id = emp_id; </span><br><span class="line">	ELSE</span><br><span class="line">		UPDATE employees SET salary=salary+100 WHERE employee_id = emp_id;</span><br><span class="line">	END CASE;</span><br><span class="line">END $</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p><strong>举例4：</strong>声明存储过程 update_salary_by_eid5，定义 IN 参数 emp_id，输入员工编号。判断该员工的入职年限，如果是0年，薪资涨50；如果是1年，薪资涨100；如果是2年，薪资涨200；如果是3年，薪资涨300；如果是4年，薪资涨400；其他的涨薪500。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE update_salary_by_eid5(IN emp_id INT)</span><br><span class="line">BEGIN</span><br><span class="line">	# 声明局部变量</span><br><span class="line">	DECLARE emp_sal DOUBLE;	# 员工薪资</span><br><span class="line">	DECLARE hire_year DOUBLE; # 入职年限</span><br><span class="line">	# 局部变量赋值</span><br><span class="line">	SELECT salary INTO emp_sal FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	SELECT ROUND(DATEDIFF(CURDATE(),hire_date)/365) INTO hire_year FROM employees WHERE employee_id = emp_id;</span><br><span class="line">	</span><br><span class="line">	#</span><br><span class="line">	CASE hire_year</span><br><span class="line">	WHEN 0 </span><br><span class="line">		THEN UPDATE employees SET salary=salary+50 WHERE employee_id = emp_id;</span><br><span class="line">	WHEN 1 </span><br><span class="line">		THEN UPDATE employees SET salary=salary+100 WHERE employee_id = emp_id;</span><br><span class="line">	WHEN 2 </span><br><span class="line">		THEN UPDATE employees SET salary=salary+200 WHERE employee_id = emp_id;</span><br><span class="line">	WHEN 3 </span><br><span class="line">		THEN UPDATE employees SET salary=salary+300 WHERE employee_id = emp_id;</span><br><span class="line">	WHEN 4 </span><br><span class="line">		THEN UPDATE employees SET salary=salary+400 WHERE employee_id = emp_id;</span><br><span class="line">	ELSE </span><br><span class="line">		UPDATE employees SET salary=salary+500 WHERE employee_id = emp_id;</span><br><span class="line">	END CASE;</span><br><span class="line">END //</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>



<hr>
<h2 id="3-3-循环结构之LOOP"><a href="#3-3-循环结构之LOOP" class="headerlink" title="3.3 循环结构之LOOP"></a>3.3 循环结构之LOOP</h2><p><code>LOOP</code> 循环语句用来重复执行某些语句。LOOP 内的语句一直重复执行直到循环被退出（使用 <code>LEAVE</code> 子句），跳出循环过程。</p>
<p>LOOP 语句的基本格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[loop_label:] LOOP</span><br><span class="line">	循环执行的语句</span><br><span class="line">END LOOP [loop_label]</span><br></pre></td></tr></table></figure>

<p>其中，loop_label 表示 LOOP 语句的标注名称，该参数可以省略。</p>
<p><strong>举例1：</strong>使用 LOOP 语句进行循环操作，id 值小于10时将重复执行循环过程。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">DECLARE id INT DEFAULT 0;</span><br><span class="line">add_loop:LOOP</span><br><span class="line">SET id = id +1;</span><br><span class="line">IF id &gt;= 10 THEN LEAVE add_loop;</span><br><span class="line">END IF;</span><br><span class="line">END LOOP add_loop;</span><br><span class="line"></span><br><span class="line">DELIMITER $</span><br><span class="line">CREATE PROCEDURE test_loop1()</span><br><span class="line">BEGIN</span><br><span class="line">    DECLARE id INT DEFAULT 0;</span><br><span class="line">    add_loop: LOOP</span><br><span class="line">        # 循环体语句</span><br><span class="line">        SET id = id + 1;</span><br><span class="line">        # 退出条件</span><br><span class="line">        IF id &gt;= 10</span><br><span class="line">            THEN LEAVE add_loop;</span><br><span class="line">        END IF;</span><br><span class="line">    END LOOP add_loop;</span><br><span class="line">END $</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>



<p><strong>举例2：</strong>当市场环境变好时，公司为了奖励大家，决定给大家涨工资。声明存储过程 “update_salary_loop()”，声明 OUT 参数 num，输出循环次数。存储过程中实现循环给大家涨薪，薪资涨为原来的1.1倍。直到全公司的平均薪资达到12000结束。并统计循环次数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE update_salary_loop(OUT num INT)</span><br><span class="line">BEGIN</span><br><span class="line"></span><br><span class="line">DECLARE avg_salary DOUBLE;</span><br><span class="line">DECLARE loop_count INT DEFAULT 0;</span><br><span class="line">SELECT AVG(salary) INTO avg_salary FROM employees;</span><br><span class="line"></span><br><span class="line">label_loop:LOOP</span><br><span class="line">	IF avg_salary &gt;= 12000 THEN LEAVE label_loop;</span><br><span class="line">    END IF;</span><br><span class="line">	UPDATE employees SET salary = salary * 1.1;</span><br><span class="line">	SET loop_count = loop_count + 1;</span><br><span class="line">	SELECT AVG(salary) INTO avg_salary FROM employees;</span><br><span class="line">END LOOP label_loop;</span><br><span class="line"></span><br><span class="line">SET num = loop_count;</span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DELIMITER $</span><br><span class="line">CREATE PROCEDURE update_salary_loop(OUT num INT)</span><br><span class="line">BEGIN</span><br><span class="line">	DECLARE loop_count INT DEFAULT 0; # 循环次数</span><br><span class="line">	DECLARE avg_sal DOUBLE(8,2); # 平均薪资</span><br><span class="line">	</span><br><span class="line">	# 循环体语句</span><br><span class="line">	label_loop: LOOP</span><br><span class="line">		# 查询当前平均工资</span><br><span class="line">		SELECT AVG(salary) INTO avg_sal FROM employees;</span><br><span class="line">		# 判断：如果 avg_sal&gt;12000 循环结束，否则每个员工的薪资增长1.1倍</span><br><span class="line">		# 退出条件</span><br><span class="line">		IF avg_sal &gt;= 12000</span><br><span class="line">			THEN LEAVE label_loop;</span><br><span class="line">		ELSE </span><br><span class="line">			UPDATE employees SET salary = salary * 1.1;</span><br><span class="line">			SET loop_count = loop_count + 1;</span><br><span class="line">		END IF;</span><br><span class="line">	END LOOP label_loop;</span><br><span class="line">	SET num = loop_count;</span><br><span class="line">END $</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>





<h2 id="3-4-循环结构之WHILE"><a href="#3-4-循环结构之WHILE" class="headerlink" title="3.4 循环结构之WHILE"></a>3.4 循环结构之WHILE</h2><p><code>WHILE</code> 语句创建一个带条件判断的循环过程。WHILE 在执行语句执行时，先对指定的表达式进行判断，如<br>果为真，就执行循环内的语句，否则退出循环。WHILE 语句的基本格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[while_label:] WHILE 循环条件 DO </span><br><span class="line">	循环体</span><br><span class="line">END WHILE [while_label];</span><br></pre></td></tr></table></figure>

<p>while_label 为 WHILE 语句的标注名称；如果循环条件结果为真，WHILE 语句内的语句或语句群被执行，直<br>至循环条件为假，退出循环。</p>
<p><strong>举例1：</strong>WHILE 语句示例，i 值小于 10 时，将重复执行循环过程，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE test_while()</span><br><span class="line">BEGIN</span><br><span class="line"></span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">WHILE i &lt; 10 DO</span><br><span class="line">	SET i = i + 1;</span><br><span class="line">END WHILE;</span><br><span class="line">SELECT i;</span><br><span class="line"></span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"># 调用</span><br><span class="line">CALL test_while();</span><br></pre></td></tr></table></figure>

<p><strong>举例2：</strong>市场环境不好时，公司为了渡过难关，决定暂时降低大家的薪资。声明存储过程 “update_salary_while()”，声明 OUT 参数 num，输出循环次数。存储过程中实现循环给大家降薪，薪资降为原来的 90%。直到全公司的平均薪资达到5000结束。并统计循环次数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE update_salary_while(OUT num INT)</span><br><span class="line">BEGIN</span><br><span class="line"></span><br><span class="line">DECLARE avg_sal DOUBLE ;</span><br><span class="line">DECLARE while_count INT DEFAULT 0;</span><br><span class="line">SELECT AVG(salary) INTO avg_sal FROM employees;</span><br><span class="line"></span><br><span class="line">WHILE avg_sal &gt; 5000 DO</span><br><span class="line">	UPDATE employees SET salary = salary * 0.9;</span><br><span class="line">	SET while_count = while_count + 1;</span><br><span class="line">	SELECT AVG(salary) INTO avg_sal FROM employees;</span><br><span class="line">END WHILE;</span><br><span class="line">SET num = while_count;</span><br><span class="line"></span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>





<h2 id="3-5-循环结构之REPEAT"><a href="#3-5-循环结构之REPEAT" class="headerlink" title="3.5 循环结构之REPEAT"></a>3.5 循环结构之REPEAT</h2><p><code>REPEAT</code> 语句创建一个带条件判断的循环过程。与 WHILE 循环不同的是，REPEAT 循环首先会执行一次循<br>环，然后在 <code>UNTIL</code> 中进行表达式的判断，如果满足条件就退出，即 <code>END REPEAT</code>；如果条件不满足，就会继续执行循环，直到满足退出条件为止。</p>
<p>REPEAT 语句的基本格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[repeat_label:] REPEAT</span><br><span class="line">　　　　循环体的语句</span><br><span class="line">UNTIL 结束循环的条件表达式</span><br><span class="line">END REPEAT [repeat_label]</span><br></pre></td></tr></table></figure>

<p>repeat_label 为 REPEAT 语句的标注名称，该参数可以省略；REPEAT 语句内的语句或语句群被重复，直至  expr_condition 为真。</p>
<p><strong>举例1：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line">CREATE PROCEDURE test_repeat()</span><br><span class="line">BEGIN</span><br><span class="line"></span><br><span class="line">	DECLARE i INT DEFAULT 0;</span><br><span class="line">	</span><br><span class="line">	REPEAT </span><br><span class="line">		# 无条件先执行一次</span><br><span class="line">		SET i = i + 1;</span><br><span class="line">	# 循环结束条件</span><br><span class="line">	UNTIL i &gt;= 10</span><br><span class="line">	END REPEAT;</span><br><span class="line"></span><br><span class="line">	# 验证</span><br><span class="line">	SELECT i;</span><br><span class="line">	</span><br><span class="line">END $</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p><strong>举例2：</strong>当市场环境变好时，公司为了奖励大家，决定给大家涨工资。声明存储过程 “update_salary_repeat()”，声明 OUT 参数 num ，输出循环次数。存储过程中实现循环给大家涨薪，薪资涨为原来的 1.15 倍。直到全公司的平均薪资达到 13000 结束。并统计循环次数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line">CREATE PROCEDURE update_salary_repeat(OUT num INT)</span><br><span class="line">BEGIN	</span><br><span class="line">	DECLARE repeat_count INT DEFAULT 0; # 循环次数</span><br><span class="line">	DECLARE avg_sal DOUBLE; # 平均工资</span><br><span class="line">	SELECT AVG(salary) INTO avg_sal FROM employees;  </span><br><span class="line">	</span><br><span class="line">	# 循环体：</span><br><span class="line">	REPEAT</span><br><span class="line">		# 1、所有员工的薪资涨为原来的1.15倍</span><br><span class="line">		UPDATE employees SET salary = salary * 1.15;</span><br><span class="line">		# 2、更新 avg_sal</span><br><span class="line">		SELECT AVG(salary) INTO avg_sal FROM employees;</span><br><span class="line">		# 3、更新 repeat_count</span><br><span class="line">		SET repeat_count = repeat_count + 1;</span><br><span class="line">		</span><br><span class="line">	# 循环结束条件：avg_sal达到13000</span><br><span class="line">	UNTIL avg_sal &gt;= 13000</span><br><span class="line">		END REPEAT;</span><br><span class="line">	</span><br><span class="line">	# 更新输出变量</span><br><span class="line">	SET num = repeat_count;</span><br><span class="line">END $</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p><strong>对比三种循环结构：</strong></p>
<ol>
<li> 这三种循环都可以省略名称，但如果循环中添加了循环控制语句（LEAVE或ITERATE）则必须添加名称。 </li>
<li> LOOP：一般用于实现简单的”死”循环；WHILE：先判断后执行； REPEAT：先执行后判断，无条件至少执行一次</li>
</ol>
<hr>
<h2 id="3-6-跳转语句之LEAVE语句"><a href="#3-6-跳转语句之LEAVE语句" class="headerlink" title="3.6 跳转语句之LEAVE语句"></a>3.6 跳转语句之LEAVE语句</h2><p><code>LEAVE</code> 语句：可以用在循环语句内，或者以 BEGIN…END 包裹起来的程序体内，表示跳出循环或者跳出<br>程序体的操作。如果你有面向过程的编程语言的使用经验，你可以把 LEAVE 理解为 break。</p>
<p>基本格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">LEAVE 标记名</span><br></pre></td></tr></table></figure>

<p>其中，label 参数表示循环的标志。LEAVE 和 BEGIN … END 或循环一起被使用。</p>
<p><strong>举例1：</strong>创建存储过程 “leave_begin()”，声明INT类型的IN参数num。给BEGIN…END加标记名，并在 BEGIN…END 中使用 IF 语句判断num 参数的值。</p>
<ul>
<li>  如果num&lt;=0，则使用LEAVE语句退出BEGIN…END；</li>
<li>  如果num=1，则查询“employees”表的平均薪资；</li>
<li>  如果num=2，则查询“employees”表的最低薪资；</li>
<li>  如果num&gt;2，则查询“employees”表的最高薪资。</li>
</ul>
<p>IF语句结束后查询“employees”表的总人数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE leave_begin(IN num INT)</span><br><span class="line">begin_label: BEGIN</span><br><span class="line"></span><br><span class="line">IF num&lt;=0 </span><br><span class="line">	THEN LEAVE begin_label;</span><br><span class="line">ELSEIF num=1</span><br><span class="line">	THEN SELECT AVG(salary) FROM employees;</span><br><span class="line">ELSEIF num=2</span><br><span class="line">	THEN SELECT MIN(salary) FROM employees;</span><br><span class="line">ELSE</span><br><span class="line">	SELECT MAX(salary) FROM employees;</span><br><span class="line">END IF;</span><br><span class="line"></span><br><span class="line">SELECT COUNT(*) FROM employees;</span><br><span class="line"></span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>



<p><strong>举例2：</strong>当市场环境不好时，公司为了渡过难关，决定暂时降低大家的薪资。声明存储过程“leave_while()”，声明OUT参数num，输出循环次数，存储过程中使用WHILE循环给大家降低薪资为原来薪资的90%，直到全公司的平均薪资小于等于10000，并统计循环次数。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE leave_while(OUT num INT)</span><br><span class="line">BEGIN</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">DECLARE avg_sal DOUBLE; # 记录平均工资</span><br><span class="line">DECLARE while_count INT DEFAULT 0; # 记录循环次数</span><br><span class="line">SELECT AVG(salary) INTO avg_sal FROM employees; #① 初始化条件</span><br><span class="line"></span><br><span class="line">while_label:WHILE TRUE DO #② 循环条件</span><br><span class="line">	#③ 循环体</span><br><span class="line">	IF avg_sal &lt;= 10000 </span><br><span class="line">		THEN LEAVE while_label;</span><br><span class="line">	END IF;</span><br><span class="line">	</span><br><span class="line">	UPDATE employees SET salary = salary * 0.9;</span><br><span class="line">	SET while_count = while_count + 1;</span><br><span class="line">	#④ 迭代条件</span><br><span class="line">	SELECT AVG(salary) INTO avg_sal FROM employees;</span><br><span class="line">	END WHILE;</span><br><span class="line"></span><br><span class="line"># 赋值</span><br><span class="line">SET num = while_count;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>





<hr>
<h2 id="3-7-跳转语句之ITERATE语句"><a href="#3-7-跳转语句之ITERATE语句" class="headerlink" title="3.7 跳转语句之ITERATE语句"></a>3.7 跳转语句之ITERATE语句</h2><p><code>ITERATE </code>语句：只能用在循环语句（LOOP、REPEAT和WHILE语句）内，表示重新开始循环，将执行顺序<br>转到语句段开头处。如果你有面向过程的编程语言的使用经验，你<strong>可以把 ITERATE 理解为 continue</strong>，意<br>思为“再次循环”。</p>
<p>语句基本格式如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ITERATE label</span><br></pre></td></tr></table></figure>

<p>label 参数表示循环的标志。ITERATE 语句必须跟在循环标志前面。</p>
<p><strong>举例：</strong> 定义局部变量num，初始值为0。循环结构中执行 num+1 操作。</p>
<ul>
<li>  如果num &lt; 10，则继续执行循环；</li>
<li>  如果num &gt; 15，则退出循环结构；</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER //</span><br><span class="line">CREATE PROCEDURE test_iterate()</span><br><span class="line">BEGIN</span><br><span class="line"></span><br><span class="line">DECLARE num INT DEFAULT 0;</span><br><span class="line"></span><br><span class="line">my_loop:LOOP</span><br><span class="line">	SET num = num + 1;</span><br><span class="line">	IF num &lt; 10</span><br><span class="line">		THEN ITERATE my_loop;</span><br><span class="line">	ELSEIF num &gt; 15</span><br><span class="line">		THEN LEAVE my_loop; </span><br><span class="line">	END IF;</span><br><span class="line">	</span><br><span class="line">	SELECT &#x27;Other&#x27;;</span><br><span class="line">END LOOP my_loop;</span><br><span class="line"></span><br><span class="line">END //</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>





<hr>
<h1 id="常见存储函数与存储过程"><a href="#常见存储函数与存储过程" class="headerlink" title="常见存储函数与存储过程"></a>常见存储函数与存储过程</h1><h2 id="存储函数"><a href="#存储函数" class="headerlink" title="存储函数"></a>存储函数</h2><p><strong>rand_num(from_num INT ,to_num INT)：</strong>用于生成 <code>from_num ~ to_num</code> 之间的随机整数。</p>
<ul>
<li>  声明存储函数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line"># 使用数据库</span><br><span class="line">USE `gmall`$$</span><br><span class="line"># 如果存在同名函数则先删除</span><br><span class="line">DROP FUNCTION IF EXISTS `rand_num`$$</span><br><span class="line"></span><br><span class="line"># 创建存储函数，接收两个参数：from_num 和 to_num，返回值是 int 类型</span><br><span class="line">CREATE DEFINER=`root`@`localhost` FUNCTION `rand_num`(from_num INT ,to_num INT) RETURNS INT(11)</span><br><span class="line">BEGIN   </span><br><span class="line">	</span><br><span class="line">	# 声明局部变量i，默认值为0</span><br><span class="line">	DECLARE i INT DEFAULT 0;  </span><br><span class="line">	SET i = FLOOR(from_num +RAND()*(to_num -from_num+1))   ;</span><br><span class="line">	RETURN i;  </span><br><span class="line"></span><br><span class="line">END$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>  调用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 生成 1~10 之间的随机整数</span><br><span class="line">SELECT rand_num(1, 10);</span><br></pre></td></tr></table></figure>





<p>**rand_num_seed(from_num INT ,to_num INT,seed LONG)**：生成 <code>from_num ~ to_num</code> 之间的随机整数，可以指定随机数种子。</p>
<ul>
<li>  声明存储函数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line">USE `gmall`$$</span><br><span class="line"></span><br><span class="line">DROP FUNCTION IF EXISTS `rand_num_seed`$$</span><br><span class="line"></span><br><span class="line">CREATE DEFINER=`root`@`localhost` FUNCTION `rand_num_seed`(from_num INT ,to_num INT,seed LONG ) RETURNS INT(11)</span><br><span class="line">BEGIN   </span><br><span class="line"> DECLARE i INT DEFAULT 0;  </span><br><span class="line"> SET i = FLOOR(from_num +RAND(seed+UNIX_TIMESTAMP(NOW()))*(to_num -from_num+1))   ;</span><br><span class="line">RETURN i;  </span><br><span class="line"> END$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>  调用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT rand_num_seed(1, 10, 3);</span><br></pre></td></tr></table></figure>





<p>**rand_nums( from_num INT, to_num INT, n INT, delemit VARCHAR(20) )**：在<code>from_num ~ to_num</code> 区间内生成 n 个随机整数，每个数之间用 delemit 分隔。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line">USE `gmall`$$</span><br><span class="line"></span><br><span class="line">DROP FUNCTION IF EXISTS `rand_nums`$$</span><br><span class="line"></span><br><span class="line">CREATE DEFINER=`root`@`localhost` FUNCTION `rand_nums`(from_num INT ,to_num INT,n INT ,delemit VARCHAR(20)) RETURNS VARCHAR(255) CHARSET utf8</span><br><span class="line">BEGIN   </span><br><span class="line"> DECLARE i INT DEFAULT 0;  </span><br><span class="line"> DECLARE v INT DEFAULT 0;</span><br><span class="line"> DECLARE return_str VARCHAR(255) DEFAULT &#x27;&#x27;;  </span><br><span class="line"> WHILE i &lt; n DO </span><br><span class="line">	 SET v = rand_num (from_num   ,to_num  ) ;</span><br><span class="line">	 SET return_str=CONCAT(return_str,v);</span><br><span class="line">	 IF LENGTH(return_str)&gt;0 THEN </span><br><span class="line">	   SET return_str=CONCAT(return_str,delemit) ;</span><br><span class="line">	 END IF;</span><br><span class="line">	 SET i = i + 1;</span><br><span class="line">END WHILE;</span><br><span class="line"> RETURN return_str;</span><br><span class="line">END$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>  调用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 生成 9~99 之间的 5 个整数，每个数之间以 “，” 分隔</span><br><span class="line">SELECT rand_nums(9, 99, 5, &quot;，&quot;);</span><br></pre></td></tr></table></figure>



<p>**rand_string(n INT)**：创建 n 个字符长度的随机字符串</p>
<ul>
<li>  声明存储函数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line">USE `gmall`$$</span><br><span class="line"></span><br><span class="line">DROP FUNCTION IF EXISTS `rand_string`$$</span><br><span class="line"></span><br><span class="line">CREATE DEFINER=`root`@`localhost` FUNCTION `rand_string`(n INT) RETURNS VARCHAR(255) CHARSET utf8</span><br><span class="line">BEGIN    </span><br><span class="line">DECLARE chars_str VARCHAR(100) DEFAULT &#x27;abcdefghijklmnopqrstuvwxyzABCDEFJHIJKLMNOPQRSTUVWXYZ&#x27;;</span><br><span class="line"> DECLARE return_str VARCHAR(255) DEFAULT &#x27;&#x27;;</span><br><span class="line"> DECLARE i INT DEFAULT 0;</span><br><span class="line"> WHILE i &lt; n DO  </span><br><span class="line"> SET return_str =CONCAT(return_str,SUBSTRING(chars_str,FLOOR(1+RAND()*52),1));  </span><br><span class="line"> SET i = i + 1;</span><br><span class="line"> END WHILE;</span><br><span class="line"> RETURN return_str;</span><br><span class="line">END$$</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>  调用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 创建5个长度的随机字符串</span><br><span class="line">SELECT rand_string(5);</span><br></pre></td></tr></table></figure>





<h2 id="存储过程"><a href="#存储过程" class="headerlink" title="存储过程"></a>存储过程</h2><p><strong>insert_order( create_time_string VARCHAR(200), max_num INT, user_num INT, sku_num INT )</strong></p>
<p>作用：向 order_info 表中插入数据</p>
<p>参数：</p>
<ul>
<li>  <code>create_time_string VARCHAR(200)</code>：创建时间，以字符串的形式传入</li>
<li>  <code>max_num INT</code>：循环结束的条件</li>
<li>  <code>user_num INT</code>：一共有多少个用户</li>
<li>  <code>sku_num INT</code>：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line"></span><br><span class="line">USE `gmall`$$</span><br><span class="line">DROP PROCEDURE IF EXISTS `insert_order`$$</span><br><span class="line">CREATE DEFINER=`root`@`localhost` PROCEDURE `insert_order`( create_time_string VARCHAR(200), max_num INT, user_num INT, sku_num INT  )</span><br><span class="line">BEGIN</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 声明局部变量</span><br><span class="line">DECLARE v_create_time DATETIME DEFAULT NULL; # 创建时间（必有值）</span><br><span class="line">DECLARE i INT DEFAULT 0;</span><br><span class="line">DECLARE v_order_status INT DEFAULT 0; # 订单状态（1或2） </span><br><span class="line">DECLARE v_operate_time DATETIME DEFAULT NULL; # 操作时间（有值或为NULL）</span><br><span class="line">DECLARE v_order_id INT DEFAULT NULL; # 订单id</span><br><span class="line">DECLARE v_order_detail_num INT DEFAULT NULL; # 订单详情 </span><br><span class="line">DECLARE j INT DEFAULT 0;</span><br><span class="line">SET autocommit = 0; # 开启主键自增策略</span><br><span class="line"></span><br><span class="line"># 循环开始</span><br><span class="line">REPEAT</span><br><span class="line">	SET i = i + 1;  </span><br><span class="line">	SET v_create_time=DATE_ADD(DATE_FORMAT(create_time_string, &#x27;%Y-%m-%d&#x27;), INTERVAL rand_num(30,3600*23) SECOND);</span><br><span class="line">	SET v_order_status=rand_num(1,2); </span><br><span class="line"></span><br><span class="line">	IF v_order_status&gt;1 THEN </span><br><span class="line">		SET v_operate_time= DATE_ADD(v_create_time ,INTERVAL rand_num(30,3600) SECOND);</span><br><span class="line">	ELSE</span><br><span class="line">		SET v_operate_time=NULL;</span><br><span class="line">	END IF;</span><br><span class="line">	</span><br><span class="line">	# 向 order_info 表中插入一条数据（order_info表的主键id是自动生成的，无需手动插入）    	</span><br><span class="line">	INSERT INTO order_info </span><br><span class="line">		(consignee,</span><br><span class="line">		 consignee_tel,</span><br><span class="line">	 	 total_amount ,</span><br><span class="line">	 	 order_status ,</span><br><span class="line">	 	 user_id,</span><br><span class="line">	 	 payment_way,</span><br><span class="line">	 	 delivery_address,</span><br><span class="line">	 	 order_comment,</span><br><span class="line">	 	 out_trade_no,</span><br><span class="line">	 	 trade_body,</span><br><span class="line">	 	 create_time,</span><br><span class="line">	 	 operate_time,</span><br><span class="line">	 	 expire_time, </span><br><span class="line">	 	 tracking_no,</span><br><span class="line">	 	 parent_order_id, </span><br><span class="line">	 	 img_url) </span><br><span class="line">	VALUES (rand_string(6), # 收货人</span><br><span class="line">		CONCAT(&#x27;13&#x27;,rand_nums(0,9,9,&#x27;&#x27;)), # 收货人电话</span><br><span class="line">		CAST(rand_num(50,1000) AS DECIMAL(10,2)), # 总金额</span><br><span class="line">		v_order_status, # 订单状态</span><br><span class="line">		rand_num(1,user_num), # 用户id</span><br><span class="line">		rand_num(1,2), # 付款方式</span><br><span class="line">		rand_string(20), # 送货地址</span><br><span class="line">		rand_string(20), # 订单备注</span><br><span class="line">		rand_nums(0,9,10,&#x27;&#x27;), # 订单交易编号</span><br><span class="line">		&#x27;&#x27;, # 订单描述</span><br><span class="line">		v_create_time,  # 创建时间</span><br><span class="line">		v_operate_time,	# 操作时间</span><br><span class="line">		NULL,	# 失效时间</span><br><span class="line">		NULL,	# 物流单编号</span><br><span class="line">		NULL,	# 父订单编号</span><br><span class="line">		NULL    # 图片路径</span><br><span class="line">		);</span><br><span class="line">	</span><br><span class="line">	# SELECT  LAST_INSERT_ID() 的作用是得到刚 insert 进去记录的主键值</span><br><span class="line">	SELECT  LAST_INSERT_ID() INTO v_order_id ;</span><br><span class="line">	# 设置订单详情中的购买个数</span><br><span class="line">	SET v_order_detail_num=rand_num(1,5);</span><br><span class="line">	# 每购买一次，就会生成一条订单详情数据 </span><br><span class="line">	WHILE j &lt; v_order_detail_num DO</span><br><span class="line">		SET j=j+1;</span><br><span class="line">		# 向 order_detail 表插入数据</span><br><span class="line">		INSERT INTO order_detail</span><br><span class="line">		(order_id, sku_id, sku_name ,img_url ,order_price, sku_num ) </span><br><span class="line">		VALUES </span><br><span class="line">		(v_order_id , rand_num(1,sku_num), rand_string(10), CONCAT(&#x27;http://&#x27;,rand_string(40)) ,CAST(rand_num(20,5000) AS DECIMAL(10,2)), rand_num(1,5)  ); </span><br><span class="line">	END WHILE;</span><br><span class="line">	</span><br><span class="line">	SET j=0;</span><br><span class="line"></span><br><span class="line"># 循环结束。结束条件：i = max_num</span><br><span class="line">UNTIL i = max_num</span><br><span class="line">	END REPEAT;  </span><br><span class="line"></span><br><span class="line"># 提交所有操作</span><br><span class="line">COMMIT;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">END$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>



<p><strong>验证OK！调用：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CALL insert_order(&quot;2019-02-10&quot;, 100, 100, 100);</span><br></pre></td></tr></table></figure>







<p><strong>init_data( do_date_string VARCHAR(20) ,order_incr_num INT,user_incr_num INT ,sku_num INT ,if_truncate BOOLEAN  )</strong></p>
<ul>
<li>  <code>do_date_string</code>：</li>
<li>  <code>order_incr_num</code></li>
<li>  <code>user_incr_num</code>：</li>
<li>  <code>sku_num</code>：向 sku 表中插入数据的条数</li>
<li>  <code>if_truncate</code>：插入数据前是否删除已存在的数据</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line">USE `gmall`$$</span><br><span class="line">DROP PROCEDURE IF EXISTS `init_data`$$</span><br><span class="line">CREATE DEFINER=`root`@`localhost` PROCEDURE `init_data`( do_date_string VARCHAR(20) ,order_incr_num INT,user_incr_num INT ,sku_num INT ,if_truncate BOOLEAN  )</span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">	# 声明局部变量</span><br><span class="line">     DECLARE user_count INT DEFAULT 0; </span><br><span class="line">     DECLARE sku_count INT DEFAULT 0; </span><br><span class="line">     DECLARE do_date VARCHAR(20) DEFAULT do_date_string;</span><br><span class="line">     </span><br><span class="line">     # 是否清空原始数据</span><br><span class="line">     IF if_truncate  THEN </span><br><span class="line">        TRUNCATE TABLE order_info ;</span><br><span class="line">        TRUNCATE TABLE order_detail ;</span><br><span class="line">        TRUNCATE TABLE sku_info ;</span><br><span class="line">        TRUNCATE TABLE user_info ;</span><br><span class="line">     END IF ;</span><br><span class="line">     </span><br><span class="line">     # 调用存储过程 insert_sku</span><br><span class="line">     CALL insert_sku(do_date, sku_num);</span><br><span class="line">     # 为变量 sku_count 赋值</span><br><span class="line">     SELECT COUNT(*) INTO sku_count FROM  sku_info;</span><br><span class="line">     </span><br><span class="line">     # 调用存储过程 insert_user</span><br><span class="line">     CALL insert_user(do_date,user_incr_num );</span><br><span class="line">     # 为变量 user_count 赋值</span><br><span class="line">     SELECT COUNT(*) INTO user_count FROM  user_info;</span><br><span class="line">     </span><br><span class="line">     # 调用存储过程 update_order</span><br><span class="line">     CALL update_order(do_date);</span><br><span class="line">     # 调用存储过程 insert_order</span><br><span class="line">     CALL insert_order(do_date,order_incr_num,user_count,sku_count);</span><br><span class="line">     # 调用存储过程 insert_payment</span><br><span class="line">     CALL insert_payment(do_date);</span><br><span class="line">END$$</span><br><span class="line"></span><br><span class="line">DELIMITER ; </span><br></pre></td></tr></table></figure>





<table>
<thead>
<tr>
<th></th>
<th></th>
</tr>
</thead>
<tbody><tr>
<td><code>DATE_ADD(d，INTERVAL expr type)</code></td>
<td>计算起始日期 d 加上一个时间段后的日期，type 值可以是</td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
</tr>
</tbody></table>
<p><strong>insert_user( create_time_string VARCHAR(200), max_num INT)</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $$</span><br><span class="line">USE `gmall`$$</span><br><span class="line">DROP PROCEDURE IF EXISTS `insert_user`$$</span><br><span class="line">CREATE DEFINER=`root`@`localhost` PROCEDURE `insert_user`( create_time_string VARCHAR(200),max_num INT  )</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BEGIN</span><br><span class="line">	# 声明局部变量</span><br><span class="line">	DECLARE v_create_time DATETIME DEFAULT NULL;</span><br><span class="line"> 	DECLARE i INT DEFAULT 0;</span><br><span class="line"> 	DECLARE v_birthday DATE DEFAULT NULL;</span><br><span class="line"> 	DECLARE v_gender VARCHAR(1) DEFAULT NULL;</span><br><span class="line"> 	# 设置主键自增</span><br><span class="line">	SET autocommit = 0;    </span><br><span class="line"> 	</span><br><span class="line"> 	# 循环Start</span><br><span class="line">	REPEAT</span><br><span class="line">		SET i  = i + 1;  </span><br><span class="line">		SET v_create_time=DATE_ADD(DATE_FORMAT(create_time_string,&#x27;%Y-%m-%d&#x27;), INTERVAL rand_num(1,3600*24) SECOND);</span><br><span class="line">		SET v_birthday=DATE_ADD(DATE_FORMAT(&#x27;1950-01-01&#x27;,&#x27;%Y-%m-%d&#x27;) ,INTERVAL rand_num(1,365*50) DAY); </span><br><span class="line">		SET v_gender=IF(rand_num(0,1)=0,&#x27;M&#x27;,&#x27;F&#x27;);</span><br><span class="line"> 		</span><br><span class="line"> 		# 插入数据</span><br><span class="line"> 		INSERT INTO user_info (login_name,nick_name,passwd,NAME,phone_num,email,head_img,user_level,birthday,gender,create_time  ) </span><br><span class="line">		VALUES (rand_string(20) ,rand_string(20) , CONCAT(&#x27;pwd&#x27;,rand_string(20)), rand_string(30), CONCAT(&#x27;13&#x27;,rand_nums(0,9,9,&#x27;&#x27;))    ,CONCAT(rand_string(8),&#x27;@&#x27;,rand_string(3),&#x27;.com&#x27;) ,  CONCAT(&#x27;http://&#x27;,rand_string(40)), rand_num(1,5),v_birthday,v_gender,v_create_time    ); </span><br><span class="line"> </span><br><span class="line">	# 循环结束</span><br><span class="line">	UNTIL i = max_num  </span><br><span class="line"> 		END REPEAT;  </span><br><span class="line"> 	</span><br><span class="line"> 	# 提交</span><br><span class="line">	COMMIT;  </span><br><span class="line"></span><br><span class="line">END$$</span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/18/MySQL-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E4%B8%8E%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/18/MySQL-%E5%AD%98%E5%82%A8%E8%BF%87%E7%A8%8B%E4%B8%8E%E5%AD%98%E5%82%A8%E5%87%BD%E6%95%B0/" class="post-title-link" itemprop="url">MySQL_存储过程与存储函数</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-18 11:22:05" itemprop="dateCreated datePublished" datetime="2022-01-18T11:22:05+08:00">2022-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-04-06 10:43:46" itemprop="dateModified" datetime="2022-04-06T10:43:46+08:00">2022-04-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySql/" itemprop="url" rel="index"><span itemprop="name">MySql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <p>MySQL 从 5.0 版本开始支持存储过程和存储函数。存储过程和函数能够将复杂的 SQL 逻辑封装在一起，应用程序无须关注存储过程和函数内部复杂的 SQL 逻辑，只需要简单地调用存储过程和函数即可。</p>
<h1 id="1-存储过程概述"><a href="#1-存储过程概述" class="headerlink" title="1    存储过程概述"></a>1    存储过程概述</h1><h2 id="1-1-理解"><a href="#1-1-理解" class="headerlink" title="1.1    理解"></a>1.1    理解</h2><p><strong>含义：</strong>存储过程的英文是 <code>Stored Procedure</code> 。它的思想很简单，就是一组经过 <code>预先编译</code> 的 SQL 语句的封装。</p>
<p><strong>执行过程：</strong>存储过程预先存储在 MySQL 服务器上，需要执行的时候，客户端只需要向服务器端发出调用存储过程的命令，服务器端就可以把预先存储好的这一系列 SQL 语句全部执行。</p>
<p><strong>好处：</strong></p>
<ol>
<li> 简化操作，提高了 SQL 语句的重用性，减少了开发程序员的压力</li>
<li> 减少操作过程中的失误，提高效率</li>
<li> 减少网络传输量（客户端不需要把所有的 SQL 语句通过网络发给服务器） </li>
<li> 减少了 SQL 语句暴露在网上的风险，也提高了数据查询的安全性</li>
</ol>
<p><strong>和视图、函数的对比</strong>：</p>
<p>它和视图有着同样的优点，清晰、安全，还可以减少网络传输量。不过它和视图不同，视图是<code>虚拟表</code>，通常不对底层数据表执行写操作，而存储过程是程序化的 SQL，可以<code>直接操作底层数据表</code>，相比于面向集合的操作方式，能够实现一些更复杂的数据处理。</p>
<p>一旦存储过程被创建出来，使用它就像使用函数一样简单，我们直接通过调用存储过程名即可。相较于函数，存储过程是<code>没有返回值</code>的，而函数必须有返回值。</p>
<hr>
<h2 id="1-2-分类"><a href="#1-2-分类" class="headerlink" title="1.2    分类"></a>1.2    分类</h2><p>存储过程的形参的修饰符可以是 <code>IN</code>、<code>OUT</code> 和 <code>INOUT</code>。根据这点分类如下：</p>
<ol>
<li> 没有参数（无参数无返回） </li>
<li> 仅仅带 IN 类型（有参数无返回） </li>
<li> 仅仅带 OUT 类型（无参数有返回） </li>
<li> 既带 IN 又带 OUT（有参数有返回） </li>
<li> 带 INOUT（有参数有返回）</li>
</ol>
<p>注意：IN、OUT、INOUT 都可以在一个存储过程中带多个。</p>
<p>【存储过程没有返回值指的是没有 <code>return</code> 语句，但是可以在参数列表中声明一个 OUT 修饰的变量接收函数体的计算结果，这不叫返回值，而是可以理解为一个全局变量】</p>
<hr>
<h1 id="2-创建存储过程"><a href="#2-创建存储过程" class="headerlink" title="2    创建存储过程"></a>2    创建存储过程</h1><h2 id="2-1-语法分析"><a href="#2-1-语法分析" class="headerlink" title="2.1    语法分析"></a>2.1    语法分析</h2><p><strong>语法：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE PROCEDURE 存储过程名(IN|OUT|INOUT 参数名 参数类型,...)</span><br><span class="line">[characteristics ...]</span><br><span class="line">BEGIN</span><br><span class="line">	存储过程体</span><br><span class="line">END 结束标志符</span><br></pre></td></tr></table></figure>

<p>类似于 Java 中的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">修饰符 返回类型 方法名(参数类型 参数名,...)&#123;</span><br><span class="line">    方法体;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>说明：</strong></p>
<ol>
<li><p>参数前面的符号的意思</p>
<ul>
<li><p>  <code>IN</code>：当前参数为输入参数，也就是表示入参。存储过程只是读取这个参数的值。如果没有定义参数种类，<code>默认就是 IN</code> ，表示输入参数。</p>
</li>
<li><p><code>OUT</code>：当前参数为输出参数，也就是表示出参；执行完成之后，调用这个存储过程的客户端或者应用程序就可以读取这个参数返回的值了。</p>
</li>
<li><p><code>INOUT</code>：当前参数既可以为输入参数，也可以为输出参数。</p>
</li>
</ul>
</li>
<li><p> 形参类型可以是 MySQL 数据库中的任意类型。</p>
</li>
<li><p><code>characteristics</code> 表示创建存储过程时指定的对存储过程的约束条件，其取值信息如下：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">LANGUAGE SQL</span><br><span class="line">| [NOT] DETERMINISTIC</span><br><span class="line">| &#123; CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA &#125;</span><br><span class="line">| SQL SECURITY &#123; DEFINER | INVOKER &#125;</span><br><span class="line">| COMMENT &#x27;string&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>  <code>LANGUAGE SQL</code>：说明存储过程执行体是由SQL语句组成的，当前系统支持的语言为SQL。</li>
<li>  <code>[NOT] DETERMINISTIC</code>：指明存储过程执行的结果是否确定。DETERMINISTIC 表示结果是确定的。每次执行存储过程时，相同的输入会得到相同的输出。NOT DETERMINISTIC 表示结果是不确定的，相同的输入可能得到不同的输出。如果没有指定任意一个值，默认为 NOT DETERMINISTIC。</li>
<li><code>&#123; CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA &#125;</code> ：指明子程序使用SQL语句的限制。<ul>
<li>  CONTAINS SQL 表示当前存储过程的子程序包含SQL语句，但是并不包含读写数据的SQL语句；</li>
<li>  NO SQL 表示当前存储过程的子程序中不包含任何SQL语句；</li>
<li>  READS SQL DATA 表示当前存储过程的子程序中包含读数据的SQL语句；</li>
<li>  MODIFIES SQL DATA 表示当前存储过程的子程序中包含写数据的SQL语句。</li>
<li>  默认情况下，系统会指定为 CONTAINS SQL。</li>
</ul>
</li>
<li><code>SQL SECURITY &#123; DEFINER | INVOKER &#125;</code> ：执行当前存储过程的权限，即指明哪些用户能够执行当前存储过程。<ul>
<li>  DEFINER 表示只有当前存储过程的创建者或者定义者才能执行当前存储过程；</li>
<li>  INVOKER 表示拥有当前存储过程的访问权限的用户能够执行当前存储过程。</li>
<li>  如果没有设置相关的值，则 MySQL 默认指定值为 DEFINER。</li>
</ul>
</li>
<li>  <code>COMMENT &#39;string&#39;</code> ：注释信息，可以用来描述存储过程。</li>
</ul>
</li>
<li><p>存储过程体中可以有多条 SQL 语句，如果仅有一条SQL 语句，则可以省略 BEGIN 和 END。</p>
<p> 编写存储过程并不是一件简单的事情，可能存储过程中需要复杂的 SQL 语句。</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">1. BEGIN…END：BEGIN…END 中间包含了多个语句，每条语句都以（;）号为结束符。</span><br><span class="line">2. DECLARE：DECLARE 用来声明变量，使用的位置在于 BEGIN…END 语句中间，而且需要在其他语句使用之前进行变量的声明。</span><br><span class="line">3. SET：赋值语句，用于对变量进行赋值。</span><br><span class="line">4. SELECT… INTO：把从数据表中查询的结果存放到变量中，也就是为变量赋值。</span><br></pre></td></tr></table></figure></li>
<li><p>设置新的结束标记</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER 新的结束标记</span><br></pre></td></tr></table></figure>

<p> 因为 MySQL 默认的语句结束符号为分号 <code>;</code> 。为了避免与存储过程中 SQL 语句结束符相冲突，需要使用 DELIMITER 改变存储过程的结束符。</p>
<p> 比如，<code>“DELIMITER //”</code> 语句的作用是将存储过程的结束符设置为 <code>//</code> ，并以 <code>“END //”</code> 结束存储过程。存储过程定义完毕之后再使用 <code>“DELIMITER ;”</code> 恢复默认结束符。DELIMITER 也可以指定其他符号作为结束符。</p>
<p> 当使用 DELIMITER 命令时，应该避免使用反斜杠（‘\’）字符，因为反斜线是 MySQL 的转义字符。</p>
<ul>
<li>  示例：</li>
</ul>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-- 指定新的结束符为 $ ，这样当存储过程执行到 ; 时就不会判定为程序结束了</span><br><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE 存储过程名(IN|OUT|INOUT 参数名 参数类型,...)</span><br><span class="line">[characteristics ...]</span><br><span class="line">BEGIN</span><br><span class="line">	sql语句1;</span><br><span class="line">	sql语句2;</span><br><span class="line"></span><br><span class="line">END $</span><br></pre></td></tr></table></figure>

</li>
</ol>
<hr>
<h2 id="2-2-代码举例"><a href="#2-2-代码举例" class="headerlink" title="2.2 代码举例"></a>2.2 代码举例</h2><p>举例1：创建存储过程 select_all_data()，查看 employees 表的所有数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"># 设置结束标记为 $</span><br><span class="line">DELIMITER $	</span><br><span class="line"># 存储过程真正的内容</span><br><span class="line">CREATE PROCEDURE select_all_data()</span><br><span class="line">BEGIN	</span><br><span class="line">    SELECT * FROM employees;</span><br><span class="line">END $ </span><br><span class="line"># 重置结束标记为 ;</span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"># 存储过程调用</span><br><span class="line">CALL `select_all_data`</span><br></pre></td></tr></table></figure>

<p>举例2：创建存储过程 avg_employee_salary()，返回所有员工的平均工资</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line">CREATE PROCEDURE avg_employee_salary()</span><br><span class="line">BEGIN	</span><br><span class="line">    SELECT AVG(salary) AS avg_salary FROM employees;</span><br><span class="line">END $ </span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CALL avg_employee_salary</span><br></pre></td></tr></table></figure>

<p>举例3：创建存储过程 show_max_salary()，用来查看 employees 表的最高薪资值。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE show_max_salary()</span><br><span class="line">BEGIN	</span><br><span class="line">    SELECT MAX(salary) AS max_salary FROM employees;</span><br><span class="line">END $ </span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">CALL `show_max_salary`</span><br></pre></td></tr></table></figure>

<p>举例4：创建存储过程 show_min_salary()，查看 employees 表的最低薪资值。并将最低薪资通过 OUT 参数 “ms” 输出</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE show_min_salary(OUT ms DOUBLE)</span><br><span class="line">BEGIN	</span><br><span class="line">    # 把查询到的结果写入到变量 ms 中</span><br><span class="line">    SELECT MIN(salary) INTO ms </span><br><span class="line">    FROM employees;</span><br><span class="line">END $ </span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>  存储过程调用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 调用存储过程，并传入 OUT 参数 ms</span><br><span class="line">CALL show_min_salary(@ms);</span><br><span class="line"># 查询变量 ms 的值</span><br><span class="line">SELECT @ms;</span><br></pre></td></tr></table></figure>



<p>举例5：创建存储过程 show_someone_salary()，查看 employees 表的某个员工的薪资，并用 IN 参数 empname 输入员工姓名。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE show_someone_salary(IN empname VARCHAR(20))</span><br><span class="line">BEGIN	</span><br><span class="line">    SELECT salary FROM employees WHERE first_name=empname;</span><br><span class="line">END $ </span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>  存储过程调用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 调用方式1</span><br><span class="line">CALL show_someone_salary(&quot;Bruce&quot;)</span><br><span class="line"></span><br><span class="line"># 调用方式2</span><br><span class="line">set @empname = &quot;Bruce&quot;</span><br><span class="line">CALL show_someone_salary(@empname)</span><br></pre></td></tr></table></figure>



<p>举例6：创建存储过程 show_someone_salary2()，查看 employees 表的某个员工的薪资，并用 IN 参数 empname 输入员工姓名，用 OUT 参数 empsalary 输出员工薪资。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line">CREATE PROCEDURE show_someone_salary2(IN empname VARCHAR(20), OUT empsalary DOUBLE)</span><br><span class="line">BEGIN	</span><br><span class="line">    SELECT salary INTO empsalary </span><br><span class="line">    FROM employees </span><br><span class="line">    WHERE first_name=empname;</span><br><span class="line">END $ </span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>  存储过程调用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 调用存储过程，传入两个参数</span><br><span class="line">CALL show_someone_salary2(&quot;Bruce&quot;, @empsalary);</span><br><span class="line"># 查询变量的值</span><br><span class="line">SELECT @empsalary; </span><br></pre></td></tr></table></figure>



<p>举例7：创建存储过程 show_mgr_name()，查询某个员工领导的姓名，并用 INOUT 参数 “empname” 输入员工姓名，输出领导的姓名。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE PROCEDURE show_mgr_name( INOUT empname VARCHAR(20) )</span><br><span class="line">BEGIN	</span><br><span class="line">    SELECT first_name INTO empname</span><br><span class="line">    FROM employees</span><br><span class="line">    WHERE employee_id = ( SELECT manager_id FROM employees WHERE first_name = empname );</span><br><span class="line">END $ </span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>  存储过程调用</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"># 为 empname 变量赋初值</span><br><span class="line">SET @empname = &quot;Neena&quot;;</span><br><span class="line"># 调用存储过程，传入一个参数</span><br><span class="line">CALL show_mgr_name(@empname);</span><br><span class="line"># 查询 empname 变量输出的值</span><br><span class="line">SELECT @empname;</span><br></pre></td></tr></table></figure>





<hr>
<h1 id="3-调用存储过程"><a href="#3-调用存储过程" class="headerlink" title="3 调用存储过程"></a>3 调用存储过程</h1><h2 id="3-1-调用格式"><a href="#3-1-调用格式" class="headerlink" title="3.1 调用格式"></a>3.1 调用格式</h2><p>存储过程必须使用 <code>CALL</code> 语句调用，并且存储过程和数据库相关，如果要执行其它数据库中的存储过程，需要指定数据库名称，例如 <code>CALL dbname.procname</code>。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CALL 存储过程名(实参列表)</span><br></pre></td></tr></table></figure>

<p><strong>格式：</strong></p>
<ol>
<li><p>调用 in 模式的参数：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CALL sp1(&#x27;值&#x27;);</span><br></pre></td></tr></table></figure></li>
<li><p>调用 out 模式的参数：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SET @name;</span><br><span class="line">CALL sp1(@name);</span><br><span class="line">SELECT @name;</span><br></pre></td></tr></table></figure></li>
<li><p>调用 inout 模式的参数：</p>
 <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">SET @name=值;</span><br><span class="line">CALL sp1(@name);</span><br><span class="line">SELECT @name;</span><br></pre></td></tr></table></figure></li>
</ol>
<hr>
<h2 id="3-2-代码举例"><a href="#3-2-代码举例" class="headerlink" title="3.2    代码举例"></a>3.2    代码举例</h2><p>举例1：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>调用存储过程：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>查看返回结果：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>该存储过程返回了指定 s_id=101 的水果商提供的水果种类，返回值存储在num变量中，使用SELECT查看，返回结果为3。</p>
<p>举例2：创建存储过程，实现累加运算，计算 1+2+…+n 等于多少。具体的代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>如果你用的是 Navicat 工具，那么在编写存储过程的时候，Navicat 会自动设置 DELIMITER 为其他符号，我们不需要再进行 DELIMITER 的操作。</p>
<p>直接使用 CALL add_num(50); 即可。这里我传入的参数为 50，也就是统计 1+2+…+50 的积累之和。</p>
<h2 id="3-3-如何调试"><a href="#3-3-如何调试" class="headerlink" title="3.3    如何调试"></a>3.3    如何调试</h2><p>在 MySQL 中，存储过程不像普通的编程语言（比如 VC++、Java 等）那样有专门的集成开发环境。因此，你可以通过 SELECT 语句，把程序执行的中间结果查询出来，来调试一个 SQL 语句的正确性。调试成功之后，把 SELECT 语句后移到下一个 SQL 语句之后，再调试下一个 SQL 语句。这样逐步推进，就可以完成对存储过程中所有操作的调试了。当然，你也可以把存储过程中的 SQL 语句复制出来，逐段单独调试。</p>
<hr>
<h1 id="4-存储函数的使用"><a href="#4-存储函数的使用" class="headerlink" title="4    存储函数的使用"></a>4    存储函数的使用</h1><p>前面学习了很多函数，使用这些函数可以对数据进行的各种处理操作，极大地提高用户对数据库的管理效率。MySQL 支持自定义函数，定义好之后，调用方式与调用 MySQL 预定义的系统函数一样。</p>
<h2 id="4-1-语法分析"><a href="#4-1-语法分析" class="headerlink" title="4.1 语法分析"></a>4.1 语法分析</h2><p><strong>语法格式：</strong></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE FUNCTION 函数名(参数名 参数类型, ...)</span><br><span class="line">RETURNS 返回值类型</span><br><span class="line">[characteristics ...]</span><br><span class="line">BEGIN</span><br><span class="line">	函数体 # 函数体中肯定有 RETURN 语句</span><br><span class="line">	</span><br><span class="line">END</span><br></pre></td></tr></table></figure>

<p><strong>说明：</strong></p>
<ol>
<li><p> 参数列表：指定参数为 IN、OUT 或 INOUT 只对 PROCEDURE 是合法的，FUNCTION 中总是默认为 IN 参数。</p>
</li>
<li><p><code>RETURNS type</code> 语句表示函数返回数据的类型；</p>
<p> RETURNS 子句只能对 FUNCTION 做指定，对函数而言这是<code>强制</code>的。它用来指定函数的返回类型，而且函数体必须包含一个 <code>RETURN value</code> 语句。</p>
</li>
<li><p> <code>characteristic</code> 创建函数时指定的对函数的约束。取值与创建存储过程时相同，这里不再赘述。</p>
</li>
<li><p> 函数体也可以用 BEGIN…END 来表示 SQL 代码的开始和结束。如果函数体只有一条语句，也可以省略 BEGIN…END 。</p>
</li>
</ol>
<hr>
<h2 id="4-2-调用存储函数"><a href="#4-2-调用存储函数" class="headerlink" title="4.2 调用存储函数"></a>4.2 调用存储函数</h2><p>在 MySQL 中，存储函数的使用方法与 MySQL 内部函数的使用方法是一样的。换言之，用户自己定义的存储函数与 MySQL 内部函数是一个性质的。区别在于，存储函数是用户自己定义的，而内部函数是 MySQL 的开发者定义的。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT 函数名(实参列表)</span><br></pre></td></tr></table></figure>



<p>​    </p>
<hr>
<h2 id="4-3-代码举例"><a href="#4-3-代码举例" class="headerlink" title="4.3    代码举例"></a>4.3    代码举例</h2><p><strong>举例1：</strong>创建存储函数，名称为 email_by_name() ，参数定义为空，该函数查询 Abel 的 email ，并返回，数据类型为字符串型。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE FUNCTION email_by_name()</span><br><span class="line">RETURNS VARCHAR(25)</span><br><span class="line">	DETERMINISTIC</span><br><span class="line">	CONTAINS SQL</span><br><span class="line">	READS SQL DATA</span><br><span class="line">BEGIN</span><br><span class="line">    RETURN( SELECT email FROM employees WHERE last_name = &#x27;Abel&#x27; );</span><br><span class="line">END $ </span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>调用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SELECT email_by_name();</span><br></pre></td></tr></table></figure>



<p><strong>举例2：</strong>创建存储函数，名称为 email_by_id() ，参数传入 emp_id ，该函数查询 emp_id 的 email 并返回，数据类型为字符串型。</p>
<ul>
<li>  在创建函数前，关闭约束校验</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET GLOBAL log_bin_trust_function_creators = 1;</span><br></pre></td></tr></table></figure>

<ul>
<li>  创建存储函数</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE FUNCTION email_by_id( emp_id INT(6) )</span><br><span class="line">RETURNS VARCHAR(25)</span><br><span class="line">BEGIN</span><br><span class="line">    RETURN( SELECT email FROM employees WHERE employee_id = emp_id );</span><br><span class="line">END $ </span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<ul>
<li>  调用：</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET @emp_id = 102;</span><br><span class="line">SELECT email_by_id(102);</span><br></pre></td></tr></table></figure>



<p><strong>举例3：</strong>创建存储函数 count_by_id() ，参数传入 dept_id ，该函数查询 dept_id 部门的员工人数，并返回，数据类型为整型。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">DELIMITER $</span><br><span class="line"></span><br><span class="line">CREATE FUNCTION count_by_id(dept_id INT)</span><br><span class="line">RETURNS INT</span><br><span class="line">	LANGUAGE SQL</span><br><span class="line">	NOT DETERMINISTIC</span><br><span class="line">	READS SQL DATA</span><br><span class="line">	SQL SECURITY DEFINER</span><br><span class="line">	COMMENT &#x27;查询部门员工人数&#x27;</span><br><span class="line">BEGIN</span><br><span class="line">	RETURN (SELECT COUNT(*) FROM employees WHERE department_id = dept_id);</span><br><span class="line">END $</span><br><span class="line"></span><br><span class="line">DELIMITER ;</span><br></pre></td></tr></table></figure>

<p>调用：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SET @dept_id = 50;</span><br><span class="line">SELECT count_by_id(@dept_id);</span><br></pre></td></tr></table></figure>

<p><strong>注意：</strong></p>
<p>若在创建存储函数中报错 <strong>“you might want to use the less safe log_bin_trust_function_creators variable ”</strong>，有两种处理方法：</p>
<ul>
<li><p>  方式1：加上必要的函数特性 [NOT] DETERMINISTIC 和 {CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA}</p>
</li>
<li><p>方式2：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SET GLOBAL log_bin_trust_function_creators = 1;</span><br></pre></td></tr></table></figure></li>
</ul>
<hr>
<h2 id="4-4-对比存储函数和存储过程"><a href="#4-4-对比存储函数和存储过程" class="headerlink" title="4.4    对比存储函数和存储过程"></a>4.4    对比存储函数和存储过程</h2><table>
<thead>
<tr>
<th></th>
<th>关键字</th>
<th>调用语法</th>
<th>返回值</th>
<th>应用场景</th>
</tr>
</thead>
<tbody><tr>
<td>存储过程</td>
<td>PROCEDURE</td>
<td>CALL 存储过程()</td>
<td>理解为有0个或多个</td>
<td>一般用于更新</td>
</tr>
<tr>
<td>存储函数</td>
<td>FUNCTION</td>
<td>SELECT 函数()</td>
<td>只能是一个</td>
<td>一般用于查询结果为一个值并返回时</td>
</tr>
</tbody></table>
<p>此外，<strong>存储函数可以放在查询语句中使用，存储过程不行</strong>。反之，存储过程的功能更加强大，包括能够执行对表的操作（比如创建表，删除表等）和事务操作，这些功能是存储函数不具备的。</p>
<hr>
<h1 id="5-存储过程和存储函数的查看、修改、删除"><a href="#5-存储过程和存储函数的查看、修改、删除" class="headerlink" title="5 存储过程和存储函数的查看、修改、删除"></a>5 存储过程和存储函数的查看、修改、删除</h1><h2 id="5-1-查看"><a href="#5-1-查看" class="headerlink" title="5.1 查看"></a>5.1 查看</h2><p>创建完之后，怎么知道我们创建的存储过程、存储函数是否成功了呢？</p>
<p>MySQL 存储了存储过程和存储函数的状态信息，用户可以使用 <code>SHOW STATUS</code> 语句或 <code>SHOW CREATE</code> 语句来查看，也可直接从系统的 <code>information_schema</code> 数据库中查询。这里介绍 3 种方法。</p>
<ol>
<li><strong>使用 <code>SHOW CREATE</code> 语句查看存储过程和函数的创建信息</strong></li>
</ol>
<p>  基本语法结构如下：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW CREATE &#123;PROCEDURE | FUNCTION&#125; 存储过程名或函数名</span><br></pre></td></tr></table></figure>

<p>  举例：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW CREATE FUNCTION test_db.CountProc \G</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><strong>使用 <code>SHOW STATUS</code> 语句查看存储过程和函数的状态信息</strong></li>
</ol>
<p>基本语法结构如下：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW &#123;PROCEDURE | FUNCTION&#125; STATUS [LIKE &#x27;pattern&#x27;]</span><br></pre></td></tr></table></figure>

<p>这个语句返回子程序的特征，如数据库、名字、类型、创建者及创建和修改日期。</p>
<p>[LIKE ‘pattern’]：匹配存储过程或函数的名称，可以省略。当省略不写时，会列出MySQL数据库中存在的所有存储过程或函数的信息。 举例：SHOW STATUS语句示例，代码如下：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SHOW PROCEDURE STATUS LIKE &#x27;SELECT%&#x27; \G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">Db: test_db</span><br><span class="line">Name: SelectAllData</span><br><span class="line">Type: PROCEDURE</span><br><span class="line">Definer: root@localhost</span><br><span class="line">Modified: 2021-10-16 15:55:07</span><br><span class="line">Created: 2021-10-16 15:55:07</span><br><span class="line">Security_type: DEFINER</span><br><span class="line">Comment:</span><br><span class="line">character_set_client: utf8mb4</span><br><span class="line">collation_connection: utf8mb4_general_ci</span><br><span class="line">Database Collation: utf8mb4_general_ci</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<ol start="3">
<li><strong>从 <code>information_schema.Routines</code> 表中查看存储过程和函数的信息</strong></li>
</ol>
<p>MySQL 中存储过程和函数的信息存储在 <code>information_schema</code> 数据库下的 <code>Routines</code> 表中。可以通过查询该表的记录来查询存储过程和函数的信息。其基本语法形式如下：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM information_schema.Routines</span><br><span class="line">WHERE ROUTINE_NAME=&#x27;存储过程或函数的名&#x27; [AND ROUTINE_TYPE = &#123;&#x27;PROCEDURE|FUNCTION&#x27;&#125;];</span><br></pre></td></tr></table></figure>

<p>说明：如果在 MySQL 数据库中存在存储过程和函数名称相同的情况，最好指定 ROUTINE_TYPE 查询条件来指明查询的是存储过程还是函数。</p>
<p>举例：从 Routines 表中查询名称为 CountProc 的存储函数的信息，代码如下：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT * FROM information_schema.Routines</span><br><span class="line">WHERE ROUTINE_NAME=&#x27;count_by_id&#x27;　AND　ROUTINE_TYPE = &#x27;FUNCTION&#x27; \G</span><br></pre></td></tr></table></figure>



<hr>
<h2 id="5-2-修改"><a href="#5-2-修改" class="headerlink" title="5.2 修改"></a>5.2 修改</h2><p>修改存储过程或函数，不影响存储过程或函数功能（即不能修改函数体），只能修改相关特性。使用 <code>ALTER</code> 语句实现。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ALTER &#123;PROCEDURE | FUNCTION&#125; 存储过程或函数的名 [characteristic ...]</span><br></pre></td></tr></table></figure>

<p>其中， <code>characteristic</code> 指定存储过程或函数的特性，其取值信息与创建存储过程、函数时的取值信息略有不同。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&#123; CONTAINS SQL | NO SQL | READS SQL DATA | MODIFIES SQL DATA &#125;</span><br><span class="line">| SQL SECURITY &#123; DEFINER | INVOKER &#125;</span><br><span class="line">| COMMENT &#x27;string&#x27;</span><br></pre></td></tr></table></figure>

<ul>
<li>  <code>CONTAINS SQL</code> ，表示子程序包含 SQL 语句，但不包含读或写数据的语句。</li>
<li>  <code>NO SQL</code> ，表示子程序中不包含SQL语句。</li>
<li>  <code>READS SQL DATA</code> ，表示子程序中包含读数据的语句。</li>
<li>  <code>MODIFIES SQL DATA</code> ，表示子程序中包含写数据的语句。</li>
<li><code>SQL SECURITY &#123; DEFINER | INVOKER &#125;</code> ，指明谁有权限来执行。<ul>
<li>  <code>DEFINER</code> ，表示只有定义者自己才能够执行。</li>
<li>  <code>INVOKER</code> ，表示调用者可以执行。</li>
</ul>
</li>
<li>  <code>COMMENT &#39;string&#39;</code> ，表示注释信息。</li>
</ul>
<blockquote>
<p>  修改存储过程使用ALTER PROCEDURE语句，修改存储函数使用ALTER FUNCTION语句。但是，这两个语句的结构是一样的，语句中的所有参数也是一样的。</p>
</blockquote>
<p><strong>举例1：</strong></p>
<p>修改存储过程 CountProc 的定义。将读写权限改为 MODIFIES SQL DATA，并指明调用者可以执行，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>



<p>查询修改后的信息：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>结果显示，存储过程修改成功。从查询的结果可以看出，访问数据的权限（SQL_DATA_ ACCESS）已经变成 MODIFIES SQL DATA ，安全类型（SECURITY_TYPE）已经变成 INVOKER。</p>
<p><strong>举例2：</strong></p>
<p>修改存储函数 CountProc 的定义。将读写权限改为 READS SQL DATA，并加上注释信息 “FIND NAME”，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>存储函数修改成功。从查询的结果可以看出，访问数据的权限（SQL_DATA_ACCESS）已经变成READS SQL DATA，函数注释（ROUTINE_COMMENT）已经变成FIND NAME。</p>
<hr>
<h2 id="5-3-删除"><a href="#5-3-删除" class="headerlink" title="5.3 删除"></a>5.3 删除</h2><p>删除存储过程和函数，可以使用 DROP 语句，其语法结构如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>

<p>IF EXISTS：如果程序或函数不存储，它可以防止发生错误，产生一个用 SHOW WARNINGS 查看的警告。</p>
<p>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>





<hr>
<h1 id="6-关于存储过程和存储函数使用的争议"><a href="#6-关于存储过程和存储函数使用的争议" class="headerlink" title="6 关于存储过程和存储函数使用的争议"></a>6 关于存储过程和存储函数使用的争议</h1><p>尽管存储过程有诸多优点，但是对于存储过程的使用，一直都存在着很多争议，比如有些公司对于大型项目要求使用存储过程，而有些公司在手册中明确禁止使用存储过程，为什么这些公司对存储过程的使用需求差别这么大呢？</p>
<h2 id="6-1-优点"><a href="#6-1-优点" class="headerlink" title="6.1    优点"></a>6.1    优点</h2><ol>
<li> <strong>存储过程可以一次编译多次使用。</strong>存储过程只在创建时进行编译，之后的使用都不需要重新编译，这就提升了 SQL 的执行效率。</li>
<li> <strong>可以减少开发工作量。</strong>将代码封装成模块，实际上是编程的核心思想之一，这样可以把复杂的问题拆解成不同的模块，然后模块之间可以重复使用，在减少开发工作量的同时，还能保证代码的结构清晰。</li>
<li> <strong>存储过程的安全性强。</strong>我们在设定存储过程的时候可以设置对用户的使用权限，这样就和视图一样具有较强的安全性。</li>
<li> <strong>可以减少网络传输量。</strong>因为代码封装到存储过程中，每次使用只需要调用存储过程即可，这样就减少了网络传输量。</li>
<li><strong>良好的封装性。</strong>在进行相对复杂的数据库操作时，原本需要使用一条一条的 SQL 语句，可能要连接多次数据库才能完成的操作，现在变成了一次存储过程，只需要连接一次即可。</li>
</ol>
<h2 id="6-2-缺点"><a href="#6-2-缺点" class="headerlink" title="6.2 缺点"></a>6.2 缺点</h2><p>基于上面这些优点，不少大公司都要求大型项目使用存储过程，比如微软、IBM 等公司。但是国内的阿里并不推荐开发人员使用存储过程，这是为什么呢？</p>
<blockquote>
<h3 id="阿里开发规范"><a href="#阿里开发规范" class="headerlink" title="阿里开发规范"></a>阿里开发规范</h3><p>  【强制】禁止使用存储过程，存储过程难以调试和扩展，更没有移植性。</p>
</blockquote>
<p>存储过程虽然有诸如上面的好处，但缺点也是很明显的。</p>
<ol>
<li> 可移植性差。存储过程不能跨数据库移植，比如在 MySQL、Oracle 和 SQL Server 里编写的存储过程，在换成其他数据库时都需要重新编写。</li>
<li> 调试困难。只有少数 DBMS 支持存储过程的调试。对于复杂的存储过程来说，开发和维护都不容易。虽然也有一些第三方工具可以对存储过程进行调试，但要收费。</li>
<li> 存储过程的版本管理很困难。比如数据表索引发生变化了，可能会导致存储过程失效。我们在开发软件的时候往往需要进行版本管理，但是存储过程本身没有版本控制，版本迭代更新的时候很麻烦。</li>
<li> 它不适合高并发的场景。高并发的场景需要减少数据库的压力，有时数据库会采用分库分表的方式，而且对可扩展性要求很高，在这种情况下，存储过程会变得难以维护， 增加数据库的压力，显然就不适用了。</li>
</ol>
<p>小结：</p>
<p>存储过程既方便，又有局限性。尽管不同的公司对存储过程的态度不一，但是对于我们开发人员来说，不论怎样，掌握存储过程都是必备的技能之一。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




    


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/01/18/MySQL-%E8%A7%86%E5%9B%BE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="post" itemscope itemtype="http://schema.org/CreativeWork">
      <meta itemprop="name" content="undefined | Hexo">
      <meta itemprop="description" content="">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          <a href="/2022/01/18/MySQL-%E8%A7%86%E5%9B%BE/" class="post-title-link" itemprop="url">MySQL_视图</a>
        </h2>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>

      <time title="Created: 2022-01-18 10:32:40" itemprop="dateCreated datePublished" datetime="2022-01-18T10:32:40+08:00">2022-01-18</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar-check"></i>
      </span>
      <span class="post-meta-item-text">Edited on</span>
      <time title="Modified: 2022-04-06 18:51:48" itemprop="dateModified" datetime="2022-04-06T18:51:48+08:00">2022-04-06</time>
    </span>
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-folder"></i>
      </span>
      <span class="post-meta-item-text">In</span>
        <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
          <a href="/categories/MySql/" itemprop="url" rel="index"><span itemprop="name">MySql</span></a>
        </span>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
          <h1 id="1-常见的数据库对象"><a href="#1-常见的数据库对象" class="headerlink" title="1 常见的数据库对象"></a>1 常见的数据库对象</h1><table>
<thead>
<tr>
<th>对象</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>表(TABLE)</td>
<td>表是存储数据的逻辑单元，以行和列的形式存在，列就是字段，行就是记录</td>
</tr>
<tr>
<td>数据字典</td>
<td>数据字典是一种特殊的表，就是系统表，存放数据库系统的相关信息。<br>系统表的数据通常由数据库系统维护，程序员通常不应该修改，只可查看。</td>
</tr>
<tr>
<td>约束(CONSTRAINT)</td>
<td>执行数据校验的规则，用于保证数据完整性的规则</td>
</tr>
<tr>
<td>视图(VIEW)</td>
<td>一个或者多个数据表里的数据的逻辑显示，视图并不存储数据</td>
</tr>
<tr>
<td>索引(INDEX)</td>
<td>用于提高查询性能，相当于书的目录</td>
</tr>
<tr>
<td>存储过程(PROCEDURE)</td>
<td>用于完成一次完整的业务处理，没有返回值，但可通过传出参数将多个值传给调用环境</td>
</tr>
<tr>
<td>存储函数(FUNCTION)</td>
<td>用于完成一次特定的计算，具有一个返回值</td>
</tr>
<tr>
<td>触发器(TRIGGER)</td>
<td>相当于一个事件监听器，当数据库发生特定事件后，触发器被触发，完成相应的处理</td>
</tr>
</tbody></table>
<hr>
<h1 id="2-视图概述"><a href="#2-视图概述" class="headerlink" title="2    视图概述"></a>2    视图概述</h1><p><img src="/2022/01/18/MySQL-%E8%A7%86%E5%9B%BE/image-20220118103844198.png" alt="image-20220118103844198"></p>
<h2 id="2-1-为什么使用视图？"><a href="#2-1-为什么使用视图？" class="headerlink" title="2.1 为什么使用视图？"></a>2.1 为什么使用视图？</h2><p>一方面视图可以帮我们使用表的一部分而不是表的所有内容，另一方面也可以针对不同的用户制定不同的查询视图。</p>
<p>比如，针对一个公司的销售人员，我们只想给他看部分数据，而某些特殊的数据，比如采购的价格，则不会提供给他。再比如，人员薪酬是个敏感的字段，那么只给某个级别以上的人员开放，其他人的查询视图中则不提供这个字段。</p>
<p>刚才讲的只是视图的一个使用场景，实际上视图还有很多作用。最后，我们总结视图的优点。</p>
<h2 id="2-2-视图的理解"><a href="#2-2-视图的理解" class="headerlink" title="2.2 视图的理解"></a>2.2 视图的理解</h2><p>视图是一种虚拟表，本身是不具有数据的，占用很少的内存空间，它是 SQL 中的一个重要概念。</p>
<p>视图建立在已有表的基础上，视图赖以建立的这些表称为<strong>基表</strong>。</p>
<img src="/2022/01/18/MySQL-%E8%A7%86%E5%9B%BE/image-20220118104111453.png" alt="image-20220118104111453" style="zoom: 50%;">

<ul>
<li>  <strong>视图</strong>的创建和删除只影响视图本身，不影响对应的基表。但是当对<strong>视图中的数据</strong>进行增加、删除和修改操作时，基表中的数据会相应地发生变化，反之亦然。</li>
<li>向视图提供数据内容的语句为 SELECT 语句, 可以将视图理解为存储起来的 SELECT 语句。<ul>
<li>  在数据库中，视图不会保存数据，数据真正保存在数据表中。当对视图中的数据进行增加、删除和修改操作时，数据表中的数据会相应地发生变化；反之亦然。</li>
</ul>
</li>
<li>  视图，是向用户提供基表数据的另一种表现形式。通常情况下，小型项目的数据库可以不使用视图，但是在大型项目中，以及数据表比较复杂的情况下，视图的价值就凸显出来了，它可以帮助我们把经常查询的结果集放到虚拟表中，提升使用效率。理解和使用起来都非常方便。</li>
</ul>
<hr>
<h1 id="3-创建视图"><a href="#3-创建视图" class="headerlink" title="3 创建视图"></a>3 创建视图</h1><ul>
<li>  在 CREATE VIEW 语句中嵌入子查询</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE [OR REPLACE]</span><br><span class="line">[ALGORITHM = &#123;UNDEFINED | MERGE | TEMPTABLE&#125;]</span><br><span class="line">VIEW 视图名称 [(字段列表)]</span><br><span class="line">AS 查询语句</span><br><span class="line">[WITH [CASCADED|LOCAL] CHECK OPTION]</span><br></pre></td></tr></table></figure>

<ul>
<li>  精简版</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW 视图名称</span><br><span class="line">AS 查询语句</span><br></pre></td></tr></table></figure>



<hr>
<h2 id="3-1-创建单表视图"><a href="#3-1-创建单表视图" class="headerlink" title="3.1 创建单表视图"></a>3.1 创建单表视图</h2><p>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW empvu80</span><br><span class="line">AS</span><br><span class="line">SELECT employee_id, last_name, salary</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id = 80;</span><br></pre></td></tr></table></figure>

<p>查询视图：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">SELECT *</span><br><span class="line">FROM salvu80;</span><br></pre></td></tr></table></figure>

<img src="/2022/01/18/MySQL-%E8%A7%86%E5%9B%BE/image-20220118104806070.png" alt="image-20220118104806070" style="zoom: 67%;">





<p>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW emp_year_salary (ename,year_salary)</span><br><span class="line">AS</span><br><span class="line">SELECT ename, salary*12*(1+IFNULL(commission_pct,0))</span><br><span class="line">FROM t_employee;</span><br></pre></td></tr></table></figure>



<p>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW salvu50</span><br><span class="line">AS</span><br><span class="line">SELECT employee_id ID_NUMBER, last_name NAME,salary*12 ANN_SALARY</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id = 50;</span><br></pre></td></tr></table></figure>

<p>说明1：实际上就是我们在 SQL 查询语句的基础上封装了视图 VIEW，这样就会基于 SQL 语句的结果集形成一张虚拟表。</p>
<p>说明2：在创建视图时，如果没有在视图名后面指定字段列表，则视图中字段列表默认和SELECT语句中的字段列表一致。如果SELECT语句中给字段取了别名，那么视图中的字段名和别名相同。</p>
<hr>
<h2 id="3-2-创建多表联合视图"><a href="#3-2-创建多表联合视图" class="headerlink" title="3.2 创建多表联合视图"></a>3.2 创建多表联合视图</h2><p>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW empview</span><br><span class="line">AS</span><br><span class="line">SELECT employee_id emp_id,last_name NAME,department_name</span><br><span class="line">FROM employees e,departments d</span><br><span class="line">WHERE e.department_id = d.department_id;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW emp_dept</span><br><span class="line">AS</span><br><span class="line">SELECT ename,dname</span><br><span class="line">FROM t_employee LEFT JOIN t_department</span><br><span class="line">ON t_employee.did = t_department.did;</span><br></pre></td></tr></table></figure>



<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW dept_sum_vu</span><br><span class="line">(name, minsal, maxsal, avgsal)</span><br><span class="line">AS</span><br><span class="line">SELECT d.department_name, MIN(e.salary), MAX(e.salary),AVG(e.salary)</span><br><span class="line">FROM employees e, departments d</span><br><span class="line">WHERE e.department_id = d.department_id</span><br><span class="line">GROUP BY d.department_name;</span><br></pre></td></tr></table></figure>



<ul>
<li>  利用视图对数据进行格式化</li>
</ul>
<p>我们经常需要输出某个格式的内容，比如我们想输出员工姓名和对应的部门名，对应格式为：<code>emp_name(department_name)</code>，就可以使用视图来完成数据格式化的操作：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW emp_depart</span><br><span class="line">AS</span><br><span class="line">SELECT CONCAT(last_name,&#x27;(&#x27;,department_name,&#x27;)&#x27;) AS emp_dept</span><br><span class="line">FROM employees e JOIN departments d</span><br><span class="line">WHERE e.department_id = d.department_id</span><br></pre></td></tr></table></figure>



<hr>
<h2 id="3-3-基于视图创建视图"><a href="#3-3-基于视图创建视图" class="headerlink" title="3.3 基于视图创建视图"></a>3.3 基于视图创建视图</h2><p>当我们创建好一张视图之后，还可以在它的基础上继续创建视图。</p>
<p>举例：联合“emp_dept”视图和“emp_year_salary”视图查询员工姓名、部门名称、年薪信息创建 “emp_dept_ysalary”视图。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">CREATE VIEW emp_dept_ysalary</span><br><span class="line">AS</span><br><span class="line">SELECT emp_dept.ename,dname,year_salary</span><br><span class="line">FROM emp_dept INNER JOIN emp_year_salary</span><br><span class="line">ON emp_dept.ename = emp_year_salary.ename;</span><br></pre></td></tr></table></figure>



<hr>
<h1 id="4-查看视图"><a href="#4-查看视图" class="headerlink" title="4 查看视图"></a>4 查看视图</h1><p>语法1：查看数据库的表对象、视图对象</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW TABLES;</span><br></pre></td></tr></table></figure>

<p>语法2：查看视图的结构</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DESC / DESCRIBE 视图名称;</span><br></pre></td></tr></table></figure>



<p>语法3：查看视图的属性信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"># 查看视图信息（显示数据表的存储引擎、版本、数据行数和数据大小等）</span><br><span class="line">SHOW TABLE STATUS LIKE &#x27;视图名称&#x27;\G</span><br></pre></td></tr></table></figure>

<p>执行结果显示，注释Comment为VIEW，说明该表为视图，其他的信息为NULL，说明这是一个虚表。</p>
<p>语法4：查看视图的详细定义信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SHOW CREATE VIEW 视图名称;</span><br></pre></td></tr></table></figure>





<hr>
<h1 id="5-更新视图的数据"><a href="#5-更新视图的数据" class="headerlink" title="5 更新视图的数据"></a>5 更新视图的数据</h1><h2 id="5-1-一般情况"><a href="#5-1-一般情况" class="headerlink" title="5.1 一般情况"></a>5.1 一般情况</h2><p>MySQL 支持使用 INSERT、UPDATE 和 DELETE 语句对视图中的数据进行插入、更新和删除操作。当视图中的数据发生变化时，数据表中的数据也会发生变化，反之亦然。</p>
<p>举例：UPDATE操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT ename,tel FROM emp_tel WHERE ename = &#x27;孙洪亮&#x27;;</span><br><span class="line">+---------+-------------+</span><br><span class="line">| ename | tel |</span><br><span class="line">+---------+-------------+</span><br><span class="line">| 孙洪亮 | 13789098765 |</span><br><span class="line">+---------+-------------+</span><br><span class="line">1 row in set (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; UPDATE emp_tel SET tel = &#x27;13789091234&#x27; WHERE ename = &#x27;孙洪亮&#x27;;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line">Rows matched: 1 Changed: 1 Warnings: 0</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT ename,tel FROM emp_tel WHERE ename = &#x27;孙洪亮&#x27;;</span><br><span class="line">+---------+-------------+</span><br><span class="line">| ename | tel |</span><br><span class="line">+---------+-------------+</span><br><span class="line">| 孙洪亮 | 13789091234 |</span><br><span class="line">+---------+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT ename,tel FROM t_employee WHERE ename = &#x27;孙洪亮&#x27;;</span><br><span class="line">+---------+-------------+</span><br><span class="line">| ename | tel |</span><br><span class="line">+---------+-------------+</span><br><span class="line">| 孙洪亮 | 13789091234 |</span><br><span class="line">+---------+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br></pre></td></tr></table></figure>

<p>举例：DELETE操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; SELECT ename,tel FROM emp_tel WHERE ename = &#x27;孙洪亮&#x27;;</span><br><span class="line">+---------+-------------+</span><br><span class="line">| ename | tel |</span><br><span class="line">+---------+-------------+</span><br><span class="line">| 孙洪亮 | 13789091234 |</span><br><span class="line">+---------+-------------+</span><br><span class="line">1 row in set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; DELETE FROM emp_tel WHERE ename = &#x27;孙洪亮&#x27;;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT ename,tel FROM emp_tel WHERE ename = &#x27;孙洪亮&#x27;;</span><br><span class="line">Empty set (0.00 sec)</span><br><span class="line"></span><br><span class="line">mysql&gt; SELECT ename,tel FROM t_employee WHERE ename = &#x27;孙洪亮&#x27;;</span><br><span class="line">Empty set (0.00 sec)</span><br></pre></td></tr></table></figure>



<h2 id="5-2-不可更新的视图"><a href="#5-2-不可更新的视图" class="headerlink" title="5.2 不可更新的视图"></a>5.2 不可更新的视图</h2><p>要使视图可更新，视图中的行和底层基本表中的行之间必须存在一对一的关系。另外当视图定义出现如下情况时，视图不支持更新操作：</p>
<ul>
<li>  在定义视图的时候指定了“ALGORITHM = TEMPTABLE”，视图将不支持INSERT和DELETE操作；</li>
<li>  视图中不包含基表中所有被定义为非空又未指定默认值的列，视图将不支持INSERT操作；</li>
<li>  在定义视图的SELECT语句中使用了JOIN联合查询，视图将不支持INSERT和DELETE操作；</li>
<li>  在定义视图的SELECT语句后的字段列表中使用了数学表达式或子查询，视图将不支持INSERT，也不支持UPDATE使用了数学表达式、子查询的字段值；</li>
<li>  在定义视图的SELECT语句后的字段列表中使用DISTINCT 、聚合函数、GROUP BY 、HAVING 、UNION 等，视图将不支持INSERT、UPDATE、DELETE；</li>
<li>  在定义视图的SELECT语句中包含了子查询，而子查询中引用了FROM后面的表，视图将不支持INSERT、UPDATE、DELETE；</li>
<li>  视图定义基于一个不可更新视图；</li>
<li>  常量视图。</li>
</ul>
<p>举例：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; CREATE OR REPLACE VIEW emp_dept</span><br><span class="line">-&gt; (ename,salary,birthday,tel,email,hiredate,dname)</span><br><span class="line">-&gt; AS SELECT ename,salary,birthday,tel,email,hiredate,dname</span><br><span class="line">-&gt; FROM t_employee INNER JOIN t_department</span><br><span class="line">-&gt; ON t_employee.did = t_department.did ;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">mysql&gt; INSERT INTO emp_dept(ename,salary,birthday,tel,email,hiredate,dname)</span><br><span class="line">-&gt; VALUES(&#x27;张三&#x27;,15000,&#x27;1995-01-08&#x27;,&#x27;18201587896&#x27;,</span><br><span class="line">-&gt; &#x27;zs@atguigu.com&#x27;,&#x27;2022-02-14&#x27;,&#x27;新部门&#x27;);</span><br><span class="line">#ERROR 1393 (HY000): Can not modify more than one base table through a join view</span><br><span class="line">&#x27;atguigu_chapter9.emp_dept&#x27;</span><br></pre></td></tr></table></figure>

<p>从上面的SQL执行结果可以看出，在定义视图的SELECT语句中使用了JOIN联合查询，视图将不支持更新操作。</p>
<blockquote>
<p>  虽然可以更新视图数据，但总的来说，视图作为虚拟表，主要用于方便查询，不建议更新视图的数据。对视图数据的更改，都是通过对实际数据表里数据的操作来完成的。</p>
</blockquote>
<hr>
<h1 id="6-修改、删除视图"><a href="#6-修改、删除视图" class="headerlink" title="6 修改、删除视图"></a>6 修改、删除视图</h1><h2 id="6-1-修改视图"><a href="#6-1-修改视图" class="headerlink" title="6.1 修改视图"></a>6.1 修改视图</h2><p>方式1：使用 CREATE OR REPLACE VIEW 子句修改视图</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">CREATE OR REPLACE VIEW empvu80</span><br><span class="line">(id_number, name, sal, department_id)</span><br><span class="line">AS</span><br><span class="line">SELECT employee_id, first_name || &#x27; &#x27; || last_name, salary, department_id</span><br><span class="line">FROM employees</span><br><span class="line">WHERE department_id = 80;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>  说明：CREATE VIEW 子句中各列的别名应和子查询中各列相对应。</p>
</blockquote>
<p>方式2：ALTER VIEW</p>
<p>修改视图的语法是：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ALTER VIEW 视图名称</span><br><span class="line">AS</span><br><span class="line">查询语句</span><br></pre></td></tr></table></figure>



<hr>
<h2 id="6-2-删除视图"><a href="#6-2-删除视图" class="headerlink" title="6.2 删除视图"></a>6.2 删除视图</h2><ul>
<li><p>  删除视图只是删除视图的定义，并不会删除基表的数据。</p>
</li>
<li><p>删除视图的语法是：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">DROP VIEW IF EXISTS 视图名称;</span><br><span class="line"></span><br><span class="line">DROP VIEW IF EXISTS 视图名称1,视图名称2,视图名称3,...;</span><br></pre></td></tr></table></figure></li>
<li><p>举例：</p>
  <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">DROP VIEW empvu80;</span><br></pre></td></tr></table></figure></li>
<li><p>  说明：基于视图a、b创建了新的视图c，如果将视图a或者视图b删除，会导致视图c的查询失败。这样的视图c需要手动删除或修改，否则影响使用。</p>
</li>
</ul>
<hr>
<h1 id="7-总结"><a href="#7-总结" class="headerlink" title="7    总结"></a>7    总结</h1><h2 id="7-1-视图优点"><a href="#7-1-视图优点" class="headerlink" title="7.1    视图优点"></a>7.1    视图优点</h2><ol>
<li><p>操作简单</p>
<p> 将经常使用的查询操作定义为视图，可以使开发人员不需要关心视图对应的数据表的结构、表与表之间的关联关系，也不需要关心数据表之间的业务逻辑和查询条件，而只需要简单地操作视图即可，极大简化了开发人员对数据库的操作。</p>
</li>
<li><p>减少数据冗余<br> <u>视图跟实际数据表不一样，它存储的是查询语句</u>。所以，在使用的时候，我们要通过定义视图的查询语句来获取结果集。而视图本身不存储数据，不占用数据存储的资源，减少了数据冗余。</p>
</li>
<li><p>数据安全<br> MySQL将用户对数据的访问限制在某些数据的结果集上，而这些数据的结果集可以使用视图来实现。用户不必直接查询或操作数据表。这也可以理解为视图具有隔离性。视图相当于在用户和实际的数据表之间加了一层虚拟表。</p>
</li>
</ol>
<p>  <img src="/2022/01/18/MySQL-%E8%A7%86%E5%9B%BE/image-20220118111505592.png" alt="image-20220118111505592"></p>
<p>  同时，MySQL可以根据权限将用户对数据的访问限制在某些视图上，用户不需要查询数据表，可以直接通过视图获取数据表中的信息。这在一定程度上保障了数据表中数据的安全性。</p>
<ol start="4">
<li><p>适应灵活多变的需求 当业务系统的需求发生变化后，如果需要改动数据表的结构，则工作量相对较大，可以使用视图来减少改动的工作量。这种方式在实际工作中使用得比较多。</p>
</li>
<li><p>能够分解复杂的查询逻辑 数据库中如果存在复杂的查询逻辑，则可以将问题进行分解，创建多个视图获取数据，再将创建的多个视图结合起来，完成复杂的查询逻辑。</p>
</li>
</ol>
<h2 id="7-2-视图不足"><a href="#7-2-视图不足" class="headerlink" title="7.2 视图不足"></a>7.2 视图不足</h2><p>如果我们在实际数据表的基础上创建了视图，那么，如果实际数据表的结构变更了，我们就需要及时对相关的视图进行相应的维护。特别是嵌套的视图（就是在视图的基础上创建视图），维护会变得比较复杂， 可读性不好，容易变成系统的潜在隐患。因为创建视图的 SQL  查询可能会对字段重命名，也可能包含复杂的逻辑，这些都会增加维护的成本。</p>
<p>实际项目中，如果视图过多，会导致数据库维护成本的问题。</p>
<p>所以，在创建视图的时候，你要结合实际项目需求，综合考虑视图的优点和不足，这样才能正确使用视图，使系统整体达到最优。</p>

      
    </div>

    
    
    

    <footer class="post-footer">
        <div class="post-eof"></div>
      
    </footer>
  </article>
</div>




  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/4/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><span class="page-number current">5</span><a class="page-number" href="/page/6/">6</a><span class="space">&hellip;</span><a class="page-number" href="/page/24/">24</a><a class="extend next" rel="next" href="/page/6/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>

</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2022</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/muse/" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdnjs.cloudflare.com/ajax/libs/animejs/3.2.1/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/comments.js"></script><script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/schemes/muse.js"></script><script src="/js/next-boot.js"></script>

  





  





</body>
</html>
